define(["exports","three.mjs","three.mjs"],(function(t,e,n){"use strict";class i extends e.Raycaster{constructor(){super()}}const s=new e.Vector3;function r(t,n,i,r){const o=new e.Mesh(t,n);return o.renderOrder=1,o.onBeforeRender=()=>{let t=i.camera.getProjectionCompensatingScale(o.getWorldPosition(s).distanceTo(i.camera.position));r&&(t=r(t)),o.scale.set(t,t,t),o.updateMatrixWorld(!0)},o}class o{}o.zero=Object.freeze(new e.Vector3(0,0,0)),o.one=Object.freeze(new e.Vector3(1,1,1)),o.up=Object.freeze(new e.Vector3(0,0,1)),o.down=Object.freeze(new e.Vector3(0,0,-1)),o.forward=Object.freeze(new e.Vector3(0,1,0)),o.back=Object.freeze(new e.Vector3(0,-1,0)),o.right=Object.freeze(new e.Vector3(1,0,0)),o.left=Object.freeze(new e.Vector3(-1,0,0));
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
var a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function c(t,e){function n(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function h(t){return"function"==typeof t}var l=!1,u={Promise:void 0,set useDeprecatedSynchronousErrorHandling(t){t&&(new Error).stack;l=t},get useDeprecatedSynchronousErrorHandling(){return l}};function p(t){setTimeout((function(){throw t}),0)}var d={closed:!0,next:function(t){},error:function(t){if(u.useDeprecatedSynchronousErrorHandling)throw t;p(t)},complete:function(){}},f=function(){return Array.isArray||function(t){return t&&"number"==typeof t.length}}();function b(t){return null!==t&&"object"==typeof t}var m=function(){function t(t){return Error.call(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(t,e){return e+1+") "+t.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t,this}return t.prototype=Object.create(Error.prototype),t}(),y=function(){function t(t){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,t&&(this._ctorUnsubscribe=!0,this._unsubscribe=t)}return t.prototype.unsubscribe=function(){var e;if(!this.closed){var n=this._parentOrParents,i=this._ctorUnsubscribe,s=this._unsubscribe,r=this._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,n instanceof t)n.remove(this);else if(null!==n)for(var o=0;o<n.length;++o){n[o].remove(this)}if(h(s)){i&&(this._unsubscribe=void 0);try{s.call(this)}catch(t){e=t instanceof m?v(t.errors):[t]}}if(f(r)){o=-1;for(var a=r.length;++o<a;){var c=r[o];if(b(c))try{c.unsubscribe()}catch(t){e=e||[],t instanceof m?e=e.concat(v(t.errors)):e.push(t)}}}if(e)throw new m(e)}},t.prototype.add=function(e){var n=e;if(!e)return t.EMPTY;switch(typeof e){case"function":n=new t(e);case"object":if(n===this||n.closed||"function"!=typeof n.unsubscribe)return n;if(this.closed)return n.unsubscribe(),n;if(!(n instanceof t)){var i=n;(n=new t)._subscriptions=[i]}break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}var s=n._parentOrParents;if(null===s)n._parentOrParents=this;else if(s instanceof t){if(s===this)return n;n._parentOrParents=[s,this]}else{if(-1!==s.indexOf(this))return n;s.push(this)}var r=this._subscriptions;return null===r?this._subscriptions=[n]:r.push(n),n},t.prototype.remove=function(t){var e=this._subscriptions;if(e){var n=e.indexOf(t);-1!==n&&e.splice(n,1)}},t.EMPTY=function(t){return t.closed=!0,t}(new t),t}();function v(t){return t.reduce((function(t,e){return t.concat(e instanceof m?e.errors:e)}),[])}var w=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),g=function(t){function e(n,i,s){var r=t.call(this)||this;switch(r.syncErrorValue=null,r.syncErrorThrown=!1,r.syncErrorThrowable=!1,r.isStopped=!1,arguments.length){case 0:r.destination=d;break;case 1:if(!n){r.destination=d;break}if("object"==typeof n){n instanceof e?(r.syncErrorThrowable=n.syncErrorThrowable,r.destination=n,n.add(r)):(r.syncErrorThrowable=!0,r.destination=new S(r,n));break}default:r.syncErrorThrowable=!0,r.destination=new S(r,n,i,s)}return r}return c(e,t),e.prototype[w]=function(){return this},e.create=function(t,n,i){var s=new e(t,n,i);return s.syncErrorThrowable=!1,s},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this))},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){this.destination.error(t),this.unsubscribe()},e.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},e.prototype._unsubscribeAndRecycle=function(){var t=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=t,this},e}(y),S=function(t){function e(e,n,i,s){var r,o=t.call(this)||this;o._parentSubscriber=e;var a=o;return h(n)?r=n:n&&(r=n.next,i=n.error,s=n.complete,n!==d&&(h((a=Object.create(n)).unsubscribe)&&o.add(a.unsubscribe.bind(a)),a.unsubscribe=o.unsubscribe.bind(o))),o._context=a,o._next=r,o._error=i,o._complete=s,o}return c(e,t),e.prototype.next=function(t){if(!this.isStopped&&this._next){var e=this._parentSubscriber;u.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?this.__tryOrSetError(e,this._next,t)&&this.unsubscribe():this.__tryOrUnsub(this._next,t)}},e.prototype.error=function(t){if(!this.isStopped){var e=this._parentSubscriber,n=u.useDeprecatedSynchronousErrorHandling;if(this._error)n&&e.syncErrorThrowable?(this.__tryOrSetError(e,this._error,t),this.unsubscribe()):(this.__tryOrUnsub(this._error,t),this.unsubscribe());else if(e.syncErrorThrowable)n?(e.syncErrorValue=t,e.syncErrorThrown=!0):p(t),this.unsubscribe();else{if(this.unsubscribe(),n)throw t;p(t)}}},e.prototype.complete=function(){var t=this;if(!this.isStopped){var e=this._parentSubscriber;if(this._complete){var n=function(){return t._complete.call(t._context)};u.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?(this.__tryOrSetError(e,n),this.unsubscribe()):(this.__tryOrUnsub(n),this.unsubscribe())}else this.unsubscribe()}},e.prototype.__tryOrUnsub=function(t,e){try{t.call(this._context,e)}catch(t){if(this.unsubscribe(),u.useDeprecatedSynchronousErrorHandling)throw t;p(t)}},e.prototype.__tryOrSetError=function(t,e,n){if(!u.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{e.call(this._context,n)}catch(e){return u.useDeprecatedSynchronousErrorHandling?(t.syncErrorValue=e,t.syncErrorThrown=!0,!0):(p(e),!0)}return!1},e.prototype._unsubscribe=function(){var t=this._parentSubscriber;this._context=null,this._parentSubscriber=null,t.unsubscribe()},e}(g);var M=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function _(t){return t}function x(t){return 0===t.length?_:1===t.length?t[0]:function(e){return t.reduce((function(t,e){return e(t)}),e)}}var P=function(){function t(t){this._isScalar=!1,t&&(this._subscribe=t)}return t.prototype.lift=function(e){var n=new t;return n.source=this,n.operator=e,n},t.prototype.subscribe=function(t,e,n){var i=this.operator,s=function(t,e,n){if(t){if(t instanceof g)return t;if(t[w])return t[w]()}return t||e||n?new g(t,e,n):new g(d)}(t,e,n);if(i?s.add(i.call(s,this.source)):s.add(this.source||u.useDeprecatedSynchronousErrorHandling&&!s.syncErrorThrowable?this._subscribe(s):this._trySubscribe(s)),u.useDeprecatedSynchronousErrorHandling&&s.syncErrorThrowable&&(s.syncErrorThrowable=!1,s.syncErrorThrown))throw s.syncErrorValue;return s},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){u.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),!function(t){for(;t;){var e=t,n=e.closed,i=e.destination,s=e.isStopped;if(n||s)return!1;t=i&&i instanceof g?i:null}return!0}(t)?console.warn(e):t.error(e)}},t.prototype.forEach=function(t,e){var n=this;return new(e=j(e))((function(e,i){var s;s=n.subscribe((function(e){try{t(e)}catch(t){i(t),s&&s.unsubscribe()}}),i,e)}))},t.prototype._subscribe=function(t){var e=this.source;return e&&e.subscribe(t)},t.prototype[M]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return 0===t.length?this:x(t)(this)},t.prototype.toPromise=function(t){var e=this;return new(t=j(t))((function(t,n){var i;e.subscribe((function(t){return i=t}),(function(t){return n(t)}),(function(){return t(i)}))}))},t.create=function(e){return new t(e)},t}();function j(t){if(t||(t=Promise),!t)throw new Error("no Promise impl found");return t}var E=function(){function t(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return t.prototype=Object.create(Error.prototype),t}(),O=function(t){function e(e,n){var i=t.call(this)||this;return i.subject=e,i.subscriber=n,i.closed=!1,i}return c(e,t),e.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var t=this.subject,e=t.observers;if(this.subject=null,e&&0!==e.length&&!t.isStopped&&!t.closed){var n=e.indexOf(this.subscriber);-1!==n&&e.splice(n,1)}}},e}(y),A=function(t){function e(e){var n=t.call(this,e)||this;return n.destination=e,n}return c(e,t),e}(g),I=function(t){function e(){var e=t.call(this)||this;return e.observers=[],e.closed=!1,e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return c(e,t),e.prototype[w]=function(){return new A(this)},e.prototype.lift=function(t){var e=new T(this,this);return e.operator=t,e},e.prototype.next=function(t){if(this.closed)throw new E;if(!this.isStopped)for(var e=this.observers,n=e.length,i=e.slice(),s=0;s<n;s++)i[s].next(t)},e.prototype.error=function(t){if(this.closed)throw new E;this.hasError=!0,this.thrownError=t,this.isStopped=!0;for(var e=this.observers,n=e.length,i=e.slice(),s=0;s<n;s++)i[s].error(t);this.observers.length=0},e.prototype.complete=function(){if(this.closed)throw new E;this.isStopped=!0;for(var t=this.observers,e=t.length,n=t.slice(),i=0;i<e;i++)n[i].complete();this.observers.length=0},e.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},e.prototype._trySubscribe=function(e){if(this.closed)throw new E;return t.prototype._trySubscribe.call(this,e)},e.prototype._subscribe=function(t){if(this.closed)throw new E;return this.hasError?(t.error(this.thrownError),y.EMPTY):this.isStopped?(t.complete(),y.EMPTY):(this.observers.push(t),new O(this,t))},e.prototype.asObservable=function(){var t=new P;return t.source=this,t},e.create=function(t,e){return new T(t,e)},e}(P),T=function(t){function e(e,n){var i=t.call(this)||this;return i.destination=e,i.source=n,i}return c(e,t),e.prototype.next=function(t){var e=this.destination;e&&e.next&&e.next(t)},e.prototype.error=function(t){var e=this.destination;e&&e.error&&this.destination.error(t)},e.prototype.complete=function(){var t=this.destination;t&&t.complete&&this.destination.complete()},e.prototype._subscribe=function(t){return this.source?this.source.subscribe(t):y.EMPTY},e}(I),D=function(t){function e(e){var n=t.call(this)||this;return n._value=e,n}return c(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),e.prototype._subscribe=function(e){var n=t.prototype._subscribe.call(this,e);return n&&!n.closed&&e.next(this._value),n},e.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new E;return this._value},e.prototype.next=function(e){t.prototype.next.call(this,this._value=e)},e}(I),B=function(t){function e(e,n){var i=t.call(this,e,n)||this;return i.scheduler=e,i.work=n,i.pending=!1,i}return c(e,t),e.prototype.schedule=function(t,e){if(void 0===e&&(e=0),this.closed)return this;this.state=t;var n=this.id,i=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(i,n,e)),this.pending=!0,this.delay=e,this.id=this.id||this.requestAsyncId(i,this.id,e),this},e.prototype.requestAsyncId=function(t,e,n){return void 0===n&&(n=0),setInterval(t.flush.bind(t,this),n)},e.prototype.recycleAsyncId=function(t,e,n){if(void 0===n&&(n=0),null!==n&&this.delay===n&&!1===this.pending)return e;clearInterval(e)},e.prototype.execute=function(t,e){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(t,e);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,e){var n=!1,i=void 0;try{this.work(t)}catch(t){n=!0,i=!!t&&t||new Error(t)}if(n)return this.unsubscribe(),i},e.prototype._unsubscribe=function(){var t=this.id,e=this.scheduler,n=e.actions,i=n.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==i&&n.splice(i,1),null!=t&&(this.id=this.recycleAsyncId(e,t,null)),this.delay=null},e}(function(t){function e(e,n){return t.call(this)||this}return c(e,t),e.prototype.schedule=function(t,e){return this},e}(y)),C=function(){function t(e,n){void 0===n&&(n=t.now),this.SchedulerAction=e,this.now=n}return t.prototype.schedule=function(t,e,n){return void 0===e&&(e=0),new this.SchedulerAction(this,t).schedule(n,e)},t.now=function(){return Date.now()},t}(),L=function(t){function e(n,i){void 0===i&&(i=C.now);var s=t.call(this,n,(function(){return e.delegate&&e.delegate!==s?e.delegate.now():i()}))||this;return s.actions=[],s.active=!1,s.scheduled=void 0,s}return c(e,t),e.prototype.schedule=function(n,i,s){return void 0===i&&(i=0),e.delegate&&e.delegate!==this?e.delegate.schedule(n,i,s):t.prototype.schedule.call(this,n,i,s)},e.prototype.flush=function(t){var e=this.actions;if(this.active)e.push(t);else{var n;this.active=!0;do{if(n=t.execute(t.state,t.delay))break}while(t=e.shift());if(this.active=!1,n){for(;t=e.shift();)t.unsubscribe();throw n}}},e}(C),G=new P((function(t){return t.complete()}));function V(t){return t?function(t){return new P((function(e){return t.schedule((function(){return e.complete()}))}))}(t):G}function k(t){return t&&"function"==typeof t.schedule}var U=function(t){return function(e){for(var n=0,i=t.length;n<i&&!e.closed;n++)e.next(t[n]);e.complete()}};function z(t,e){return new P((function(n){var i=new y,s=0;return i.add(e.schedule((function(){s!==t.length?(n.next(t[s++]),n.closed||i.add(this.schedule())):n.complete()}))),i}))}function Y(t,e){return e?z(t,e):new P(U(t))}function X(t){var e=t.error;t.subscriber.error(e)}var Z=function(){function t(t,e,n){this.kind=t,this.value=e,this.error=n,this.hasValue="N"===t}return t.prototype.observe=function(t){switch(this.kind){case"N":return t.next&&t.next(this.value);case"E":return t.error&&t.error(this.error);case"C":return t.complete&&t.complete()}},t.prototype.do=function(t,e,n){switch(this.kind){case"N":return t&&t(this.value);case"E":return e&&e(this.error);case"C":return n&&n()}},t.prototype.accept=function(t,e,n){return t&&"function"==typeof t.next?this.observe(t):this.do(t,e,n)},t.prototype.toObservable=function(){var t,e;switch(this.kind){case"N":return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t[t.length-1];return k(n)?(t.pop(),z(t,n)):Y(t)}(this.value);case"E":return t=this.error,new P(e?function(n){return e.schedule(X,0,{error:t,subscriber:n})}:function(e){return e.error(t)});case"C":return V()}throw new Error("unexpected notification kind value")},t.createNext=function(e){return void 0!==e?new t("N",e):t.undefinedValueNotification},t.createError=function(e){return new t("E",void 0,e)},t.createComplete=function(){return t.completeNotification},t.completeNotification=new t("C"),t.undefinedValueNotification=new t("N",void 0),t}(),Q=new L(B);function F(){}var N=function(){function t(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}return t.prototype=Object.create(Error.prototype),t}();function H(t,e){return function(n){if("function"!=typeof t)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return n.lift(new W(t,e))}}var W=function(){function t(t,e){this.project=t,this.thisArg=e}return t.prototype.call=function(t,e){return e.subscribe(new R(t,this.project,this.thisArg))},t}(),R=function(t){function e(e,n,i){var s=t.call(this,e)||this;return s.project=n,s.count=0,s.thisArg=i||s,s}return c(e,t),e.prototype._next=function(t){var e;try{e=this.project.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}this.destination.next(e)},e}(g);function q(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}var $=q(),J=function(t){return t&&"number"==typeof t.length&&"function"!=typeof t};function K(t){return!!t&&"function"!=typeof t.subscribe&&"function"==typeof t.then}var tt=function(t){if(t&&"function"==typeof t[M])return i=t,function(t){var e=i[M]();if("function"!=typeof e.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return e.subscribe(t)};if(J(t))return U(t);if(K(t))return n=t,function(t){return n.then((function(e){t.closed||(t.next(e),t.complete())}),(function(e){return t.error(e)})).then(null,p),t};if(t&&"function"==typeof t[$])return e=t,function(t){for(var n=e[$]();;){var i=void 0;try{i=n.next()}catch(e){return t.error(e),t}if(i.done){t.complete();break}if(t.next(i.value),t.closed)break}return"function"==typeof n.return&&t.add((function(){n.return&&n.return()})),t};var e,n,i,s=b(t)?"an invalid object":"'"+t+"'";throw new TypeError("You provided "+s+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function et(t,e){if(null!=t){if(function(t){return t&&"function"==typeof t[M]}(t))return function(t,e){return new P((function(n){var i=new y;return i.add(e.schedule((function(){var s=t[M]();i.add(s.subscribe({next:function(t){i.add(e.schedule((function(){return n.next(t)})))},error:function(t){i.add(e.schedule((function(){return n.error(t)})))},complete:function(){i.add(e.schedule((function(){return n.complete()})))}}))}))),i}))}(t,e);if(K(t))return function(t,e){return new P((function(n){var i=new y;return i.add(e.schedule((function(){return t.then((function(t){i.add(e.schedule((function(){n.next(t),i.add(e.schedule((function(){return n.complete()})))})))}),(function(t){i.add(e.schedule((function(){return n.error(t)})))}))}))),i}))}(t,e);if(J(t))return z(t,e);if(function(t){return t&&"function"==typeof t[$]}(t)||"string"==typeof t)return function(t,e){if(!t)throw new Error("Iterable cannot be null");return new P((function(n){var i,s=new y;return s.add((function(){i&&"function"==typeof i.return&&i.return()})),s.add(e.schedule((function(){i=t[$](),s.add(e.schedule((function(){if(!n.closed){var t,e;try{var s=i.next();t=s.value,e=s.done}catch(t){return void n.error(t)}e?n.complete():(n.next(t),this.schedule())}})))}))),s}))}(t,e)}throw new TypeError((null!==t&&typeof t||t)+" is not observable")}function nt(t,e){return e?et(t,e):t instanceof P?t:new P(tt(t))}var it=function(t){function e(e){var n=t.call(this)||this;return n.parent=e,n}return c(e,t),e.prototype._next=function(t){this.parent.notifyNext(t)},e.prototype._error=function(t){this.parent.notifyError(t),this.unsubscribe()},e.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},e}(g),st=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return c(e,t),e.prototype.notifyNext=function(t){this.destination.next(t)},e.prototype.notifyError=function(t){this.destination.error(t)},e.prototype.notifyComplete=function(){this.destination.complete()},e}(g);function rt(t,e){if(!e.closed)return t instanceof P?t.subscribe(e):tt(t)(e)}function ot(t,e,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),"function"==typeof e?function(i){return i.pipe(ot((function(n,i){return nt(t(n,i)).pipe(H((function(t,s){return e(n,t,i,s)})))}),n))}:("number"==typeof e&&(n=e),function(e){return e.lift(new at(t,n))})}var at=function(){function t(t,e){void 0===e&&(e=Number.POSITIVE_INFINITY),this.project=t,this.concurrent=e}return t.prototype.call=function(t,e){return e.subscribe(new ct(t,this.project,this.concurrent))},t}(),ct=function(t){function e(e,n,i){void 0===i&&(i=Number.POSITIVE_INFINITY);var s=t.call(this,e)||this;return s.project=n,s.concurrent=i,s.hasCompleted=!1,s.buffer=[],s.active=0,s.index=0,s}return c(e,t),e.prototype._next=function(t){this.active<this.concurrent?this._tryNext(t):this.buffer.push(t)},e.prototype._tryNext=function(t){var e,n=this.index++;try{e=this.project(t,n)}catch(t){return void this.destination.error(t)}this.active++,this._innerSub(e)},e.prototype._innerSub=function(t){var e=new it(this),n=this.destination;n.add(e);var i=rt(t,e);i!==e&&n.add(i)},e.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete(),this.unsubscribe()},e.prototype.notifyNext=function(t){this.destination.next(t)},e.prototype.notifyComplete=function(){var t=this.buffer;this.active--,t.length>0?this._next(t.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},e}(st);function ht(t,e){return function(n){return n.lift(new lt(t,e))}}var lt=function(){function t(t,e){this.predicate=t,this.thisArg=e}return t.prototype.call=function(t,e){return e.subscribe(new ut(t,this.predicate,this.thisArg))},t}(),ut=function(t){function e(e,n,i){var s=t.call(this,e)||this;return s.predicate=n,s.thisArg=i,s.count=0,s}return c(e,t),e.prototype._next=function(t){var e;try{e=this.predicate.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}e&&this.destination.next(t)},e}(g);function pt(t,e){void 0===e&&(e=Q);var n,i=(n=t)instanceof Date&&!isNaN(+n)?+t-e.now():Math.abs(t);return function(t){return t.lift(new dt(i,e))}}var dt=function(){function t(t,e){this.delay=t,this.scheduler=e}return t.prototype.call=function(t,e){return e.subscribe(new ft(t,this.delay,this.scheduler))},t}(),ft=function(t){function e(e,n,i){var s=t.call(this,e)||this;return s.delay=n,s.scheduler=i,s.queue=[],s.active=!1,s.errored=!1,s}return c(e,t),e.dispatch=function(t){for(var e=t.source,n=e.queue,i=t.scheduler,s=t.destination;n.length>0&&n[0].time-i.now()<=0;)n.shift().notification.observe(s);if(n.length>0){var r=Math.max(0,n[0].time-i.now());this.schedule(t,r)}else this.unsubscribe(),e.active=!1},e.prototype._schedule=function(t){this.active=!0,this.destination.add(t.schedule(e.dispatch,this.delay,{source:this,destination:this.destination,scheduler:t}))},e.prototype.scheduleNotification=function(t){if(!0!==this.errored){var e=this.scheduler,n=new bt(e.now()+this.delay,t);this.queue.push(n),!1===this.active&&this._schedule(e)}},e.prototype._next=function(t){this.scheduleNotification(Z.createNext(t))},e.prototype._error=function(t){this.errored=!0,this.queue=[],this.destination.error(t),this.unsubscribe()},e.prototype._complete=function(){this.scheduleNotification(Z.createComplete()),this.unsubscribe()},e}(g),bt=function(){return function(t,e){this.time=t,this.notification=e}}();var mt=function(){function t(t){if(this.total=t,this.total<0)throw new N}return t.prototype.call=function(t,e){return e.subscribe(new yt(t,this.total))},t}(),yt=function(t){function e(e,n){var i=t.call(this,e)||this;return i.total=n,i.count=0,i}return c(e,t),e.prototype._next=function(t){var e=this.total,n=++this.count;n<=e&&(this.destination.next(t),n===e&&(this.destination.complete(),this.unsubscribe()))},e}(g);function vt(t,e){return"function"==typeof e?function(n){return n.pipe(vt((function(n,i){return nt(t(n,i)).pipe(H((function(t,s){return e(n,t,i,s)})))})))}:function(e){return e.lift(new wt(t))}}var wt=function(){function t(t){this.project=t}return t.prototype.call=function(t,e){return e.subscribe(new gt(t,this.project))},t}(),gt=function(t){function e(e,n){var i=t.call(this,e)||this;return i.project=n,i.index=0,i}return c(e,t),e.prototype._next=function(t){var e,n=this.index++;try{e=this.project(t,n)}catch(t){return void this.destination.error(t)}this._innerSub(e)},e.prototype._innerSub=function(t){var e=this.innerSubscription;e&&e.unsubscribe();var n=new it(this),i=this.destination;i.add(n),this.innerSubscription=rt(t,n),this.innerSubscription!==n&&i.add(this.innerSubscription)},e.prototype._complete=function(){var e=this.innerSubscription;e&&!e.closed||t.prototype._complete.call(this),this.unsubscribe()},e.prototype._unsubscribe=function(){this.innerSubscription=void 0},e.prototype.notifyComplete=function(){this.innerSubscription=void 0,this.isStopped&&t.prototype._complete.call(this)},e.prototype.notifyNext=function(t){this.destination.next(t)},e}(st);function St(t){return function(e){return e.lift(new Mt(t))}}var Mt=function(){function t(t){this.notifier=t}return t.prototype.call=function(t,e){var n=new _t(t),i=rt(this.notifier,new it(n));return i&&!n.seenValue?(n.add(i),e.subscribe(n)):n},t}(),_t=function(t){function e(e){var n=t.call(this,e)||this;return n.seenValue=!1,n}return c(e,t),e.prototype.notifyNext=function(){this.seenValue=!0,this.complete()},e.prototype.notifyComplete=function(){},e}(st);function xt(t,e,n){return function(i){return i.lift(new Pt(t,e,n))}}var Pt=function(){function t(t,e,n){this.nextOrObserver=t,this.error=e,this.complete=n}return t.prototype.call=function(t,e){return e.subscribe(new jt(t,this.nextOrObserver,this.error,this.complete))},t}(),jt=function(t){function e(e,n,i,s){var r=t.call(this,e)||this;return r._tapNext=F,r._tapError=F,r._tapComplete=F,r._tapError=i||F,r._tapComplete=s||F,h(n)?(r._context=r,r._tapNext=n):n&&(r._context=n,r._tapNext=n.next||F,r._tapError=n.error||F,r._tapComplete=n.complete||F),r}return c(e,t),e.prototype._next=function(t){try{this._tapNext.call(this._context,t)}catch(t){return void this.destination.error(t)}this.destination.next(t)},e.prototype._error=function(t){try{this._tapError.call(this._context,t)}catch(t){return void this.destination.error(t)}this.destination.error(t)},e.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(t){return void this.destination.error(t)}return this.destination.complete()},e}(g),Et={leading:!0,trailing:!1};function Ot(t,e,n){return void 0===e&&(e=Q),void 0===n&&(n=Et),function(i){return i.lift(new At(t,e,n.leading,n.trailing))}}var At=function(){function t(t,e,n,i){this.duration=t,this.scheduler=e,this.leading=n,this.trailing=i}return t.prototype.call=function(t,e){return e.subscribe(new It(t,this.duration,this.scheduler,this.leading,this.trailing))},t}(),It=function(t){function e(e,n,i,s,r){var o=t.call(this,e)||this;return o.duration=n,o.scheduler=i,o.leading=s,o.trailing=r,o._hasTrailingValue=!1,o._trailingValue=null,o}return c(e,t),e.prototype._next=function(t){this.throttled?this.trailing&&(this._trailingValue=t,this._hasTrailingValue=!0):(this.add(this.throttled=this.scheduler.schedule(Tt,this.duration,{subscriber:this})),this.leading?this.destination.next(t):this.trailing&&(this._trailingValue=t,this._hasTrailingValue=!0))},e.prototype._complete=function(){this._hasTrailingValue?(this.destination.next(this._trailingValue),this.destination.complete()):this.destination.complete()},e.prototype.clearThrottle=function(){var t=this.throttled;t&&(this.trailing&&this._hasTrailingValue&&(this.destination.next(this._trailingValue),this._trailingValue=null,this._hasTrailingValue=!1),t.unsubscribe(),this.remove(t),this.throttled=null)},e}(g);function Tt(t){t.subscriber.clearThrottle()}const Dt=(t,e)=>n=>function(t,e,n){return t.mouseButton===e&&!t.isTouch||t.touchCount===n&&t.isTouch}(n,t,e);const Bt=(t,e,n)=>{const{button:i,touchCount:s}=n;return t.pointerDown$.pipe(ht(Dt(i,s)),vt(n=>t.pointerUp$.pipe(ht(Dt(i,0)),St(t.pointerMove$.pipe(pt(150))),ot(async t=>(t.isTouch&&await e.calculateIntersection(n),t.intersection=e.intersection,t)),ht(Ct))))},Ct=t=>!(!t||!t.intersection),Lt=(t,n)=>async i=>(i.intersection=await t.pick(new e.Vector2(i.x,i.y),n),i);new e.Raycaster;(()=>{const t=new e.Vector3,n=new e.Vector3,i=new e.Matrix4})();var Gt,Vt,kt=function(){n.InstancedBufferGeometry.call(this),this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new n.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new n.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))};kt.prototype=Object.assign(Object.create(n.InstancedBufferGeometry.prototype),{constructor:kt,isLineSegmentsGeometry:!0,applyMatrix4:function(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(e.applyMatrix4(t),n.applyMatrix4(t),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new n.InstancedInterleavedBuffer(e,6,1);return this.setAttribute("instanceStart",new n.InterleavedBufferAttribute(i,3,0)),this.setAttribute("instanceEnd",new n.InterleavedBufferAttribute(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new n.InstancedInterleavedBuffer(e,6,1);return this.setAttribute("instanceColorStart",new n.InterleavedBufferAttribute(i,3,0)),this.setAttribute("instanceColorEnd",new n.InterleavedBufferAttribute(i,3,3)),this},fromWireframeGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromEdgesGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromMesh:function(t){return this.fromWireframeGeometry(new n.WireframeGeometry(t.geometry)),this},fromLineSegments:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.attributes.position.array),this},computeBoundingBox:(Vt=new n.Box3,function(){null===this.boundingBox&&(this.boundingBox=new n.Box3);var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;void 0!==t&&void 0!==e&&(this.boundingBox.setFromBufferAttribute(t),Vt.setFromBufferAttribute(e),this.boundingBox.union(Vt))}),computeBoundingSphere:(Gt=new n.Vector3,function(){null===this.boundingSphere&&(this.boundingSphere=new n.Sphere),null===this.boundingBox&&this.computeBoundingBox();var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;if(void 0!==t&&void 0!==e){var i=this.boundingSphere.center;this.boundingBox.getCenter(i);for(var s=0,r=0,o=t.count;r<o;r++)Gt.fromBufferAttribute(t,r),s=Math.max(s,i.distanceToSquared(Gt)),Gt.fromBufferAttribute(e,r),s=Math.max(s,i.distanceToSquared(Gt));this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}),toJSON:function(){},applyMatrix:function(t){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(t)}});var Ut=function(){kt.call(this),this.type="LineGeometry"};Ut.prototype=Object.assign(Object.create(kt.prototype),{constructor:Ut,isLineGeometry:!0,setPositions:function(t){for(var e=t.length-3,n=new Float32Array(2*e),i=0;i<e;i+=3)n[2*i]=t[i],n[2*i+1]=t[i+1],n[2*i+2]=t[i+2],n[2*i+3]=t[i+3],n[2*i+4]=t[i+4],n[2*i+5]=t[i+5];return kt.prototype.setPositions.call(this,n),this},setColors:function(t){for(var e=t.length-3,n=new Float32Array(2*e),i=0;i<e;i+=3)n[2*i]=t[i],n[2*i+1]=t[i+1],n[2*i+2]=t[i+2],n[2*i+3]=t[i+3],n[2*i+4]=t[i+4],n[2*i+5]=t[i+5];return kt.prototype.setColors.call(this,n),this},fromLine:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.attributes.position.array),this},copy:function(){return this}}),n.UniformsLib.line={linewidth:{value:1},resolution:{value:new n.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1},opacity:{value:1}},n.ShaderLib.line={uniforms:n.UniformsUtils.merge([n.UniformsLib.common,n.UniformsLib.fog,n.UniformsLib.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\t\t\t#include <premultiplied_alpha_fragment>\n\n\t\t}\n\t\t"};var zt=function(t){n.ShaderMaterial.call(this,{type:"LineMaterial",uniforms:n.UniformsUtils.clone(n.ShaderLib.line.uniforms),vertexShader:n.ShaderLib.line.vertexShader,fragmentShader:n.ShaderLib.line.fragmentShader,clipping:!0}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)};(zt.prototype=Object.create(n.ShaderMaterial.prototype)).constructor=zt,zt.prototype.isLineMaterial=!0;var Yt,Xt,Zt,Qt,Ft,Nt=function(t,e){n.Mesh.call(this),this.type="LineSegments2",this.geometry=void 0!==t?t:new kt,this.material=void 0!==e?e:new zt({color:16777215*Math.random()})};Nt.prototype=Object.assign(Object.create(n.Mesh.prototype),{constructor:Nt,isLineSegments2:!0,computeLineDistances:(Yt=new n.Vector3,Xt=new n.Vector3,function(){for(var t=this.geometry,e=t.attributes.instanceStart,i=t.attributes.instanceEnd,s=new Float32Array(2*e.data.count),r=0,o=0,a=e.data.count;r<a;r++,o+=2)Yt.fromBufferAttribute(e,r),Xt.fromBufferAttribute(i,r),s[o]=0===o?0:s[o-1],s[o+1]=s[o]+Yt.distanceTo(Xt);var c=new n.InstancedInterleavedBuffer(s,2,1);return t.setAttribute("instanceDistanceStart",new n.InterleavedBufferAttribute(c,1,0)),t.setAttribute("instanceDistanceEnd",new n.InterleavedBufferAttribute(c,1,1)),this}),raycast:function(){var t=new n.Vector4,e=new n.Vector4,i=new n.Vector4,s=new n.Vector3,r=new n.Matrix4,o=new n.Line3,a=new n.Vector3;return function(c,h){null===c.camera&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2.');var l=c.ray,u=c.camera,p=u.projectionMatrix,d=this.geometry,f=this.material,b=f.resolution,m=f.linewidth,y=d.attributes.instanceStart,v=d.attributes.instanceEnd;l.at(1,i),i.w=1,i.applyMatrix4(u.matrixWorldInverse),i.applyMatrix4(p),i.multiplyScalar(1/i.w),i.x*=b.x/2,i.y*=b.y/2,i.z=0,s.copy(i);var w=this.matrixWorld;r.multiplyMatrices(u.matrixWorldInverse,w);for(var g=0,S=y.count;g<S;g++){t.fromBufferAttribute(y,g),e.fromBufferAttribute(v,g),t.w=1,e.w=1,t.applyMatrix4(r),e.applyMatrix4(r),t.applyMatrix4(p),e.applyMatrix4(p),t.multiplyScalar(1/t.w),e.multiplyScalar(1/e.w);var M=t.z<-1&&e.z<-1,_=t.z>1&&e.z>1;if(!M&&!_){t.x*=b.x/2,t.y*=b.y/2,e.x*=b.x/2,e.y*=b.y/2,o.start.copy(t),o.start.z=0,o.end.copy(e),o.end.z=0;var x=o.closestPointToPointParameter(s,!0);o.at(x,a);var P=n.MathUtils.lerp(t.z,e.z,x),j=P>=-1&&P<=1,E=s.distanceTo(a)<.5*m;if(j&&E){o.start.fromBufferAttribute(y,g),o.end.fromBufferAttribute(v,g),o.start.applyMatrix4(w),o.end.applyMatrix4(w);var O=new n.Vector3,A=new n.Vector3;l.distanceSqToSegment(o.start,o.end,A,O),h.push({point:A,pointOnLine:O,distance:l.origin.distanceTo(A),object:this,face:null,faceIndex:g,uv:null,uv2:null})}}}}}()});class Ht extends Nt{constructor(t,n){super(t,n),this._inverseMatrix=new e.Matrix4,this._ray=new e.Ray,this._frustum=new e.Frustum,this._line3=new e.Line3,this._box=new e.Box3,this.vStart=new e.Vector3,this.vEnd=new e.Vector3,this.interPoint=new e.Vector3,this.material=n,n.dashed?n.defines.USE_DASH="":delete n.defines.USE_DASH,this.onBeforeRender=t=>t.getSize(n.resolution)}update(t){let e;if(t instanceof Float32Array)e=t;else{const n=this.geometry.attributes.instanceEnd;e=n?n.data.array:void 0,e&&e.length===3*t.length||(e=new Float32Array(3*t.length));for(let n=0;n<t.length;n++)t[n].toArray(e,3*n)}const n=this.geometry.getAttribute("instanceStart");n&&n.array.length!==2*e.length-6&&(this.geometry=new Ut),this.geometry.setPositions(e),this.material.dashed&&this.computeLineDistances()}onUpload(t){this.geometry.attributes.instanceStart.data.onUploadCallback=t;this.geometry.attributes.instanceEnd.data.onUploadCallback=t}raycast(t,n){const i=this.geometry,s=this.matrixWorld;if(this._box.copy(i.boundingBox),this._box.applyMatrix4(s),!t.frustum.intersectsBox(this._box))return;this._inverseMatrix.getInverse(s),this._ray.copy(t.ray).applyMatrix4(this._inverseMatrix),this._frustum.copy(t.frustum);for(const t of this._frustum.planes)t.applyMatrix4(this._inverseMatrix);const r=this&&this instanceof e.LineSegments?2:1,o=i.attributes.instanceEnd.data.array;for(let e=0,i=o.length/3-1;e<i;e+=r){if(this.vStart.fromArray(o,3*e),this.vEnd.fromArray(o,3*e+3),!this.intersectFrustum(this._frustum,this.vStart,this.vEnd,this.interPoint))continue;this.interPoint.applyMatrix4(this.matrixWorld);const i=t.ray.origin.distanceTo(this.interPoint);i<t.near||i>t.far||n.push({distance:i,point:this.interPoint.clone(),index:e,object:this})}}intersectFrustum(t,e,n,i){this._line3.set(e,n);for(let e=0;e<4;e++)if(t.planes[e].intersectLine(this._line3,i)&&t.containsPoint(i))return!0}}function Wt(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}Object.assign(Wt.prototype,{setSize:function(){},render:function(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),Wt.FullScreenQuad=(Zt=new n.OrthographicCamera(-1,1,1,-1,0,1),Qt=new n.PlaneBufferGeometry(2,2),Ft=function(t){this._mesh=new n.Mesh(Qt,t)},Object.defineProperty(Ft.prototype,"material",{get:function(){return this._mesh.material},set:function(t){this._mesh.material=t}}),Object.assign(Ft.prototype,{dispose:function(){this._mesh.geometry.dispose()},render:function(t){t.render(this._mesh,Zt)}}),Ft);var Rt=function(t,e,n,i,s){Wt.call(this),this.scene=t,this.camera=e,this.overrideMaterial=n,this.clearColor=i,this.clearAlpha=void 0!==s?s:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1};Rt.prototype=Object.assign(Object.create(Wt.prototype),{constructor:Rt,render:function(t,e,n){var i,s,r,o=t.autoClear;t.autoClear=!1,void 0!==this.overrideMaterial&&(r=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(i=t.getClearColor().getHex(),s=t.getClearAlpha(),t.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&t.clearDepth(),t.setRenderTarget(this.renderToScreen?null:n),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),t.render(this.scene,this.camera),this.clearColor&&t.setClearColor(i,s),void 0!==this.overrideMaterial&&(this.scene.overrideMaterial=r),t.autoClear=o}});class qt{constructor(t,n,s){this._api=t,this.model=n,this._camera=s,this.planeSnapStartMarkerPicked=!1,this.copy=!1,this.caster=new i,this.dragStart=new e.Vector3,this.dragEnd=new e.Vector3,this.assemblyObjectStartPosition=new e.Vector3,this.dragMovingScreenPosition=new e.Vector2,this.dragMoving=new e.Vector3,this.dragOffset=new e.Vector3,this.cameraDirection=new e.Vector3,this.dragPlane=new e.Plane,this.planeSnapStartMarkerGeometry=new e.SphereGeometry(.5),this.planeSnapStartMarkerMaterial=new e.MeshBasicMaterial({color:6711039,depthTest:!1,depthWrite:!1,transparent:!0}),this.planeSnapMeshLineStart=new e.Vector3,this.planeSnapMeshLineEnd=new e.Vector3,this.startPosition=new e.Vector3,this.endPosition=new e.Vector3,this.startDirection=new e.Vector3,this.endDirection=new e.Vector3,this.pickingEnd=!1,this.createPlaneSnapMarker(),this._camera=this._api.camera,this.mouseButton=0,this._tapsObservable=this._api.inputHandler.pointerDown$.pipe(vt(t=>this._api.inputHandler.pointerUp$.pipe(St(this._api.inputHandler.pointerMove$.pipe(pt(150))),H(()=>t),ot(Lt(this._api.inputHandler.picker))))),this._moveObservable=this._api.inputHandler.pointerMove$.pipe(Ot(100),ot(Lt(this._api.inputHandler.picker)),xt(t=>this.onMove(t))),this._hoverObservable=this._api.inputHandler.pointerMove$.pipe(Ot(100),xt(t=>this.onHover(t))),this.planeSnapMeshLine=new Ht(new Ut,new zt({linewidth:3,color:6711039,opacity:.3,depthTest:!1,depthWrite:!1,transparent:!0})),this.createRenderPass()}get name(){return"assemblyEditing"}createRenderPass(){this.renderPass=new Rt(new e.Scene,this._api.camera),this.renderPass.clear=!1,this._api.renderingManager.composer.addPassAfterAntialiasing(this.renderPass)}createPlaneSnapMarker(){this.planeSnapStartMarker=r(this.planeSnapStartMarkerGeometry,this.planeSnapStartMarkerMaterial,this._api),this.planeSnapStartMarker.name="planeStartMarker",this.planeSnapStartMarker.renderOrder=1}addPlaneSnapMarker(t){this.planeSnapStartMarker.position.copy(t),this.model.add(this.planeSnapStartMarker),this._api.renderingManager.redraw()}updatePlaneSnapMeshLine(t){this.planeSnapStartMarker.position.clone(),this.planeSnapMeshLineStart.copy(this.planeSnapStartMarker.position.clone()),this.planeSnapMeshLineEnd.copy(t),this.planeSnapMeshLine.update([this.planeSnapMeshLineStart,this.planeSnapMeshLineEnd]),this.planeSnapMeshLine.visible=!0,this._api.renderingManager.redraw()}removePlaneSnapMarker(){this.model.remove(this.planeSnapStartMarker),this.planeSnapMeshLine.visible=!1,this._hoverSubscription&&this._hoverSubscription.unsubscribe(),this._api.renderingManager.redraw()}_onPickObjectTap(t){const e=t.intersection;if(!e||!e.object)return void this.removePlaneSnapMarker();if(!this.model.assetGUIDs.includes(e.object.name))return;const n=this.model.assemblyObjects;for(const t of n)t.assetGUID===e.object.name&&(this.assemblyObject=t);this.showSnaps(e.object.name),this.objectSelectedState()}async _onPickStartSnapTap(t){const e=t.intersection;if(!e||!e.object)return this.removePlaneSnapMarker(),void this.defaultState();if(this.model.assetGUIDs.includes(e.object.name)){const t=this.assemblyObject.assetGUID,n=this.model.assemblyObjects;for(const t of n)t.assetGUID===e.object.name&&(this.assemblyObject=t);if(this.pickingEnd)this.removePlaneSnapMarker(),this._hoverSubscription.unsubscribe(),this.endPosition.copy(e.point),this.endDirection.copy(e.normal).negate().normalize(),this.pickingEnd=!1,await this.assemblyObjectToMove.moveAndRotate(this.startPosition,this.endPosition,this.startDirection,this.endDirection);else if(t===this.assemblyObject.assetGUID){if(this.startPosition.copy(e.point),this.startDirection.copy(e.normal).normalize(),this.pickingEnd=!0,this.copy){const t=await this.model.copyAssembly(this.viewer,this.assemblyObject.assetGUID);for(const e of n)e.assetGUID===t&&(this.assemblyObject=e)}this.assemblyObjectToMove=this.assemblyObject,this.addPlaneSnapMarker(e.point),this._hoverSubscription=this._hoverObservable.subscribe()}this.showSnaps(e.object.name)}else if("SnapPoint"!==e.object.parent.name)this.removePlaneSnapMarker();else{if(await console.log("2"),this.pickingEnd=!1,this.removePlaneSnapMarker(),this.copy){const t=await this.model.copyAssembly(this.viewer,this.assemblyObject.assetGUID);for(const e of this.model.assemblyObjects)e.assetGUID===t&&(this.assemblyObject=e)}const t=e.object.parent;1===t.snapState&&(t.snapState=0,this.assemblyObjectStartPosition.copy(this.assemblyObject.position),this._camera.getWorldDirection(this.cameraDirection),t.getWorldPosition(this.dragStart),this.dragOffset.copy(this.dragStart.clone().sub(this.assemblyObjectStartPosition)),this.dragMoving.copy(this.dragStart.clone()),this.dragPlane.setFromNormalAndCoplanarPoint(this.cameraDirection,this.dragStart),this.objectMovingState())}}async _onPickEndSnapTap(t){this.deactivateSnapPoints();const e=t.intersection;if(!e||!e.object)return await this.assemblyObject.updatePosition(this.assemblyObjectStartPosition),void this.objectSelectedState();if(this.model.assetGUIDs.includes(e.object.name))return await this.assemblyObject.updatePosition(this.assemblyObjectStartPosition),void this.objectSelectedState();if("SnapPoint"!==e.object.parent.name);else{const t=e.object.parent;1!==t.snapState&&(t.getWorldPosition(this.dragEnd),await this.assemblyObject.updatePosition(this.dragEnd.clone().sub(this.dragOffset)),this.defaultState())}}async onMove(t){this.updateFromPointerPosition(t),t.intersection&&"SnapPoint"===t.intersection.object.parent.name&&t.intersection.object.getWorldPosition(this.dragMoving),await this.assemblyObject.updatePosition(this.dragMoving.clone().sub(this.dragOffset)),this._api.renderingManager.redraw()}onHover(t){this.updateFromPointerPosition(t),this.updatePlaneSnapMeshLine(this.dragMoving.clone())}updateFromPointerPosition(t){this.dragMovingScreenPosition.set(t.x,t.y),this.caster.screenPosition=this.dragMovingScreenPosition;const n=function(t,n,i=new e.Vector2){const s=n.getBoundingClientRect();return i.x=(t.x-s.left)/n.clientWidth*2-1,i.y=-(t.y-s.top)/n.clientHeight*2+1,i}(this.caster.screenPosition,this._api.container);this.caster.setFromCamera(n,this._camera),this.caster.ray.intersectPlane(this.dragPlane,this.dragMoving)}showSnaps(t){const e=this.model.assemblyObjects;for(const n of e)n.showSnapPoints(),t===n.assetGUID?n.enableSnapPoints():n.disableSnapPoints()}hideSnaps(){const t=this.model.assemblyObjects;for(const e of t)e.disableSnapPoints(),e.hideSnapPoints()}deactivateSnapPoints(){const t=this.model.assemblyObjects;for(const e of t)e.disableSnapPoints()}get enabled(){return!!this._tapsSubscription}set enabled(t){if(this.unsubscribeAll(),this._tapsSubscription&&this._tapsSubscription.unsubscribe(),!t)return this.hideSnaps(),void this.renderPass.scene.remove(this.planeSnapMeshLine);this._tapsSubscription=this._tapsObservable.subscribe(),this.defaultState(),this.planeSnapMeshLine.visible=!1,this.renderPass.scene.add(this.planeSnapMeshLine)}defaultState(){this.hideSnaps(),this.unsubscribeAll(),this._defaultSubscription=this._tapsObservable.subscribe(t=>{(t.mouseButton===this.mouseButton||t.isTouch)&&this._onPickObjectTap(t)})}objectSelectedState(){this.unsubscribeAll(),this._objectSelectedSubscription=this._tapsObservable.subscribe(t=>{(t.mouseButton===this.mouseButton||t.isTouch)&&this._onPickStartSnapTap(t)})}objectMovingState(){this.unsubscribeAll(),this._moveSubscription=this._moveObservable.subscribe(),this._objectMovingSubscription=this._tapsObservable.subscribe(t=>{(t.mouseButton===this.mouseButton||t.isTouch)&&this._onPickEndSnapTap(t).then()})}unsubscribeAll(){this._defaultSubscription&&this._defaultSubscription.unsubscribe(),this._objectSelectedSubscription&&this._objectSelectedSubscription.unsubscribe(),this._objectMovingSubscription&&this._objectMovingSubscription.unsubscribe(),this._moveSubscription&&this._moveSubscription.unsubscribe()}}class $t extends e.Object3D{constructor(t){super(),super.name=t,this.boundingBox=new D(new e.Box3),this.up.copy(o.up)}get modelId(){return this.name}getBoundingBox(t){return Promise.resolve(this.boundingBox.value)}subscribeToBoundingBox(t){this.boundingBox.subscribe(t)}transform(t){const n=(new e.Matrix4).fromArray(t.elements),i=this.matrixWorld.clone();n.decompose(this.position,this.quaternion,this.scale);const s=n.multiply(i.getInverse(i));this.boundingBox.value.applyMatrix4(s),this.updateMatrixWorld(!0),this.boundingBox.next(this.boundingBox.value)}isLoading(){return!1}dispose(){}}class Jt extends e.Object3D{constructor(t,n,i){super(),this._api=t,this.snapPointGeometry=new e.SphereGeometry(.3),this.snapPointPickSphereGeometry=new e.SphereGeometry(1),this.snapPointMaterial=new e.MeshBasicMaterial({color:16737792,depthTest:!1,depthWrite:!1,transparent:!0}),this.snapPointPickSphereMaterial=new e.MeshBasicMaterial({color:16777215,opacity:0,depthTest:!1,depthWrite:!1,transparent:!0}),this.name="SnapPoint",this.init(n,i)}init(t,e){this.parentTrimbimId=e,this.position.copy(t),this.snapPoint=r(this.snapPointGeometry,this.snapPointMaterial,this._api),this.snapPointPickSphere=r(this.snapPointPickSphereGeometry,this.snapPointPickSphereMaterial,this._api),this.snapPoint.renderOrder=1,this.add(this.snapPoint),this.add(this.snapPointPickSphere),this._api.renderingManager.redraw()}changeColour(){1===this.snapState?(this.snapPointMaterial.color.setHex(16746496),this.snapPoint.renderOrder=2,this.snapPointMaterial.opacity=1):(this.snapPointMaterial.color.setHex(11184810),this.snapPointMaterial.opacity=.5,this.snapPoint.renderOrder=1),this._api.renderingManager.redraw()}}class Kt extends e.Object3D{constructor(t,n,i){super(),this.model=t,this.def=n,this.api=i,this.snapPoints=[],this.assemblyObjectTransform=new e.Matrix4,this.init()}async init(){this.assemblyObjectDefinition=this.def,this.assetGUID=this.def.assetGUID,this.assemblyName=this.def.assemblyName;for(const t of this.api.models.getIterable())t.name===this.assetGUID&&(this.geometryModel=t);this.createSnapPoints(this.def.snapPositions),this.geometryModel.add(this),this.assemblyObjectTransform.fromArray(this.def.transform),this.model.add(this),this.geometryModel.transform(this.assemblyObjectTransform),this.applyMatrix4(this.geometryModel.matrixWorld)}exportAssemblyDefinition(){return this.assemblyObjectDefinition.transform=this.matrixWorld.elements,this.assemblyObjectDefinition.snapPositions=this.snapPointsToSnapPositions(this.snapPoints),this.assemblyObjectDefinition}createSnapPoints(t){for(let n=0;n<t.length/3;++n){const i=new e.Vector3(t[3*n],t[3*n+1],t[3*n+2]);this.createSnapPoint(i)}}snapPointsToSnapPositions(t){const e=[];for(const n of t)e.push(n.position.x),e.push(n.position.y),e.push(n.position.z);return e}updateTransform(t){this.geometryModel.transform(t),t.decompose(this.position,this.quaternion,this.scale)}async updatePosition(t){this.geometryModel.transform(this.geometryModel.matrixWorld.clone().setPosition(t)),this.position.copy(t)}async updateTrimbimPosition(t,n){const i=new e.Matrix4;n&&i.makeRotationFromEuler(n),i.setPosition(t),this.geometryModel.transform(i)}async moveAndRotate(t,n,i,s){const r=new e.Vector3;r.copy(this.worldToLocal(t.clone())),this.position.copy(this.position.clone().add(n.clone().sub(t.clone()))),this.translateX(r.x),this.translateY(r.y),this.translateZ(r.z);const o=this.rotationQuaternionFromVectors(i.clone(),s.clone());this.applyQuaternion(o),this.translateX(-r.x),this.translateY(-r.y),this.translateZ(-r.z),await this.updateTrimbimPosition(this.position.clone(),this.rotation.clone())}rotationQuaternionFromVectors(t,n){const i=new e.Quaternion;return i.setFromUnitVectors(t,n),i}createSnapPoint(t){const e=new Jt(this.api,t,this.assetGUID);this.snapPoints.push(e)}addSnapPoint(t){this.worldToLocal(t);for(const e of this.snapPoints)if(this.pointsAreCoincident(e.position,t,.001))return;this.createSnapPoint(t)}deleteSnapPoint(t){for(const e of this.snapPoints)if(e.id===t){this.remove(e),e.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()});const t=this.snapPoints.indexOf(e);this.snapPoints.splice(t,1)}}pointsAreCoincident(t,e,n){return Math.abs(t.x-e.x)<n&&Math.abs(t.y-e.y)<n&&Math.abs(t.z-e.z)<n}showSnapPoints(){for(const t of this.snapPoints)this.add(t);this.api.renderingManager.redraw()}hideSnapPoints(){for(const t of this.snapPoints)this.remove(t);this.api.renderingManager.redraw()}enableSnapPoints(){for(const t of this.snapPoints)t.snapState=1,t.changeColour();this.api.renderingManager.redraw()}disableSnapPoints(){for(const t of this.snapPoints)t.snapState=2,t.changeColour();this.api.renderingManager.redraw()}deactivateAllSnapPoints(){for(const t of this.snapPoints)t.snapState=2;this.api.renderingManager.redraw()}}class te extends $t{constructor(t){super(te.ModelId),this.api=t,this.assemblyObjects=[],this.assetGUIDs=[]}static get ModelId(){return"assemblyEditing"}async loadAssemblyFromFile(t,e){const n=await fetch(e).then(t=>t.json());await this.loadAssembly(t,n)}async loadAssembly(t,n){if(n.ref){const i=new e.Matrix4;i.fromArray(n.transform),await t.load(n.ref,{modelId:n.assetGUID,transform:i})}const i=new Kt(this,n,this.api);this.add(i),this.assemblyObjects.push(i),this.assetGUIDs.push(n.assetGUID)}async importAsset(t,e){const n=new Date;e.assetGUID.length<1&&(e.assetGUID=n.getTime().toString()),e.assemblyName.length<1&&(e.assemblyName="default");const i=document.createElement("input");i.type="file",i.accept=".trb",document.body.appendChild(i);const s=async()=>{i.removeEventListener("change",s),document.body.removeChild(i),e.ref=i.files[0],e.transform=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],e.snapPositions=[0,0,0];const n={modelId:e.assetGUID};await t.load(i.files[0],n);const r=new Kt(this,e,this.api);this.add(r),this.assemblyObjects.push(r),this.assetGUIDs.push(e.assetGUID)};i.addEventListener("change",s),i.click()}exportAssets(t){const e=[];for(const n of this.assemblyObjects)t&&!t.includes(n.assetGUID)||e.push(n.exportAssemblyDefinition());return e}async clearAssemblies(t){const e=this.api.selection,n=e.keys();let i=[];if(0===e.size)i=this.assetGUIDs.slice();else for(const t of n)"string"==typeof t&&this.assetGUIDs.includes(t)&&(i.push(t),this.api.selection.subtract(t,[0]));for(const e of i)if("grid.trb"!==e&&(await t.unload(e),this.assetGUIDs.includes(e)))for(const t of this.assemblyObjects)t.assetGUID===e&&(this.remove(t),t.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.assemblyObjects.splice(this.assemblyObjects.indexOf(t),1),this.assetGUIDs.splice(this.assetGUIDs.indexOf(e),1),this.activeAssemblyObject=void 0)}async copyAssembly(t,e){for(const n of this.assemblyObjects)if(n.assetGUID===e){const e=await n.exportAssemblyDefinition(),i=new Date;return e.assetGUID=i.getTime().toString(),await this.loadAssembly(t,e),e.assetGUID}}async copyAssemblies(t,e){const n=this.api.selection,i=n.keys();let s=[];if(0===n.size)return;for(const t of i)"string"==typeof t&&this.assetGUIDs.includes(t)&&s.push(t);const r=[];for(const e of s)for(const n of this.assemblyObjects)if(n.assetGUID===e){const e=await n.exportAssemblyDefinition(),i=new Date;e.assetGUID=i.getTime().toString(),r.push(e.assetGUID),await this.loadAssembly(t,e)}for(const t of r)for(const n of this.assemblyObjects)n.assetGUID===t&&await n.updatePosition(n.position.clone().add(e))}async moveAssemblies(t){const e=this.api.selection,n=e.keys();let i=[];if(0!==e.size){for(const t of n)"string"==typeof t&&this.assetGUIDs.includes(t)&&i.push(t);for(const e of i)for(const n of this.assemblyObjects)n.assetGUID===e&&await n.updatePosition(n.position.clone().add(t))}}async pick(t){const e=this.intersectSnapPoints(t);return Promise.resolve(e)}async pickSnapped(t,n){const i=this.intersectSnapPoints(t);if(i&&i.object&&"SnapPoint"===i.object.parent.name){i.snapType=2;const t=i.object.parent.parent,n=new e.Vector3;n.copy(i.object.parent.position),t.localToWorld(n),i.point.copy(n)}return Promise.resolve([i])}intersectSnapPoints(t){const e=t.intersectObjects(this.children,!0);if(0===e.length)return;const n=[],i=[];for(const t of e){if("SnapPoint"===t.object.parent.name){const e=t.object.parent;1===e.snapState&&n.push(t),2===e.snapState&&i.push(t)}"planeStartMarker"===t.object.name&&n.push(t)}if(n.push(...i),0===n.length)return;const s=n[0];return s.pickPriority=1,s}disableAllSnaps(){for(const t of this.assemblyObjects)t.disableSnapPoints()}enableAllSnaps(){for(const t of this.assemblyObjects)t.enableSnapPoints()}showAllSnaps(){for(const t of this.assemblyObjects)t.showSnapPoints()}hideAllSnaps(){for(const t of this.assemblyObjects)t.hideSnapPoints()}}class ee{constructor(){this._translationSnapSubject=new D(0),this._rotationSnapSubject=new D(0)}get translationSnap(){return this._translationSnapSubject.value}set translationSnap(t){this._translationSnapSubject.next(t)}get rotationSnap(){return this._rotationSnapSubject.value}set rotationSnap(t){this._rotationSnapSubject.next(t)}}var ne=function(t,e){void 0===e&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),e=document),n.Object3D.call(this),this.visible=!1,this.domElement=e;var i=new ie;this.add(i);var s=new se;this.add(s);var r=this;Y("camera",t),Y("object",void 0),Y("enabled",!0),Y("axis",null),Y("mode","translate"),Y("translationSnap",null),Y("rotationSnap",null),Y("scaleSnap",null),Y("space","world"),Y("size",1),Y("dragging",!1),Y("showX",!0),Y("showY",!0),Y("showZ",!0);var o={type:"change"},a={type:"mouseDown"},c={type:"mouseUp",mode:r.mode},h={type:"objectChange"},l=new n.Raycaster;function u(t,e,n){for(var i=e.intersectObject(t,!0),s=0;s<i.length;s++)if(i[s].object.visible||n)return i[s];return!1}var p=new n.Vector3,d=new n.Vector3,f=new n.Quaternion,b={X:new n.Vector3(1,0,0),Y:new n.Vector3(0,1,0),Z:new n.Vector3(0,0,1)},m=new n.Vector3,y=new n.Vector3,v=new n.Vector3,w=new n.Vector3,g=new n.Vector3,S=new n.Vector3,M=0,_=new n.Vector3,x=new n.Quaternion,P=new n.Vector3,j=new n.Vector3,E=new n.Quaternion,O=new n.Quaternion,A=new n.Vector3,I=new n.Vector3,T=new n.Quaternion,D=new n.Vector3,B=new n.Vector3,C=new n.Quaternion,L=new n.Quaternion,G=new n.Vector3,V=new n.Vector3,k=new n.Vector3,U=new n.Quaternion,z=new n.Vector3;function Y(t,e){var n=e;Object.defineProperty(r,t,{get:function(){return void 0!==n?n:e},set:function(e){n!==e&&(n=e,s[t]=e,i[t]=e,r.dispatchEvent({type:t+"-changed",value:e}),r.dispatchEvent(o))}}),r[t]=e,s[t]=e,i[t]=e}function X(t){if(document.pointerLockElement)return{x:0,y:0,button:t.button};var n=t.changedTouches?t.changedTouches[0]:t,i=e.getBoundingClientRect();return{x:(n.clientX-i.left)/i.width*2-1,y:-(n.clientY-i.top)/i.height*2+1,button:t.button}}function Z(t){r.enabled&&r.pointerHover(X(t))}function Q(t){r.enabled&&(document.addEventListener("mousemove",F,!1),r.pointerHover(X(t)),r.pointerDown(X(t)))}function F(t){r.enabled&&r.pointerMove(X(t))}function N(t){r.enabled&&(document.removeEventListener("mousemove",F,!1),r.pointerUp(X(t)))}Y("worldPosition",B),Y("worldPositionStart",I),Y("worldQuaternion",C),Y("worldQuaternionStart",T),Y("cameraPosition",_),Y("cameraQuaternion",x),Y("pointStart",m),Y("pointEnd",y),Y("rotationAxis",w),Y("rotationAngle",M),Y("eye",V),e.addEventListener("mousedown",Q,!1),e.addEventListener("touchstart",Q,!1),e.addEventListener("mousemove",Z,!1),e.addEventListener("touchmove",Z,!1),e.addEventListener("touchmove",F,!1),document.addEventListener("mouseup",N,!1),e.addEventListener("touchend",N,!1),e.addEventListener("touchcancel",N,!1),e.addEventListener("touchleave",N,!1),this.dispose=function(){e.removeEventListener("mousedown",Q),e.removeEventListener("touchstart",Q),e.removeEventListener("mousemove",Z),document.removeEventListener("mousemove",F),e.removeEventListener("touchmove",Z),e.removeEventListener("touchmove",F),document.removeEventListener("mouseup",N),e.removeEventListener("touchend",N),e.removeEventListener("touchcancel",N),e.removeEventListener("touchleave",N),this.traverse((function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}))},this.attach=function(t){return this.object=t,this.visible=!0,this},this.detach=function(){return this.object=void 0,this.visible=!1,this.axis=null,this},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),null===this.object.parent?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(j,E,A),this.object.matrixWorld.decompose(B,C,G),O.copy(E).inverse(),L.copy(C).inverse()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(_,x,P),V.copy(_).sub(B).normalize(),n.Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(t){if(void 0!==this.object&&!0!==this.dragging&&(void 0===t.button||0===t.button)){l.setFromCamera(t,this.camera);var e=u(i.picker[this.mode],l);this.axis=e?e.object.name:null}},this.pointerDown=function(t){if(!(void 0===this.object||!0===this.dragging||void 0!==t.button&&0!==t.button||0!==t.button&&void 0!==t.button||null===this.axis)){l.setFromCamera(t,this.camera);var e=u(s,l,!0);if(e){var n=this.space;if("scale"===this.mode?n="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(n="world"),"local"===n&&"rotate"===this.mode){var i=this.rotationSnap;"X"===this.axis&&i&&(this.object.rotation.x=Math.round(this.object.rotation.x/i)*i),"Y"===this.axis&&i&&(this.object.rotation.y=Math.round(this.object.rotation.y/i)*i),"Z"===this.axis&&i&&(this.object.rotation.z=Math.round(this.object.rotation.z/i)*i)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),k.copy(this.object.position),U.copy(this.object.quaternion),z.copy(this.object.scale),this.object.matrixWorld.decompose(I,T,D),m.copy(e.point).sub(I)}this.dragging=!0,a.mode=this.mode,this.dispatchEvent(a)}},this.pointerMove=function(t){var e=this.axis,n=this.mode,i=this.object,r=this.space;if("scale"===n?r="local":"E"!==e&&"XYZE"!==e&&"XYZ"!==e||(r="world"),void 0!==i&&null!==e&&!1!==this.dragging&&(void 0===t.button||0===t.button)){l.setFromCamera(t,this.camera);var a=u(s,l,!0);if(a){if(y.copy(a.point).sub(I),"translate"===n)v.copy(y).sub(m),"local"===r&&"XYZ"!==e&&v.applyQuaternion(L),-1===e.indexOf("X")&&(v.x=0),-1===e.indexOf("Y")&&(v.y=0),-1===e.indexOf("Z")&&(v.z=0),"local"===r&&"XYZ"!==e?v.applyQuaternion(U).divide(A):v.applyQuaternion(O).divide(A),i.position.copy(v).add(k),this.translationSnap&&("local"===r&&(i.position.applyQuaternion(f.copy(U).inverse()),-1!==e.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.position.applyQuaternion(U)),"world"===r&&(i.parent&&i.position.add(p.setFromMatrixPosition(i.parent.matrixWorld)),-1!==e.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.parent&&i.position.sub(p.setFromMatrixPosition(i.parent.matrixWorld))));else if("scale"===n){if(-1!==e.search("XYZ")){var c=y.length()/m.length();y.dot(m)<0&&(c*=-1),d.set(c,c,c)}else p.copy(m),d.copy(y),p.applyQuaternion(L),d.applyQuaternion(L),d.divide(p),-1===e.search("X")&&(d.x=1),-1===e.search("Y")&&(d.y=1),-1===e.search("Z")&&(d.z=1);i.scale.copy(z).multiply(d),this.scaleSnap&&(-1!==e.search("X")&&(i.scale.x=Math.round(i.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Y")&&(i.scale.y=Math.round(i.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Z")&&(i.scale.z=Math.round(i.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===n){v.copy(y).sub(m);var _=20/B.distanceTo(p.setFromMatrixPosition(this.camera.matrixWorld));"E"===e?(w.copy(V),M=y.angleTo(m),g.copy(m).normalize(),S.copy(y).normalize(),M*=S.cross(g).dot(V)<0?1:-1):"XYZE"===e?(w.copy(v).cross(V).normalize(),M=v.dot(p.copy(w).cross(this.eye))*_):"X"!==e&&"Y"!==e&&"Z"!==e||(w.copy(b[e]),p.copy(b[e]),"local"===r&&p.applyQuaternion(C),M=v.dot(p.cross(V).normalize())*_),this.rotationSnap&&(M=Math.round(M/this.rotationSnap)*this.rotationSnap),this.rotationAngle=M,"local"===r&&"E"!==e&&"XYZE"!==e?(i.quaternion.copy(U),i.quaternion.multiply(f.setFromAxisAngle(w,M)).normalize()):(w.applyQuaternion(O),i.quaternion.copy(f.setFromAxisAngle(w,M)),i.quaternion.multiply(U).normalize())}this.dispatchEvent(o),this.dispatchEvent(h)}}},this.pointerUp=function(t){void 0!==t.button&&0!==t.button||(this.dragging&&null!==this.axis&&(c.mode=this.mode,this.dispatchEvent(c)),this.dragging=!1,void 0===t.button&&(this.axis=null))},this.getMode=function(){return r.mode},this.setMode=function(t){r.mode=t},this.setTranslationSnap=function(t){r.translationSnap=t},this.setRotationSnap=function(t){r.rotationSnap=t},this.setScaleSnap=function(t){r.scaleSnap=t},this.setSize=function(t){r.size=t},this.setSpace=function(t){r.space=t},this.update=function(){console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}};ne.prototype=Object.assign(Object.create(n.Object3D.prototype),{constructor:ne,isTransformControls:!0});var ie=function(){n.Object3D.call(this),this.type="TransformControlsGizmo";var t=new n.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:n.DoubleSide,fog:!1}),e=new n.LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),i=t.clone();i.opacity=.15;var s=t.clone();s.opacity=.33;var r=t.clone();r.color.set(16711680);var o=t.clone();o.color.set(65280);var a=t.clone();a.color.set(255);var c=t.clone();c.opacity=.25;var h=c.clone();h.color.set(16776960);var l=c.clone();l.color.set(65535);var u=c.clone();u.color.set(16711935),t.clone().color.set(16776960);var p=e.clone();p.color.set(16711680);var d=e.clone();d.color.set(65280);var f=e.clone();f.color.set(255);var b=e.clone();b.color.set(65535);var m=e.clone();m.color.set(16711935);var y=e.clone();y.color.set(16776960);var v=e.clone();v.color.set(7895160);var w=y.clone();w.opacity=.25;var g=new n.CylinderBufferGeometry(0,.05,.2,12,1,!1),S=new n.BoxBufferGeometry(.125,.125,.125),M=new n.BufferGeometry;M.setAttribute("position",new n.Float32BufferAttribute([0,0,0,1,0,0],3));var _=function(t,e){for(var i=new n.BufferGeometry,s=[],r=0;r<=64*e;++r)s.push(0,Math.cos(r/32*Math.PI)*t,Math.sin(r/32*Math.PI)*t);return i.setAttribute("position",new n.Float32BufferAttribute(s,3)),i},x={X:[[new n.Mesh(g,r),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new n.Mesh(g,r),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new n.Line(M,p)]],Y:[[new n.Mesh(g,o),[0,1,0],null,null,"fwd"],[new n.Mesh(g,o),[0,1,0],[Math.PI,0,0],null,"bwd"],[new n.Line(M,d),null,[0,0,Math.PI/2]]],Z:[[new n.Mesh(g,a),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new n.Mesh(g,a),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new n.Line(M,f),null,[0,-Math.PI/2,0]]],XYZ:[[new n.Mesh(new n.OctahedronBufferGeometry(.1,0),c.clone()),[0,0,0],[0,0,0]]],XY:[[new n.Mesh(new n.PlaneBufferGeometry(.295,.295),h.clone()),[.15,.15,0]],[new n.Line(M,y),[.18,.3,0],null,[.125,1,1]],[new n.Line(M,y),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new n.Mesh(new n.PlaneBufferGeometry(.295,.295),l.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new n.Line(M,b),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new n.Line(M,b),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new n.Mesh(new n.PlaneBufferGeometry(.295,.295),u.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new n.Line(M,m),[.18,0,.3],null,[.125,1,1]],[new n.Line(M,m),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},P={X:[[new n.Mesh(new n.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new n.Mesh(new n.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new n.Mesh(new n.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new n.Mesh(new n.OctahedronBufferGeometry(.2,0),i)]],XY:[[new n.Mesh(new n.PlaneBufferGeometry(.4,.4),i),[.2,.2,0]]],YZ:[[new n.Mesh(new n.PlaneBufferGeometry(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new n.Mesh(new n.PlaneBufferGeometry(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},j={START:[[new n.Mesh(new n.OctahedronBufferGeometry(.01,2),s),null,null,null,"helper"]],END:[[new n.Mesh(new n.OctahedronBufferGeometry(.01,2),s),null,null,null,"helper"]],DELTA:[[new n.Line(function(){var t=new n.BufferGeometry;return t.setAttribute("position",new n.Float32BufferAttribute([0,0,0,1,1,1],3)),t}(),s),null,null,null,"helper"]],X:[[new n.Line(M,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new n.Line(M,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new n.Line(M,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},E={X:[[new n.Line(_(1,.5),p)],[new n.Mesh(new n.OctahedronBufferGeometry(.04,0),r),[0,0,.99],null,[1,3,1]]],Y:[[new n.Line(_(1,.5),d),null,[0,0,-Math.PI/2]],[new n.Mesh(new n.OctahedronBufferGeometry(.04,0),o),[0,0,.99],null,[3,1,1]]],Z:[[new n.Line(_(1,.5),f),null,[0,Math.PI/2,0]],[new n.Mesh(new n.OctahedronBufferGeometry(.04,0),a),[.99,0,0],null,[1,3,1]]],E:[[new n.Line(_(1.25,1),w),null,[0,Math.PI/2,0]],[new n.Mesh(new n.CylinderBufferGeometry(.03,0,.15,4,1,!1),w),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new n.Mesh(new n.CylinderBufferGeometry(.03,0,.15,4,1,!1),w),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new n.Mesh(new n.CylinderBufferGeometry(.03,0,.15,4,1,!1),w),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new n.Mesh(new n.CylinderBufferGeometry(.03,0,.15,4,1,!1),w),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new n.Line(_(1,1),v),null,[0,Math.PI/2,0]]]},O={AXIS:[[new n.Line(M,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},A={X:[[new n.Mesh(new n.TorusBufferGeometry(1,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new n.Mesh(new n.TorusBufferGeometry(1,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new n.Mesh(new n.TorusBufferGeometry(1,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new n.Mesh(new n.TorusBufferGeometry(1.25,.1,2,24),i)]],XYZE:[[new n.Mesh(new n.SphereBufferGeometry(.7,10,8),i)]]},I={X:[[new n.Mesh(S,r),[.8,0,0],[0,0,-Math.PI/2]],[new n.Line(M,p),null,null,[.8,1,1]]],Y:[[new n.Mesh(S,o),[0,.8,0]],[new n.Line(M,d),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new n.Mesh(S,a),[0,0,.8],[Math.PI/2,0,0]],[new n.Line(M,f),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new n.Mesh(S,h),[.85,.85,0],null,[2,2,.2]],[new n.Line(M,y),[.855,.98,0],null,[.125,1,1]],[new n.Line(M,y),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new n.Mesh(S,l),[0,.85,.85],null,[.2,2,2]],[new n.Line(M,b),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new n.Line(M,b),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new n.Mesh(S,u),[.85,0,.85],null,[2,.2,2]],[new n.Line(M,m),[.855,0,.98],null,[.125,1,1]],[new n.Line(M,m),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new n.Mesh(new n.BoxBufferGeometry(.125,.125,.125),c.clone()),[1.1,0,0]]],XYZY:[[new n.Mesh(new n.BoxBufferGeometry(.125,.125,.125),c.clone()),[0,1.1,0]]],XYZZ:[[new n.Mesh(new n.BoxBufferGeometry(.125,.125,.125),c.clone()),[0,0,1.1]]]},T={X:[[new n.Mesh(new n.CylinderBufferGeometry(.2,0,.8,4,1,!1),i),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new n.Mesh(new n.CylinderBufferGeometry(.2,0,.8,4,1,!1),i),[0,.5,0]]],Z:[[new n.Mesh(new n.CylinderBufferGeometry(.2,0,.8,4,1,!1),i),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new n.Mesh(S,i),[.85,.85,0],null,[3,3,.2]]],YZ:[[new n.Mesh(S,i),[0,.85,.85],null,[.2,3,3]]],XZ:[[new n.Mesh(S,i),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new n.Mesh(new n.BoxBufferGeometry(.2,.2,.2),i),[1.1,0,0]]],XYZY:[[new n.Mesh(new n.BoxBufferGeometry(.2,.2,.2),i),[0,1.1,0]]],XYZZ:[[new n.Mesh(new n.BoxBufferGeometry(.2,.2,.2),i),[0,0,1.1]]]},D={X:[[new n.Line(M,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new n.Line(M,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new n.Line(M,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},B=function(t){var e=new n.Object3D;for(var i in t)for(var s=t[i].length;s--;){var r=t[i][s][0].clone(),o=t[i][s][1],a=t[i][s][2],c=t[i][s][3],h=t[i][s][4];r.name=i,r.tag=h,o&&r.position.set(o[0],o[1],o[2]),a&&r.rotation.set(a[0],a[1],a[2]),c&&r.scale.set(c[0],c[1],c[2]),r.updateMatrix();var l=r.geometry.clone();l.applyMatrix4(r.matrix),r.geometry=l,r.renderOrder=1/0,r.position.set(0,0,0),r.rotation.set(0,0,0),r.scale.set(1,1,1),e.add(r)}return e},C=new n.Vector3(0,0,0),L=new n.Euler,G=new n.Vector3(0,1,0),V=new n.Vector3(0,0,0),k=new n.Matrix4,U=new n.Quaternion,z=new n.Quaternion,Y=new n.Quaternion,X=new n.Vector3(1,0,0),Z=new n.Vector3(0,1,0),Q=new n.Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=B(x)),this.add(this.gizmo.rotate=B(E)),this.add(this.gizmo.scale=B(I)),this.add(this.picker.translate=B(P)),this.add(this.picker.rotate=B(A)),this.add(this.picker.scale=B(T)),this.add(this.helper.translate=B(j)),this.add(this.helper.rotate=B(O)),this.add(this.helper.scale=B(D)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){var t=this.space;"scale"===this.mode&&(t="local");var e="local"===t?this.worldQuaternion:Y;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var i=[];i=(i=(i=i.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var s=0;s<i.length;s++){var r,o=i[s];if(o.visible=!0,o.rotation.set(0,0,0),o.position.copy(this.worldPosition),r=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),o.scale.set(1,1,1).multiplyScalar(r*this.size/7),"helper"!==o.tag){if(o.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode){"X"!==o.name&&"XYZX"!==o.name||Math.abs(G.copy(X).applyQuaternion(e).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"Y"!==o.name&&"XYZY"!==o.name||Math.abs(G.copy(Z).applyQuaternion(e).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"Z"!==o.name&&"XYZZ"!==o.name||Math.abs(G.copy(Q).applyQuaternion(e).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"XY"===o.name&&Math.abs(G.copy(Q).applyQuaternion(e).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"YZ"===o.name&&Math.abs(G.copy(X).applyQuaternion(e).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"XZ"===o.name&&Math.abs(G.copy(Z).applyQuaternion(e).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),-1!==o.name.search("X")&&(G.copy(X).applyQuaternion(e).dot(this.eye)<0?"fwd"===o.tag?o.visible=!1:o.scale.x*=-1:"bwd"===o.tag&&(o.visible=!1)),-1!==o.name.search("Y")&&(G.copy(Z).applyQuaternion(e).dot(this.eye)<0?"fwd"===o.tag?o.visible=!1:o.scale.y*=-1:"bwd"===o.tag&&(o.visible=!1)),-1!==o.name.search("Z")&&(G.copy(Q).applyQuaternion(e).dot(this.eye)<0?"fwd"===o.tag?o.visible=!1:o.scale.z*=-1:"bwd"===o.tag&&(o.visible=!1))}else"rotate"===this.mode&&(z.copy(e),G.copy(this.eye).applyQuaternion(U.copy(e).inverse()),-1!==o.name.search("E")&&o.quaternion.setFromRotationMatrix(k.lookAt(this.eye,V,Z)),"X"===o.name&&(U.setFromAxisAngle(X,Math.atan2(-G.y,G.z)),U.multiplyQuaternions(z,U),o.quaternion.copy(U)),"Y"===o.name&&(U.setFromAxisAngle(Z,Math.atan2(G.x,G.z)),U.multiplyQuaternions(z,U),o.quaternion.copy(U)),"Z"===o.name&&(U.setFromAxisAngle(Q,Math.atan2(G.y,G.x)),U.multiplyQuaternions(z,U),o.quaternion.copy(U)));o.visible=o.visible&&(-1===o.name.indexOf("X")||this.showX),o.visible=o.visible&&(-1===o.name.indexOf("Y")||this.showY),o.visible=o.visible&&(-1===o.name.indexOf("Z")||this.showZ),o.visible=o.visible&&(-1===o.name.indexOf("E")||this.showX&&this.showY&&this.showZ),o.material._opacity=o.material._opacity||o.material.opacity,o.material._color=o.material._color||o.material.color.clone(),o.material.color.copy(o.material._color),o.material.opacity=o.material._opacity,this.enabled?this.axis&&(o.name===this.axis||this.axis.split("").some((function(t){return o.name===t}))?(o.material.opacity=1,o.material.color.lerp(new n.Color(1,1,1),.5)):(o.material.opacity*=.25,o.material.color.lerp(new n.Color(1,1,1),.5))):(o.material.opacity*=.5,o.material.color.lerp(new n.Color(1,1,1),.5))}else o.visible=!1,"AXIS"===o.name?(o.position.copy(this.worldPositionStart),o.visible=!!this.axis,"X"===this.axis&&(U.setFromEuler(L.set(0,0,0)),o.quaternion.copy(e).multiply(U),Math.abs(G.copy(X).applyQuaternion(e).dot(this.eye))>.9&&(o.visible=!1)),"Y"===this.axis&&(U.setFromEuler(L.set(0,0,Math.PI/2)),o.quaternion.copy(e).multiply(U),Math.abs(G.copy(Z).applyQuaternion(e).dot(this.eye))>.9&&(o.visible=!1)),"Z"===this.axis&&(U.setFromEuler(L.set(0,Math.PI/2,0)),o.quaternion.copy(e).multiply(U),Math.abs(G.copy(Q).applyQuaternion(e).dot(this.eye))>.9&&(o.visible=!1)),"XYZE"===this.axis&&(U.setFromEuler(L.set(0,Math.PI/2,0)),G.copy(this.rotationAxis),o.quaternion.setFromRotationMatrix(k.lookAt(V,G,Z)),o.quaternion.multiply(U),o.visible=this.dragging),"E"===this.axis&&(o.visible=!1)):"START"===o.name?(o.position.copy(this.worldPositionStart),o.visible=this.dragging):"END"===o.name?(o.position.copy(this.worldPosition),o.visible=this.dragging):"DELTA"===o.name?(o.position.copy(this.worldPositionStart),o.quaternion.copy(this.worldQuaternionStart),C.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),C.applyQuaternion(this.worldQuaternionStart.clone().inverse()),o.scale.copy(C),o.visible=this.dragging):(o.quaternion.copy(e),this.dragging?o.position.copy(this.worldPositionStart):o.position.copy(this.worldPosition),this.axis&&(o.visible=-1!==this.axis.search(o.name)))}n.Object3D.prototype.updateMatrixWorld.call(this)}};ie.prototype=Object.assign(Object.create(n.Object3D.prototype),{constructor:ie,isTransformControlsGizmo:!0});var se=function(){n.Mesh.call(this,new n.PlaneBufferGeometry(1e5,1e5,2,2),new n.MeshBasicMaterial({visible:!1,wireframe:!0,side:n.DoubleSide,transparent:!0,opacity:.1})),this.type="TransformControlsPlane";var t=new n.Vector3(1,0,0),e=new n.Vector3(0,1,0),i=new n.Vector3(0,0,1),s=new n.Vector3,r=new n.Vector3,o=new n.Vector3,a=new n.Matrix4,c=new n.Quaternion;this.updateMatrixWorld=function(){var h=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(h="local"),t.set(1,0,0).applyQuaternion("local"===h?this.worldQuaternion:c),e.set(0,1,0).applyQuaternion("local"===h?this.worldQuaternion:c),i.set(0,0,1).applyQuaternion("local"===h?this.worldQuaternion:c),o.copy(e),this.mode){case"translate":case"scale":switch(this.axis){case"X":o.copy(this.eye).cross(t),r.copy(t).cross(o);break;case"Y":o.copy(this.eye).cross(e),r.copy(e).cross(o);break;case"Z":o.copy(this.eye).cross(i),r.copy(i).cross(o);break;case"XY":r.copy(i);break;case"YZ":r.copy(t);break;case"XZ":o.copy(i),r.copy(e);break;case"XYZ":case"E":r.set(0,0,0)}break;case"rotate":default:r.set(0,0,0)}0===r.length()?this.quaternion.copy(this.cameraQuaternion):(a.lookAt(s.set(0,0,0),r,o),this.quaternion.setFromRotationMatrix(a)),n.Object3D.prototype.updateMatrixWorld.call(this)}};se.prototype=Object.assign(Object.create(n.Mesh.prototype),{constructor:se,isTransformControlsPlane:!0});class re{constructor(t,e,n){this._api=t,this.model=e,this.settings=n,this.createTransformControls(),this.mouseButton=0,this._tapsObservable=this._api.inputHandler.pointerDown$.pipe(vt(t=>this._api.inputHandler.pointerUp$.pipe(St(this._api.inputHandler.pointerMove$.pipe(pt(150))),H(()=>t),ot(Lt(this._api.inputHandler.picker)))))}get name(){return"transform"}createTransformControls(){this.transformControls=new ne(this._api.camera,this._api.renderingManager.renderer.domElement),this.transformControls.addEventListener("change",()=>{this.assemblyObject&&this.assemblyObject.updateTrimbimPosition(this.assemblyObject.position,this.assemblyObject.rotation).then(),this._api.renderingManager.redraw()}),this.transformControls.addEventListener("dragging-changed",t=>{this._api.toolManager.tools.orbit.enabled=!t.value})}_onPickObjectTap(t){const e=t.intersection;if(!e||!e.object)return void this.disableTransformControls();if(!this.model.assetGUIDs.includes(e.object.name))return;const n=this.model.assemblyObjects;for(const t of n)t.assetGUID===e.object.name&&(this.assemblyObject=t);this.enableTransformControls()}get enabled(){return!!this._tapsSubscription}set enabled(t){this._tapsSubscription&&this._tapsSubscription.unsubscribe(),t?this._tapsSubscription=this._tapsObservable.subscribe(t=>{(t.mouseButton===this.mouseButton||t.isTouch)&&this._onPickObjectTap(t)}):this.disableTransformControls()}enableTransformControls(){this.transformControls.attach(this.assemblyObject),this.transformControls.parent||this._api.scene.add(this.transformControls),this.setRotationSnap()}disableTransformControls(){this.assemblyObject=void 0,this.transformControls.detach(),this.transformControls.parent&&this._api.scene.remove(this.transformControls)}setMove(){this.transformControls&&this.transformControls.setMode("translate")}setRotate(){this.transformControls&&this.transformControls.setMode("rotate")}setTranslationSnap(){this.transformControls&&this.transformControls.setTranslationSnap(this.settings.translationSnap)}setRotationSnap(){this.transformControls&&this.transformControls.setRotationSnap(this.settings.rotationSnap)}}class oe{constructor(t,e,n,i){this._api=t,this.inputs=e,this.model=n,this.options={button:0,touchCount:1},this.cursor=i,this.observable=Bt(this.inputs,i,this.options),this.deletingObservable=this.inputs.pointerDown$.pipe(vt(t=>this.inputs.pointerUp$.pipe(St(this.inputs.pointerMove$.pipe(pt(150))),H(()=>t),ot(Lt(this.inputs.picker)))))}get name(){return"editSnapPoints"}tap(t){if(t.intersection&&t.intersection.object){const e=t.intersection.object.name;for(const n of this.model.assemblyObjects)n.assetGUID===e&&(n.addSnapPoint(t.intersection.point),n.showSnapPoints())}}deleteTap(t){if(t.intersection&&t.intersection.object&&"SnapPoint"===t.intersection.object.parent.name){const e=t.intersection.object.parent;t.intersection.object.parent.parent.deleteSnapPoint(e.id),this._api.renderingManager.redraw()}}showSnapPoints(){for(const t of this.model.assemblyObjects)t.showSnapPoints()}hideSnapPoints(){for(const t of this.model.assemblyObjects)t.hideSnapPoints()}unsubscribe(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null),this.cursor.unsubscribe(),this.model.disableAllSnaps(),this.hideSnapPoints()}subscribeDeleteMode(){this.model.enableAllSnaps(),this.subscription=this.deletingObservable.pipe(xt(t=>this.deleteTap(t))).subscribe(),this.showSnapPoints()}subscribeAddMode(){this.subscription=this.observable.pipe(xt(t=>this.tap(t))).subscribe(),this.cursor.subscribe(),this.cursor.snapTypes=[2,1,0],this.showSnapPoints()}addMode(){this.unsubscribe(),this.subscribeAddMode()}deleteMode(){this.unsubscribe(),this.subscribeDeleteMode()}set enabled(t){this.unsubscribe(),t&&this.subscribeAddMode()}get enabled(){}}class ae{constructor(t,n,i,s){this._api=t,this.inputs=n,this.model=i,this.mode="move",this.startPoint=new e.Vector3,this.endPoint=new e.Vector3,this.movement=new e.Vector3,this.onCanceled=()=>{for(const t of this.model.assemblyObjects)t.hideSnapPoints();this._api.toolManager.activateDefaultTool()},this.cursor=s,this.meshLine=new Ht(new Ut,new zt({linewidth:3,color:6711039,opacity:.3,depthTest:!1,depthWrite:!1,transparent:!0}));const r=Bt(this._api.inputHandler,this._api.cursor,{button:0,touchCount:1});var o;this.observable=r.pipe((o=1,function(t){return 0===o?V():t.lift(new mt(o))}),ht(()=>!!this.cursor.intersection),xt(()=>this.onStart(this.cursor.intersection)),vt(t=>t.isTouch?r.pipe(xt(t=>{this.onMove(t.intersection),this.onEnd()})):this._api.inputHandler.pointerMove$.pipe(xt(t=>t.intersection=this.cursor.intersection),ht(Ct),xt(t=>this.onMove(t.intersection)),St(r.pipe(xt(()=>this.onEnd())))))),this.createRenderPass()}get name(){return"copySelected"}createRenderPass(){this.renderPass=new Rt(new e.Scene,this._api.camera),this.renderPass.clear=!1,this._api.renderingManager.composer.addPassAfterAntialiasing(this.renderPass)}onStart(t){this.startPoint.copy(t.point)}onMove(t){this.endPoint.copy(t.point),this.meshLine.update([this.startPoint,this.endPoint]),this.meshLine.visible=!0,this._api.renderingManager.redraw()}async onEnd(){this.movement.copy(this.endPoint.clone().sub(this.startPoint.clone())),"copy"===this.mode?await this.model.copyAssemblies(this.viewer,this.movement.clone()):await this.model.moveAssemblies(this.movement.clone()),this.meshLine.visible=!1,this.enabled=!1,this.onCanceled()}onEnabled(){const t=this._api.selection.keys(),e=[];for(const n of t)this.model.assetGUIDs.includes(n)&&e.push(n);for(const t of this.model.assemblyObjects)t.disableSnapPoints(),e.includes(t.assetGUID)&&t.enableSnapPoints(),t.showSnapPoints()}set enabled(t){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null,this.cursor.unsubscribe(),this.renderPass.scene.remove(this.meshLine)),t&&(this.subscription=this.observable.subscribe(),this.cursor.subscribe(),this.cursor.snapTypes=[2],this.onEnabled(),this.meshLine.visible=!1,this.renderPass.scene.add(this.meshLine))}get enabled(){return!!this.subscription}}t.AssemblyEditingPlugin=class extends class{get version(){return"DEV_BUILD"}}{get name(){return"assemblyEditing"}set api(t){this._api=t,this._settings=new ee,this._model=new te(this._api),this._api.models.add(this._model,!0),t.toolManager.addTool(new qt(t,this._model,this._camera)),t.toolManager.addTool(new re(t,this._model,this._settings)),t.toolManager.addTool(new oe(t,t.inputHandler,this._model,t.cursor)),t.toolManager.addTool(new ae(t,t.inputHandler,this._model,t.cursor))}},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map
