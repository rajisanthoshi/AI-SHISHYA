define(["exports","./webgl-viewer-plugin-trimbim.js","./webgl-viewer-plugin-markup.js","./webgl-viewer.js","./webgl-viewer-plugin-icons.js","./ConnectIdentifier.js"],(function(e,t,i,n,o,r){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function s(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function a(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,i=e[Symbol.asyncIterator];return i?i.call(e):(e=s(e),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(i){t[i]=e[i]&&function(t){return new Promise((function(n,o){(function(e,t,i,n){Promise.resolve(n).then((function(t){e({value:t,done:i})}),t)})(n,o,(t=e[i](t)).done,t.value)}))}}}class c extends Error{constructor(e,t,i){super(c.formatMessage(e,t)),this.response=e,this.errorMessage=t,this.errorCode=i,Error.captureStackTrace&&Error.captureStackTrace(this,c)}static formatMessage(e,t){return`HTTP ${e.status} (${e.statusText}): ${t}`}}var l,d,u=(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n="undefined"!=typeof window&&void 0!==window.document,o="object"===("undefined"==typeof self?"undefined":i(self))&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,r="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;t.isBrowser=n,t.isWebWorker=o,t.isNode=r,t.isJsDom=function(){return"undefined"!=typeof window&&"nodejs"===window.name||navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")}}(l={exports:{}},l.exports),l.exports);(d=u)&&d.__esModule&&Object.prototype.hasOwnProperty.call(d,"default")&&d.default,u.isBrowser,u.isWebWorker,u.isNode,u.isJsDom;var f=function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};class p{constructor(e,t,i){this.service=e,this.response=t,this.data=i,this.retryCount=0}hasNextPage(){if(this.data&&this.data.hasOwnProperty("next")){return null!==this.data.next}return!1}nextPage(){return f(this,void 0,void 0,(function*(){if(!this.hasNextPage())throw new Error("There is no next page for this response.");const e=this.data.next;return this.service.makeRequest(e)}))}}var m=function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};function g(e){const t=e.indexOf("//"),i=e.indexOf("/",t+2);return e.substring(0,i)}function h(e){return new Promise(t=>{setTimeout(t,e)})}class v{constructor(e){if(this.config=e,this.defaultRetryCount=3,!this.config.serviceUri)throw new Error("The serviceUri is required")}makeRequest(e,t="GET",i,n,o=!0){return m(this,void 0,void 0,(function*(){const r=new Headers({Accept:"application/json"});n&&n.forEach((e,t)=>{r.append(t,e)});const s=yield this.request(e,t,i,r,o);if(204!==s.response.status){const e=s.response.headers.get("content-type");if(null!==e&&-1===e.indexOf("application/json"))throw new c(s.response,"Cannot deserialize response body as it is not in a JSON format.");s.data=yield s.response.json()}return s}))}request(e,t="GET",i,n,o=!0){return m(this,void 0,void 0,(function*(){const r=e.startsWith("http")?e:e.startsWith("/")?g(this.config.serviceUri)+e:this.config.serviceUri+e,s=new Headers;return(n?n.get("Content-Type"):void 0)||void 0===i||s.set("Content-Type","application/json"),n&&n.forEach((e,t)=>{s.append(t,e)}),this.fetchWithRetry(r,{body:i,headers:s,method:t,redirect:"follow"},o)}))}maxRetries(){return void 0!==this.config.maxRetries?this.config.maxRetries:this.defaultRetryCount}calculateRetryDelay(e){if(0===e)return 0;{const t=100;return Math.random()*(Math.pow(2,e-1)*t)}}retryableError(e){return!!(this.timeoutError(e)||this.networkingError(e)||this.expiredCredentialsError(e)||this.throttledError(e)||e.response.status>=500)}networkingError(e){return"NetworkingError"===e.errorCode}timeoutError(e){return"TimeoutError"===e.errorCode}expiredCredentialsError(e){if(401===e.response.status){const e=this.config.credentials;return e&&"boolean"==typeof e.expired&&(e.expired=!0),!0}return!1}throttledError(e){return 429===e.response.status}fetchWithRetry(e,t,i=!0){return m(this,void 0,void 0,(function*(){const n=this.config.logger,o=new p(this,new Response,void 0);for(;;){const r=this.config.credentials;if(i&&r){if("function"==typeof r.get)try{yield r.get()}catch(e){if(void 0!==n){const t="[TID] Failed to acquire tokens: "+e.message;this.log(t)}throw e}r.token&&t.headers.set("Authorization","Bearer "+r.token)}const s=Date.now(),a=yield this.fetch(e,t);if(void 0!==n){const i=(Date.now()-s)/1e3,n=new Date(s).toISOString(),r=t.body?t.body.length:0,c=a.headers.get("content-length"),l=`${n} [TC HTTP] ${t.method} ${e} ${a.status} ${i} ${o.retryCount} ${r} ${c}`;this.log(l)}if(o.response=a,a.ok)return o;{let e;const t=a.headers.get("content-type");if(t&&-1!==t.indexOf("application/json")){const t=yield a.json();e=new c(a,t.message,t.code||t.errorcode)}else{const t=yield a.text();e=new c(a,t)}if(!(o.retryCount+1<this.maxRetries()&&this.retryableError(e)))throw e;{const e=a.headers.get("retry-after"),t=e?1e3*parseInt(e,10):0,i=this.calculateRetryDelay(o.retryCount)+t;yield h(i),o.retryCount++}}}}))}fetch(e,t){return fetch(e,t)}log(e){return m(this,void 0,void 0,(function*(){const t=this.config.logger;void 0!==t&&("function"==typeof t.log?t.log(e):"function"==typeof t.write&&t.write(e+"\n"))}))}}var y=function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};const w={};class b{constructor(e){this.obj=e}get origin(){return this.obj.origin}get isMaster(){return this.obj.isMaster}get location(){return this.obj.location}get tcApi(){return this.obj["tc-api"]}get orgApi(){return this.obj["org-api"]}get psetApi(){return this.obj["pset-api"]}get projectsApi(){return this.obj["projects-api"]}}var O;!function(e){e[e.Selected=1]="Selected",e[e.Hidden=4]="Hidden",e[e.SelectedHidden=5]="SelectedHidden",e[e.Visible=6]="Visible",e[e.SelectedVisible=7]="SelectedVisible",e[e.Highlighted=8]="Highlighted"}(O||(O={}));class k extends v{static isFile(e){return"FILE"===e.type}static isFolder(e){return"FOLDER"===e.type}static formatUrlFromOrigin(e,t){return"https:"+e+"/tc/api/2.0/"+t}constructor(e){super(Object.assign(Object.assign({},{serviceUri:"https://app.connect.trimble.com/tc/api/2.0/"}),e))}search(e,t){return y(this,void 0,void 0,(function*(){const i=["query="+t.query];t.projectId&&i.push("projectId="+t.projectId),t.type&&i.push("type="+t.type),t.startDate&&i.push("startDate="+t.startDate),t.endDate&&i.push("endDate="+t.endDate);let n=t.sort;if(t.sort&&t.sort.length){const e=t.sort[0];-1===[" ","+","-"].indexOf(e)&&(n=" "+n)}n&&i.push("sort="+n);const o=k.formatUrlFromOrigin(e,"search?"+i.join("&")),r=t.range?new Headers({Range:`items=${t.range.start}-${t.range.end}`}):void 0;return yield this.makeRequest(o,"GET",void 0,r)}))}listServers(){return y(this,void 0,void 0,(function*(){const e=yield this.makeRequest("regions");return e.data=e.data.map(e=>new b(e)),e}))}getUserDetails(e){return y(this,void 0,void 0,(function*(){return this.makeRequest("users/"+e)}))}listProjects(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,"projects"),i=yield this.makeRequest(t);for(const t of i.data)t.origin=e.origin;return i}))}getProject(e,t){return y(this,void 0,void 0,(function*(){if(!e)throw Error("id is required");const i=t?[t]:(yield this.listServers()).data;for(const t of i)try{const i=k.formatUrlFromOrigin(t.origin,"projects/"+e),n=yield this.makeRequest(i);if(n)return n.data.origin=t.origin,n}catch(e){}throw Error("Project with id is not found")}))}patchProject(e,t,i){return y(this,void 0,void 0,(function*(){const n=k.formatUrlFromOrigin(t,"projects/"+e);return this.makeRequest(n,"PATCH",JSON.stringify(i))}))}updateLastVisitedOnProject(e){return y(this,void 0,void 0,(function*(){const t={lastVisitedOn:function(e){let t=e.toISOString();return t=t.substr(0,t.indexOf("."))+"+0000",t}(new Date)};return this.patchProject(e.id,e.origin,t)}))}listProjectMembers(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,`projects/${e.id}/users`);return this.makeRequest(t)}))}listProjectFileSystemStructure(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,`sync/${e.id}?excludeVersion=false`);return yield this.makeRequest(t)}))}createUserGroup(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"groups");return this.makeRequest(i,"POST",JSON.stringify({name:t,projectId:e.id}))}))}removeUserGroup(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"groups/"+t);return this.request(i,"DELETE")}))}listUserGroups(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,"groups?projectId="+e.id);return this.makeRequest(t)}))}listUsersInGroup(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,`groups/${t}/users`);return this.makeRequest(i)}))}addUsersToGroup(e,t,i){return y(this,void 0,void 0,(function*(){const n=k.formatUrlFromOrigin(e.origin,`groups/${t}/users`),o=JSON.stringify(i.map(e=>({id:e})));return this.makeRequest(n,"POST",o)}))}removeUsersFromGroup(e,t,i){return y(this,void 0,void 0,(function*(){const n=k.formatUrlFromOrigin(e.origin,`groups/${t}/users`),o=JSON.stringify(i.map(e=>({id:e})));return this.request(n,"DELETE",o)}))}inviteUserToProject(e,t,i){return y(this,void 0,void 0,(function*(){const n=k.formatUrlFromOrigin(e.origin,`projects/${e.id}/users`);return this.makeRequest(n,"POST",JSON.stringify({email:t,role:i}))}))}removeUserFromProject(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,`projects/${e.id}/users/${t}`);return this.request(i,"DELETE")}))}listUsersByCompanyId(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e,`companies/${t}/users`);return this.makeRequest(i)}))}getProjectSettings(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,`projects/${e.id}/settings`);return this.makeRequest(t)}))}putProjectSettings(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,`projects/${e.id}/settings`);return this.request(i,"PATCH",JSON.stringify(t))}))}listFolderEntries(e){return y(this,void 0,void 0,(function*(){const t=e.rootId||e.id,i=k.formatUrlFromOrigin(e.origin,`folders/${t}/items`),n=yield this.makeRequest(i);for(const t of n.data)t.origin=e.origin;return n.data.sort((e,t)=>"FOLDER"===e.type&&"FILE"===t.type?-1:"FILE"===e.type&&"FOLDER"===t.type?1:e.name.localeCompare(t.name)),n}))}getFileStatus(e,t,i,n){return y(this,void 0,void 0,(function*(){let o=k.formatUrlFromOrigin(e.origin,`files/${t}/status`);const r=[];return i&&r.push("versionId="+i),n&&r.push("format="+n),r.length>0&&(o+="?"+r.join("&")),this.makeRequest(o)}))}getFile(e,t,i){return y(this,void 0,void 0,(function*(){let n=k.formatUrlFromOrigin(e.origin,"files/"+t);const o=[];i&&o.push("versionId="+i),o.length>0&&(n+="?"+o.join("&"));const r=yield this.makeRequest(n);return r.data.origin=e.origin,r}))}getFileVersions(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,`files/${t}/versions`),n=yield this.makeRequest(i);return n.data.forEach(t=>t.origin=e.origin),n}))}updateFile(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"files/"+t.id),n=yield this.makeRequest(i,"PATCH",JSON.stringify(t,(e,t)=>E("id",e,t)));return n.data.origin=e.origin,n}))}getFolder(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"folders/"+t),n=yield this.makeRequest(i);return n.data.origin=e.origin,n}))}getFileDownloadUrl(e,t,i){return y(this,void 0,void 0,(function*(){let n=k.formatUrlFromOrigin(e.origin,`files/fs/${e.id}/downloadurl`);const o=[];return t&&o.push("versionId="+t),i&&o.push("format="+i),o.length>0&&(n+="?"+o.join("&")),this.makeRequest(n)}))}uploadFileContent(e,t,i,n){return y(this,void 0,void 0,(function*(){const o=k.formatUrlFromOrigin(e.origin,"files/fs/initiate"),r=k.formatUrlFromOrigin(e.origin,"files/fs/commit"),s=t.map(e=>y(this,void 0,void 0,(function*(){const t=JSON.stringify({parentId:i,parentType:n,name:e.name}),s=(yield this.makeRequest(o,"POST",t)).data;yield fetch(s.uploadURL,{method:"PUT",body:e});return yield this.makeRequest(r,"POST",JSON.stringify({uploadId:s.uploadId}))}))),a=yield Promise.all(s);return a.forEach(t=>t.data.origin=e.origin),a}))}assimilateFile(e,t,i="TRB"){return y(this,void 0,void 0,(function*(){const n=k.formatUrlFromOrigin(e.origin,`files/${t.id}/process`),o=JSON.stringify({format:i,versionId:t.versionId});return this.request(n,"POST",o)}))}putPresentationFileContent(e,t,i,n){return y(this,void 0,void 0,(function*(){const o=new FormData;o.append("file",e,e.name);const r=k.formatUrlFromOrigin(t.origin,`files/representation?fileId=${t.id}&versionId=${n||t.versionId}&format=${i}`);return this.request(r,"POST",o,new Headers({"Content-Type":"multipart/form-data"}))}))}getImage(e,t){return y(this,void 0,void 0,(function*(){let i=t;const n=t.startsWith("/tc/static/")||t.startsWith("/tc/ng-static/")||t.startsWith("/assets/img/");if(t.startsWith("/")&&(i=(!n&&e&&"https:"+e.origin||g(this.config.serviceUri))+t),i in w)return w[i];if(n)return w[i]=i;{const e=yield this.request(i),t=yield e.response.blob();return w[i]=URL.createObjectURL(t)}}))}getPlacement(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,`files/${e.id}/alignment`);return this.makeRequest(t)}))}putPlacement(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,`files/${e.id}/alignment`);return this.makeRequest(i,"PUT",JSON.stringify(t))}))}listToDos(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,"todos?projectId="+e.id),i=yield this.makeRequest(t);for(const t of i.data)t.origin=e.origin;return i}))}getToDo(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"todos/"+t),n=yield this.makeRequest(i);if(n.data.origin=e.origin,n.data.projectId!==e.id)throw new Error("Item belongs to other project");return n}))}createToDo(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"todos"),n=yield this.makeRequest(i,"POST",JSON.stringify(t,P));return n.data.origin=e.origin,n}))}updateToDo(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"todos/"+t.id),n=yield this.makeRequest(i,"PATCH",JSON.stringify(t,P));return n.data.origin=e.origin,n}))}removeToDo(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"todos/"+t);return this.request(i,"DELETE")}))}listToDoComments(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,`comments?projectId=${e.projectId}&objectId=${e.id}&objectType=TODO`),i=yield this.makeRequest(t);for(const t of i.data)t.origin=e.origin;return i}))}listComments(e,t,i){return y(this,void 0,void 0,(function*(){const n=k.formatUrlFromOrigin(e.origin,`comments?projectId=${e.id}&objectId=${t}&objectType=${i}`),o=yield this.makeRequest(n);for(const t of o.data)t.origin=e.origin;return o}))}listAttachments(e,t,i,n){return y(this,void 0,void 0,(function*(){const o="TODO"===n?"todos":"comments",r=k.formatUrlFromOrigin(e,`${o}/${i}/attachments?projectId=${t}`),s=yield this.makeRequest(r);for(const t of s.data)t.origin=e;return s}))}listToDoAttachments(e){return y(this,void 0,void 0,(function*(){return this.listAttachments(e.origin,e.projectId,e.id,"TODO")}))}addAttachmentsToEntity(e,t,i,n){return y(this,void 0,void 0,(function*(){const o="TODO"===i.type?"todos":"comments",r=k.formatUrlFromOrigin(e,`${o}/${i.id}/attachments?projectId=${t}`),s=[];n.forEach(e=>{const t="URL"===e.type?{type:e.type,url:e.id,urlName:e.urlName||""}:{type:e.type,id:e.id,embedded:e.embedded||!1};s.push(t)});const a=JSON.stringify(s),c=yield this.makeRequest(r,"POST",a);return c.data.origin=e,c}))}attachViewToTodo(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,`todos/${e.id}/attachments?projectId=${e.projectId}`),n=yield this.makeRequest(i,"POST",JSON.stringify([{type:"VIEW",id:t.id}]));return n.data.origin=e.origin,n}))}removeAttachment(e,t,i,n,o,r){return y(this,void 0,void 0,(function*(){const s="TODO"===n?"todos":"comments",a=k.formatUrlFromOrigin(e,`${s}/${i}/attachments?projectId=${t}`);return this.request(a,"DELETE",JSON.stringify([{id:o,type:r}]))}))}createComment(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"comments"),n=yield this.makeRequest(i,"POST",JSON.stringify(t));return n.data.origin=e.origin,n}))}updateComment(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,"comments/"+e.id),i=yield this.makeRequest(t,"PATCH",JSON.stringify({description:e.description}));return i.data.origin=e.origin,i}))}deleteComment(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"comments/"+t);return this.request(i,"DELETE")}))}listViews(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,"views?projectId="+e.id),i=yield this.makeRequest(t);for(const t of i.data)t.origin=e.origin;return i}))}getView(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"views/"+t),n=yield this.makeRequest(i);if(n.data.origin=e.origin,n.data.projectId!==e.id)throw new Error("Item belongs to different project");return n}))}createView(e,t){return y(this,void 0,void 0,(function*(){""===t.description&&(t.description=void 0);const i=k.formatUrlFromOrigin(e.origin,"views"),n=yield this.makeRequest(i,"POST",JSON.stringify(t,P));return n.data.origin=e.origin,n}))}updateView(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"views/"+t.id),n=yield this.makeRequest(i,"PATCH",JSON.stringify(t,P));return n.data.origin=e.origin,n}))}removeView(e,t,i=!1){return y(this,void 0,void 0,(function*(){const n=k.formatUrlFromOrigin(e.origin,`views/${t}?force=${i}`);return this.request(n,"DELETE")}))}createViewGroup(e,t,i){return y(this,void 0,void 0,(function*(){const n=k.formatUrlFromOrigin(e.origin,"viewgroups"),o=yield this.makeRequest(n,"POST",JSON.stringify({projectId:e.id,name:t,views:i}));return o.data.origin=e.origin,o}))}removeViewGroup(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"viewgroups/"+t);return this.request(i,"DELETE")}))}updateViewGroup(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"viewgroups/"+t.id),n=yield this.makeRequest(i,"PATCH",JSON.stringify({name:t.name,views:t.views}));return n.data.origin=e.origin,n}))}listViewGroups(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,"viewgroups?projectId="+e.id),i=yield this.makeRequest(t);for(const t of i.data)t.origin=e.origin;return i}))}listTags(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,"tags?projectId="+e.id),i=yield this.makeRequest(t);for(const t of i.data)t.origin=e.origin;return i}))}createTag(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"tags"),n=yield this.makeRequest(i,"POST",JSON.stringify(t,P));return n.data.origin=e.origin,n}))}addObjectToTag(e,t,i){return y(this,void 0,void 0,(function*(){const n=k.formatUrlFromOrigin(e.origin,`tags/${e.id}/objects`);return this.request(n,"POST",JSON.stringify([{id:t,objectType:i}]))}))}removeObjectFromTag(e,t,i){return y(this,void 0,void 0,(function*(){const n=k.formatUrlFromOrigin(e.origin,`tags/${e.id}/objects`);return this.request(n,"DELETE",JSON.stringify([{id:t,objectType:i}]))}))}listTagsInObject(e,t,i){return y(this,void 0,void 0,(function*(){const n=k.formatUrlFromOrigin(e.origin,`tags?objectId=${t}&objectType=${i}&projectId=${e.id}`),o=yield this.makeRequest(n);for(const t of o.data)t.origin=e.origin;return o}))}getLinksByFile(e,t,i,n=!1,o=!1){return y(this,void 0,void 0,(function*(){let r="objectlink?id="+t;r+=void 0!==i?"&versionId="+i:"",r+="&includeDeleted="+n,r+=`&full=${o}&detail=${o}`;const s=k.formatUrlFromOrigin(e.origin,r);return this.makeRequest(s,"GET")}))}getLinksByEntity(e,t,i,n=!1){return y(this,void 0,void 0,(function*(){const o="URL"===i?encodeURIComponent(t):t,r=k.formatUrlFromOrigin(e.origin,`objectlink/target?projectId=${e.id}&type=${i}&id=${o}&includeDeleted=${n}`);return this.makeRequest(r)}))}createObjectLink(e,t,i,n,o,r,s){return y(this,void 0,void 0,(function*(){const a=n.map(e=>({sourceId:e,type:"BIMOBJECT"})),c={source:{id:t,versionId:i,data:a},target:{id:o,type:r}};"URL"===r&&(c.name=s);const l=k.formatUrlFromOrigin(e.origin,"objectlink");return this.makeRequest(l,"POST",JSON.stringify(c))}))}updateObjectLink(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"objectlink/"+t.id);return this.makeRequest(i,"PATCH",JSON.stringify(t))}))}deleteObjectLink(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"objectlink/"+t);return this.request(i,"DELETE")}))}listClashSets(e){return y(this,void 0,void 0,(function*(){const t=k.formatUrlFromOrigin(e.origin,"clashsets?projectId="+e.id),i=yield this.makeRequest(t);return i.data.forEach(t=>t.origin=e.origin),i}))}getClashSetDetails(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"clashsets/"+t),n=yield this.makeRequest(i);return n.data.origin=e.origin,n}))}createClashSet(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"clashsets"),n=yield this.makeRequest(i,"POST",JSON.stringify(t,P));return n.data.origin=e.origin,n}))}updateClashSet(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"clashsets/"+t.id),n=yield this.makeRequest(i,"PATCH",JSON.stringify(t,P));return n.data.origin=e.origin,n}))}deleteClashSet(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,"clashsets/"+t);return this.request(i,"DELETE")}))}getClashItems(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e.origin,`clashsets/${t}/items`),n=yield this.makeRequest(i);return n.data.forEach(t=>t.origin=e.origin),n}))}getShare(e,t){return y(this,void 0,void 0,(function*(){const i=k.formatUrlFromOrigin(e,"shares/token/"+t),n=yield this.makeRequest(i);return n.data.origin=e,n}))}}function P(e,t){return E("origin",e,t)}function E(e,t,i){return t===e?void 0:i}new k;var T=function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};new class extends v{constructor(e){super(Object.assign(Object.assign({},{serviceUri:"https://user.connect.trimble.com/v1/"}),e))}createUserProperty(e){return T(this,void 0,void 0,(function*(){const t=`users/${e.tidUuid}/properties`;return this.makeRequest(t,"POST",JSON.stringify(e))}))}getUserProperty(e,t){return T(this,void 0,void 0,(function*(){const i=`users/${t}/properties/${e}`;return this.makeRequest(i)}))}updateUserProperty(e){return T(this,void 0,void 0,(function*(){const t=`users/${e.tidUuid}/properties/${e.key}`;return this.makeRequest(t,"PUT",JSON.stringify(e))}))}deleteUserProperty(e,t){return T(this,void 0,void 0,(function*(){const i=`users/${t}/properties/${e}`;return this.makeRequest(i,"DELETE")}))}};const j={},I=function(e){if(j[e])return j[e];const t={},i={debug:"#7f8c8d",log:"#2ecc71",warn:"#f39c12",error:"#c0392b"},n=(t,...n)=>{const o=["%c"+e,["border: 1px solid "+i[t],"border-radius: 0.5em","color: "+i[t],"font-weight: bold","padding: 2px 0.5em"].join(";")];console[t](...o,...n)};for(const e of Object.keys(i))t[e]=(...t)=>n(e,...t);return j[e]=t,t}("App");function S(...e){I.log(...e)}function F(...e){I.error(...e)}function U(e){return null==e}new Promise(e=>{});const x={ft:{inMillimeters:304.8,symbol:"ft"},in:{inMillimeters:25.4,symbol:"in"},yd:{inMillimeters:914.4,symbol:"yd"},mi:{inMillimeters:1609344,symbol:"mi"}};Object.assign(Object.assign({},{mm:{inMillimeters:1,symbol:"mm"},cm:{inMillimeters:10,symbol:"cm"},m:{inMillimeters:1e3,symbol:"m"},km:{inMillimeters:1e6,symbol:"km"}}),x);Object.assign(Object.assign({},{mm2:{inSquareMeters:1e-6,symbol:"mm²"},cm2:{inSquareMeters:1e-4,symbol:"cm²"},m2:{inSquareMeters:1,symbol:"m²"},km2:{inSquareMeters:1e6,symbol:"km²"}}),{ft2:{inSquareMeters:.09290304,symbol:"ft²"},in2:{inSquareMeters:64516e-8,symbol:"in²"},yd2:{inSquareMeters:.83612736,symbol:"yd²"}});Object.assign(Object.assign({},{mm3:{inCubicMeters:1e-9,symbol:"mm³"},cm3:{inCubicMeters:1e-6,symbol:"cm³"},m3:{inCubicMeters:1,symbol:"m³"},km3:{inCubicMeters:1e9,symbol:"km³"}}),{ft3:{inCubicMeters:.028316846592,symbol:"ft³"},in3:{inCubicMeters:16387064e-12,symbol:"in³"},yd3:{inCubicMeters:.764554857984,symbol:"yd³"},l:{inCubicMeters:.001,symbol:"l"},gal:{inCubicMeters:.003785411784,symbol:"gal"}});var R,q;Object.assign(Object.assign({},{t:{inKilograms:1e3,symbol:"t"},mg:{inKilograms:1e-6,symbol:"mg"},g:{inKilograms:.001,symbol:"g"},kg:{inKilograms:1,symbol:"kg"}}),{lb:{inKilograms:.45359237,symbol:"lb"},"sh tn":{inKilograms:907.18474,symbol:"sh tn"},oz:{inKilograms:.028349523125,symbol:"oz"},ton:{inKilograms:1e3,symbol:"ton"}}),function(e){e[e.AllowNegative=1]="AllowNegative",e[e.AllowIntegers=2]="AllowIntegers",e[e.AllowDecimals=4]="AllowDecimals",e[e.AllowScientific=8]="AllowScientific",e[e.AllowFractions=16]="AllowFractions",e[e.Any=31]="Any"}(R||(R={})),function(e){e[e.Feet=0]="Feet",e[e.Inches=1]="Inches",e[e.FeetInches=2]="FeetInches"}(q||(q={}));var C,L="object"==typeof Reflect?Reflect:null,M=L&&"function"==typeof L.apply?L.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};C=L&&"function"==typeof L.ownKeys?L.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var N=Number.isNaN||function(e){return e!=e};function $(){$.init.call(this)}var V=$,D=function(e,t){return new Promise((function(i,n){function o(i){e.removeListener(t,r),n(i)}function r(){"function"==typeof e.removeListener&&e.removeListener("error",o),i([].slice.call(arguments))}G(e,t,r,{once:!0}),"error"!==t&&function(e,t,i){"function"==typeof e.on&&G(e,"error",t,i)}(e,o,{once:!0})}))};$.EventEmitter=$,$.prototype._events=void 0,$.prototype._eventsCount=0,$.prototype._maxListeners=void 0;var A=10;function z(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function _(e){return void 0===e._maxListeners?$.defaultMaxListeners:e._maxListeners}function X(e,t,i,n){var o,r,s,a;if(z(i),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),r=e._events),s=r[t]),void 0===s)s=r[t]=i,++e._eventsCount;else if("function"==typeof s?s=r[t]=n?[i,s]:[s,i]:n?s.unshift(i):s.push(i),(o=_(e))>0&&s.length>o&&!s.warned){s.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=s.length,a=c,console&&console.warn&&console.warn(a)}return e}function Y(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Z(e,t,i){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},o=Y.bind(n);return o.listener=i,n.wrapFn=o,o}function J(e,t,i){var n=e._events;if(void 0===n)return[];var o=n[t];return void 0===o?[]:"function"==typeof o?i?[o.listener||o]:[o]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(o):H(o,o.length)}function W(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function H(e,t){for(var i=new Array(t),n=0;n<t;++n)i[n]=e[n];return i}function G(e,t,i,n){if("function"==typeof e.on)n.once?e.once(t,i):e.on(t,i);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function o(r){n.once&&e.removeEventListener(t,o),i(r)}))}}Object.defineProperty($,"defaultMaxListeners",{enumerable:!0,get:function(){return A},set:function(e){if("number"!=typeof e||e<0||N(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");A=e}}),$.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},$.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||N(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},$.prototype.getMaxListeners=function(){return _(this)},$.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n="error"===e,o=this._events;if(void 0!==o)n=n&&void 0===o.error;else if(!n)return!1;if(n){var r;if(t.length>0&&(r=t[0]),r instanceof Error)throw r;var s=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw s.context=r,s}var a=o[e];if(void 0===a)return!1;if("function"==typeof a)M(a,this,t);else{var c=a.length,l=H(a,c);for(i=0;i<c;++i)M(l[i],this,t)}return!0},$.prototype.addListener=function(e,t){return X(this,e,t,!1)},$.prototype.on=$.prototype.addListener,$.prototype.prependListener=function(e,t){return X(this,e,t,!0)},$.prototype.once=function(e,t){return z(t),this.on(e,Z(this,e,t)),this},$.prototype.prependOnceListener=function(e,t){return z(t),this.prependListener(e,Z(this,e,t)),this},$.prototype.removeListener=function(e,t){var i,n,o,r,s;if(z(t),void 0===(n=this._events))return this;if(void 0===(i=n[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(o=-1,r=i.length-1;r>=0;r--)if(i[r]===t||i[r].listener===t){s=i[r].listener,o=r;break}if(o<0)return this;0===o?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,o),1===i.length&&(n[e]=i[0]),void 0!==n.removeListener&&this.emit("removeListener",e,s||t)}return this},$.prototype.off=$.prototype.removeListener,$.prototype.removeAllListeners=function(e){var t,i,n;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var o,r=Object.keys(i);for(n=0;n<r.length;++n)"removeListener"!==(o=r[n])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},$.prototype.listeners=function(e){return J(this,e,!0)},$.prototype.rawListeners=function(e){return J(this,e,!1)},$.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):W.call(e,t)},$.prototype.listenerCount=W,$.prototype.eventNames=function(){return this._eventsCount>0?C(this._events):[]},V.once=D,e.webglviewer=void 0,e.markupPlugin=void 0,e.trimbimPlugin=void 0;const B=new r.ConnectIdentifierBuilder,K=new V.EventEmitter;var Q;function ee(e,t){K.emit(e,t,!1)}function te(i){return e.webglviewer.getModel(i,t.TrimbimModel)}async function ie(e,t,i){const n=[],o=t.filter(e=>void 0!==e);if(!i)return e?e.guidsToEntityIds(o):[];for(const e of o){const t=i.tryGetEntityFromPersistentIdentifier(e);if(void 0!==t)n.push(t);else{const t=i.tryGetEntityFromNonPersistentIdentifier(e);t.length&&(n.push(...t),t.length>1&&S(`Multiple entityIDs ([${n.join(", ")}]) were found for identifier: ${e}`))}}return Promise.resolve(n)}async function ne(e,t){return Array.from((await async function(e,t){const i=new Map,n=[],o=te(e);if(o){const e=await o.getEntities(t),r=await o.getUntransformedBoundingBoxes(t);for(let t=0;t<e.length;t++){const o=e[t];try{let e=B.tryGetPersistentIdentifier(o);void 0===e&&(e=B.tryGetNonPersistentIdentifier(o,r[t])),i.set(o,e)}catch(e){i.set(o,""),n.push(o.id.toString())}}n.length&&F("Unable to get persistent or non-persistent identifier for the following entitiIds: "+n.join(", "))}return Promise.resolve(i)}(e,t)).values())}async function oe(e,t){const i=te(e);if(i){const e=Array.isArray(t)?t:[t];return await i.getHierarchyChildren(e,!0)}return[]}async function re(e){return await e.findEntitiesByClass("IFCGRID")}e.WebglViewerWrapperEventName=void 0,(Q=e.WebglViewerWrapperEventName||(e.WebglViewerWrapperEventName={})).ActivateGhostMode="ActivateGhostMode",Q.EnableGrids="EnableGrids",Q.EnableObjectLinks="EnableObjectLinks",Q.IconPick="IconPick",Q.PointPick="PointPick",Q.ObjectPick="ObjectPick";function se(e){return{normal:le(e.directionX,e.directionY,e.directionZ),position:de(e.positionX,e.positionY,e.positionZ)}}function ae(e){const t=new n.Vector3(Math.sin(e.pitch)*Math.sin(e.yaw),-Math.sin(e.pitch)*Math.cos(e.yaw),Math.cos(e.pitch));return ce(new n.Vector3(e.targetX+e.distance*t.x,e.targetY+e.distance*t.y,e.targetZ+e.distance*t.z),void 0,{pitch:e.pitch,yaw:e.yaw},e.projectionType,e.viewAngle,e.viewScale)}function ce(e,t,i,o,r,s){return{position:e&&de(e.x,e.y,e.z),quaternion:t?t.clone().multiply((new n.Quaternion).setFromEuler(new n.Euler(0,Math.PI,0))):void 0,rotation:i,direction:void 0,projectionType:o,fieldOfView:r,orthoSize:s}}function le(e,t,i){return new n.Vector3(-e,-t,-i)}function de(e,t,i){return new n.Vector3(e/1e3,t/1e3,i/1e3)}function ue(e){return void 0!==e.r?new n.Color(e.r/255,e.g/255,e.b/255):void 0}function fe(e){return{r:255*e.r,g:255*e.g,b:255*e.b,a:255}}function pe(e){let t=(i=e.text,(new DOMParser).parseFromString(i,"text/html").body.textContent||"").trim();var i;if(""===t)return null;t.length>250&&(t=t.substring(0,250));const{x:n,y:o,z:r}=ve(e.endPick.point),{x:s,y:a,z:c}=ve(e.startPick.point);return{type:"text",positionX:n,positionY:o,positionZ:r,position2X:s,position2Y:a,position2Z:c,color:fe(e.color),text:t,screenSpaceDistance:0,width:0}}function me(e){var t;if(e){if(e.color)return{r:255*e.color.r,g:255*e.color.g,b:255*e.color.b,a:255*(null!==(t=e.opacity)&&void 0!==t?t:1)};if(void 0!==e.opacity)return{a:255*e.opacity}}}function ge(e){function t(e,t){if(2===e.snapType){const{x:i,y:n,z:o}=ve(e.point);return{type:"point",referenceObject:e.model&&e.id?t[e.model.modelId][e.id]:void 0,positionX:i,positionY:n,positionZ:o}}if(1===e.snapType){const{x:t,y:i,z:n}=ve(e.point),{x:o,y:r,z:s}=ve(e.snapLineEnd);return{type:"lineSegment",positionX:t,positionY:i,positionZ:n,position2X:o,position2Y:r,position2Z:s}}if(0===e.snapType){const{x:t,y:i,z:n}=ve(e.point),{x:o,y:r,z:s}=he(e.normal);return{type:"plane",positionX:t,positionY:i,positionZ:n,directionX:o,directionY:r,directionZ:s}}return null}const i=0!==e.axisIndex||0!==e.directionIndex,n=0===e.startPick.snapType,o=1===e.startPick.snapType&&1===e.endPick.snapType,r=1===e.startPick.snapType&&2===e.endPick.snapType,s=i||n||o||r;let a=s?{snapType:2,point:e.getMainLine().start.clone(),model:e.startPick.model,id:e.startPick.id}:e.startPick,c=s?{snapType:2,point:e.getMainLine().end.clone(),model:e.endPick.model,id:e.endPick.id}:e.endPick;if(0===a.snapType&&0===c.snapType){const e=a;a=c,c=e}return new Promise(i=>{var n;(n=e,new Promise(e=>{const t={};Promise.all([n.startPick.model&&n.startPick.id?ne(n.startPick.model.modelId,[n.startPick.id]):Promise.resolve([void 0]),n.endPick.model&&n.endPick.id?ne(n.endPick.model.modelId,[n.endPick.id]):Promise.resolve([void 0])]).then(i=>{n.startPick.model&&n.startPick.id&&(t[n.startPick.model.modelId]={[n.startPick.id]:i[0][0]}),n.endPick.model&&n.endPick.id&&(t[n.endPick.model.modelId]?t[n.endPick.model.modelId][n.endPick.id]=i[1][0]:t[n.endPick.model.modelId]={[n.endPick.id]:i[1][0]}),e(t)})})).then(n=>{i({type:"measure_with_pick",unitType:"Metric",quantityUnit:"millimeter",quantityUnitFormat:"mm",start:t(a,n),end:t(c,n),color:fe(e.color)})})})}function he(e){return{x:-e.x,y:-e.y,z:-e.z}}function ve(e){return{x:1e3*e.x,y:1e3*e.y,z:1e3*e.z}}function ye(e){const{x:t,y:i,z:n}=he(e.normal),{x:o,y:r,z:s}=ve(e.position);return{directionX:t,directionY:i,directionZ:n,positionX:o,positionY:r,positionZ:s}}function we(e){const t=e;let i;return void 0!==t.pitch&&void 0!==t.yaw?i=void 0:t.quaternion?i=(new n.Quaternion).copy(t.quaternion):t.lookAt&&t.upDirection&&(i=(new n.Quaternion).setFromRotationMatrix((new n.Matrix4).lookAt(t.lookAt,t.position,t.upDirection))),be(t)?ce(ve(t.position),i,void 0!==t.pitch?{pitch:t.pitch,yaw:t.yaw}:void 0,t.projectionType,t.fieldOfView,t.orthoSize):function(e){return e&&void 0!==typeof e.targetX||void 0!==typeof e.targetY||void 0!==typeof e.targetZ||void 0!==typeof e.pitch||void 0!==typeof e.yaw||void 0!==typeof e.distance}(e)?ae(e):void 0}function be(e){return e&&void 0!==typeof e.position||void 0!==typeof e.lookAt||void 0!==typeof e.quaternion}var Oe;async function ke(e){let t;if("string"==typeof e){if(t=await async function(e){return new Promise((t,i)=>{const n=new XMLHttpRequest;n.open("GET",e,!0),n.withCredentials=!0,n.responseType="json",n.onload=()=>t(n.response),n.onerror=()=>i("Error loading "+e),n.send()})}(e),!t)throw new Error("Error in fetching the view from JSON file")}else t=e;return Promise.resolve(t)}async function Pe(t){t.projectionType&&await e.webglviewer.camera.setProjectionType(t.projectionType),t.fieldOfView&&(e.webglviewer.camera.fieldOfView=t.fieldOfView),t.orthoSize&&(e.webglviewer.camera.orthoSize=t.orthoSize),t.position&&(e.webglviewer.camera.position=t.position),t.quaternion&&(e.webglviewer.camera.quaternion=t.quaternion),t.rotation&&(e.webglviewer.camera.rotation=t.rotation)}function Ee(i){i&&i.map(se).forEach(i=>{e.webglviewer.tools.get(t.ClipPlaneTool).add(i.position,i.normal,void 0,"view")})}async function Te(t){if(t.markups){const o=await function(e){return new Promise(t=>{const i=e.models.map(e=>te(e)).filter(e=>e),n=e.markups.reduce((e,t)=>{var i,n;return(null===(i=t.start)||void 0===i?void 0:i.referenceObject)&&!e.includes(t.start.referenceObject)&&e.push(t.start.referenceObject),(null===(n=t.end)||void 0===n?void 0:n.referenceObject)&&!e.includes(t.end.referenceObject)&&e.push(t.end.referenceObject),e},[]),o=n.map(e=>new Promise(t=>{Promise.all(i.map(t=>ie(t,[e],void 0))).then(e=>{const n=e.findIndex(e=>!!e[0]);t(n>-1?{objectRuntimeId:e[n][0],modelVersionId:i[n].modelId}:{objectRuntimeId:void 0,modelVersionId:void 0})})}));Promise.all(o).then(e=>{const i=n.reduce((t,i,n)=>(e[n].objectRuntimeId&&e[n].modelVersionId&&(t[i]=e[n]),t),{});t(i)})})}(t);t.markups.forEach(t=>{switch(t.type){case"cloud":r=t,e.webglviewer.tools.get(i.CloudMarkupTool).add({point:de(r.positionX,r.positionY,r.positionZ),normal:le(r.planeA,r.planeB,r.planeC)},r.width/1e3/2,r.height/1e3/2,ue(r.color));break;case"line":!function(t){e.webglviewer.tools.get(i.LineMarkupTool).add({point:de(t.positionX,t.positionY,t.positionZ)},{point:de(t.position2X,t.position2Y,t.position2Z)},ue(t.color))}(t);break;case"arrow":!function(t){e.webglviewer.tools.get(i.ArrowMarkupTool).add({point:de(t.positionX,t.positionY,t.positionZ)},{point:de(t.position2X,t.position2Y,t.position2Z)},ue(t.color))}(t);break;case"text":!function(t){e.webglviewer.tools.get(i.TextMarkupTool).add({point:de(t.position2X,t.position2Y,t.position2Z)},{point:de(t.positionX,t.positionY,t.positionZ)},ue(t.color),t.text)}(t);break;case"redlines":!function(t){const n=[];for(const e of t.lines)n.push(de(e.positionX,e.positionY,e.positionZ)),n.push(de(e.position2X,e.position2Y,e.position2Z));e.webglviewer.tools.get(i.FreelineMarkupTool).add(n,ue(t.color))}(t);break;case"measure_with_pick":!function(t,o){const r=e=>{switch(e.type){case"lineSegment":return{snapType:1,point:de(e.positionX,e.positionY,e.positionZ),snapLineStart:de(e.positionX,e.positionY,e.positionZ),snapLineEnd:de(e.position2X,e.position2Y,e.position2Z)};case"point":return{id:o[e.referenceObject]?o[e.referenceObject].objectRuntimeId:void 0,model:o[e.referenceObject]?te(o[e.referenceObject].modelVersionId):void 0,snapType:2,point:de(e.positionX,e.positionY,e.positionZ)};case"plane":return{snapType:0,point:de(e.positionX,e.positionY,e.positionZ),normal:le(e.directionX,e.directionY,e.directionZ)};default:return null}};let s=r(t.start),a=r(t.end);if(0===s.snapType){const e=s;s=a,a=e,1===a.snapType&&s.point.copy(s.snapLineStart).add(s.snapLineEnd).multiplyScalar(.5)}if(1===s.snapType&&1===a.snapType){const e=s;s=a,a=e;const t=s.snapLineEnd.clone().sub(s.snapLineStart),i=a.snapLineEnd.clone().sub(a.snapLineStart),o=t.dot(i);if(Math.abs(o)<.999){const e=new n.Line3(a.snapLineStart,a.snapLineEnd).closestPointToPoint(s.point,!1,new n.Vector3);s={snapType:2,point:s.point.clone()},a={snapType:2,point:e}}}if(1===s.snapType&&2===a.snapType){const e=s;s=a,a=e}e.webglviewer.tools.get(i.MeasurementTool).add(s,a,ue(t.color))}(t,o);break;case"measure":!function(t){e.webglviewer.tools.get(i.PointMarkupTool).add({point:de(t.positionX,t.positionY,t.positionZ)},ue(t.color))}(t);break;default:throw new Error(`Unknown markup type: '${t.type}'`)}var r})}}async function je(e,t,i,n){const o=t.filter(e=>e.isRecursive).map(e=>e.sourceId),r=t.filter(e=>!e.isRecursive).map(e=>e.sourceId),s=[];s.push(...await ie(i,o,n)),s.push(...await oe(e,s)),s.push(...await ie(i,r,n));const a=[...new Set(s)];return Promise.resolve(a)}async function Ie(e,t,i,n){for(const o of e){i=Se(n,await t.findEntitiesByClass(o.type),o.state,o.color,i)}return i}function Se(e,t,i,n,o){if(t.length<=0)return o;if(void 0!==i&&(function(e){if(e===O.Hidden||e===O.SelectedHidden)return!0;return!1}(i)&&(o.Hidden[e]?o.Hidden[e].push(...t):o.Hidden[e]=t),function(e){if(e===O.Selected||e===O.SelectedVisible)return!0;return!1}(i)&&(o.Selected[e]?o.Selected[e].push(...t):o.Selected[e]=t)),void 0!==n){const i={opacity:n.a/255},r=ue(n);r&&(i.color=r),o.Colored[e]?o.Colored[e].push({material:i,entityIds:t}):o.Colored[e]=[{material:i,entityIds:t}]}return o}function Fe(e){return e===O.Visible||e===O.SelectedVisible}function Ue(e,t){return e&&t?e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a:e===t}async function xe(t,i){const n=await async function(e){return await e.findEntitiesByClass("IFCGRID")}(i);if(t){const o=n.filter(e=>!t.includes(e));o.length>0&&(await i.setVisibility(o,!0),ee(e.WebglViewerWrapperEventName.EnableGrids,!0))}else await i.setVisibility(n,!0),ee(e.WebglViewerWrapperEventName.EnableGrids,!0);return Promise.resolve()}e.ClipPlaneOrigin=void 0,(Oe=e.ClipPlaneOrigin||(e.ClipPlaneOrigin={})).Extension="extension",Oe.View="view",e.addClipPlanes=Ee,e.addIcons=async function(t){t.length&&await e.webglviewer.plugins.get(o.IconsPlugin).add(t)},e.addMarkups=Te,e.clearIcons=async function(){await e.webglviewer.plugins.get(o.IconsPlugin).clear()},e.configure=function(t,i,n){e.webglviewer=t,e.markupPlugin=i,e.trimbimPlugin=n,e.webglviewer.addEventListener("pick",t=>{if(t.detail.modelId===o.PointIconModel.ModelId)for(const i of e.webglviewer.plugins.get(o.IconsPlugin).getIcons())if(i.id===t.detail.id){ee(e.WebglViewerWrapperEventName.IconPick,i);break}ee(e.WebglViewerWrapperEventName.PointPick,{position:U(t.detail.worldPosition)?void 0:t.detail.worldPosition,normal:U(t.detail.normal)?void 0:t.detail.normal}),ee(e.WebglViewerWrapperEventName.ObjectPick,t.detail)})},e.createObjectLinks=async function(t,i){const o=[];for(const r of i){const i=e.webglviewer.getModel(t);if(i){const e=(await i.getBoundingBox(r.entityIds)).getCenter(new n.Vector3);o.push({iconPath:r.icon,id:r.iconId,position:e,size:r.iconSize})}}return o},e.createView=async function(n,o,r,s=300){const a=await(c=await e.webglviewer.screenshot(),l=s,new Promise(e=>{const t=new FileReader;t.readAsDataURL(c),t.onload=()=>{if(!l)return void e(t.result?t.result.toString():"");const i=new Image;i.src=t.result.toString(),i.onload=()=>{const t=document.createElement("canvas");let n=i.width,o=i.height;n>o?n>l&&(o*=l/n,n=l):o>l&&(n*=l/o,o=l),t.width=n,t.height=o;const r=t.getContext("2d");r.drawImage(i,0,0,n,o),e(r.canvas.toDataURL())},i.onerror=()=>e("")},t.onerror=()=>e("")}));var c,l;const d=function(e){return{distance:1e3,projectionType:e.projectionType,targetX:1e3*(e.position.x+e.direction.x),targetY:1e3*(e.position.y+e.direction.y),targetZ:1e3*(e.position.z+e.direction.z),viewAngle:e.fieldOfView,viewScale:e.orthoSize||0,pitch:e.rotation.pitch,yaw:e.rotation.yaw}}({position:e.webglviewer.camera.position,quaternion:e.webglviewer.camera.quaternion,rotation:e.webglviewer.camera.rotation,direction:e.webglviewer.camera.direction,projectionType:e.webglviewer.camera.projectionType,fieldOfView:e.webglviewer.camera.fieldOfView,orthoSize:e.webglviewer.camera.orthoSize}),u=e.webglviewer.tools.get(t.ClipPlaneTool).getClipPlanes().map(ye),f=e.markupPlugin.getMarkups(),p=await async function(t,i){const n=[];for(const i of t){const t=e.webglviewer.selection.get(i),o=te(i),r=await o.getVisibleEntityIds(!1),s=await o.getEntityIdsByPickPriority(2),a=(await o.getCustomMaterialEntityIds()).filter(e=>!s.includes(e)),c=await o.getCustomMaterials(a),l=t&&t.filter(e=>r.includes(e));let d=t,u=r;if(l&&(d=t&&t.filter(e=>!l.includes(e)),u=r.filter(e=>!l.includes(e))),s&&s.length>0&&u.push(...s),a){const e=await ne(i,a);for(let t=0;t<e.length;t++){const r=e[t];n.push({sourceId:r,state:O.Visible,versionId:i,color:me(c[t]),isRecursive:t<a.length&&(await o.getHierarchyChildren([a[t]],!0)).length>0})}}if(d){const e=await ne(i,d);for(let t=0;t<e.length;t++){const r=e[t];n.push({sourceId:r,state:O.Selected,versionId:i,isRecursive:t<d.length&&(await o.getHierarchyChildren([d[t]],!0)).length>0})}}if(u){(await ne(i,u)).forEach(e=>{n.push({sourceId:e,state:O.Hidden,versionId:i})})}if(l){(await ne(i,l)).forEach(e=>{n.push({sourceId:e,state:O.SelectedHidden,versionId:i})})}}return{elementTypes:[],elements:n,ghost:i.ghostMode,isCriticalEnabled:!1,isDocumentsEnabled:!1,isIgnoredEnabled:!1,isNewEnabled:!1,isNotesEnabled:i.notesEnabled,isPendingEnabled:!1,isResolvedEnabled:!1,transparencyLevel:100*e.webglviewer.globalOpacity,transparent:1!==e.webglviewer.globalOpacity,wireframe:!1}}(o,r);let m=f.filter(e=>e.name!==i.MeasurementTool.Name).map(e=>{if(e.name===i.TextMarkupTool.Name)return pe(e);if(e.name===i.ArrowMarkupTool.Name)return function(e){const{x:t,y:i,z:n}=ve(e.startPick.point),{x:o,y:r,z:s}=ve(e.endPick.point);return{type:"arrow",positionX:t,positionY:i,positionZ:n,position2X:o,position2Y:r,position2Z:s,color:fe(e.color)}}(e);if(e.name===i.CloudMarkupTool.Name)return function(e){const{x:t,y:i,z:n}=ve(e.position),{x:o,y:r,z:s}=he(e.normal);var a,c;return{type:"cloud",positionX:t,positionY:i,positionZ:n,planeA:o,planeB:r,planeC:s,planeD:(a=e.normal,c=e.position,a.x*c.x+a.y*c.y+a.z*c.z),width:1e3*e.width*2,height:1e3*e.height*2,color:fe(e.color)}}(e);if(e.name===i.LineMarkupTool.Name)return function(e){const{x:t,y:i,z:n}=ve(e.startPick.point),{x:o,y:r,z:s}=ve(e.endPick.point);return{type:"line",positionX:t,positionY:i,positionZ:n,position2X:o,position2Y:r,position2Z:s,color:fe(e.color)}}(e);if(e.name===i.FreelineMarkupTool.Name)return function(e,t){const i=[];for(let t=0;t<e.points.length-1;t++){const{x:n,y:o,z:r}=ve(e.points[t].clone().applyMatrix4(e.matrixWorld)),{x:s,y:a,z:c}=ve(e.points[t+1].clone().applyMatrix4(e.matrixWorld));i.push({positionX:n,positionY:o,positionZ:r,position2X:s,position2Y:a,position2Z:c})}return{type:"redlines",camera:t,lines:i,color:fe(e.color)}}(e,d);if(e.name===i.PointMarkupTool.Name)return function(e){const{x:t,y:i,z:n}=ve(e.position);return{type:"measure",positionX:t,positionY:i,positionZ:n,position2X:t,position2Y:i,position2Z:n,color:fe(e.color)}}(e);throw new Error("Unknown markup type")});const g=await Promise.all(f.filter(e=>e.name===i.MeasurementTool.Name).map(e=>new Promise(t=>{ge(e).then(e=>{t(e)})})));m=[...m,...g].filter(e=>null!=e);const h={origin:"",camera:d,files:n,imageData:a,markups:m,models:o,presentation:p,sectionPlanes:u};return Promise.resolve(h)},e.emit=ee,e.eventEmitter=K,e.getEntityIds=ie,e.getEntityStatesForElementTypes=Se,e.getGrids=re,e.getPartIdsFromAssemblyId=oe,e.getPersistentIds=ne,e.getView=ke,e.handleGridsVisibility=async function(e,t=!0){const i=await re(e);if(i.length>0){const n=await e.getUntransformedBoundingBoxes(i),o=Math.min(...n.map(e=>e.min.z)),r=n.reduce((e,t,n)=>(Math.abs(t.min.z-o)<Number.EPSILON&&e.push(i[n]),e),[]);r&&r.length>0&&(await e.setVisibility(i.filter(e=>!r.includes(e)),!1),await e.setVisibility(r,t))}return Promise.resolve()},e.identifierBuilder=B,e.loadAPIView=async function(e){let t;t=be(e.camera)?we(e.camera):ae(e.camera),await Pe(t),Ee(e.sectionPlanes)},e.loadViewToWebglViewer=async function(t,i,n,o){var r,s,c;let l=!0;const d=await ke(t),u=ae(d.camera);await Pe(u),await async function(t){if(!t)return;for(const i of Object.keys(t)){const n=e.webglviewer.getModel(i);if(n){const e=t[i];for(const t of e)await n.setLayerVisibility(t,!1)}}}(o);try{Ee(d.sectionPlanes)}catch(e){F("Error while loading clip planes of view.",e),l=!1}try{await Te(d)}catch(e){F("Error while loading markups of view.",e),l=!1}!function(t){var i;const n=(null===(i=t.presentation)||void 0===i?void 0:i.transparencyLevel)?t.presentation.transparencyLevel:100;e.webglviewer.globalOpacity=n/100}(d),ee(e.WebglViewerWrapperEventName.ActivateGhostMode,null===(r=d.presentation)||void 0===r?void 0:r.ghost),ee(e.WebglViewerWrapperEventName.EnableObjectLinks,null===(s=d.presentation)||void 0===s?void 0:s.isNotesEnabled);const f=await async function(t,i,n){var o,r,s,c;const l=function(t,i){const n=new Map;for(let o=0;o<t.files.length;o++){const r=i?i.get(t.files[o]):t.models[o],s=e.webglviewer.getModel(r);s&&n.set(r,[o,r,s])}return n}(i,n);let d={Hidden:{},Selected:{},Colored:{}};try{for(var u,f=a(l);!(u=await f.next()).done;){const e=u.value,[n,[o,r,a]]=e,l=t?t.get(n):void 0;if((null===(s=i.presentation)||void 0===s?void 0:s.elementTypes)&&(d=await Ie(i.presentation.elementTypes,a,d,r)),null===(c=i.presentation)||void 0===c?void 0:c.elements){const e=i.presentation.elements.filter(e=>e.versionId===i.models[o]),t=new Set(e.map(e=>e.state));for(const i of t)if(Fe(i)){const t=e.filter(e=>e.state===i),n=Array.from(new Set(t.map(e=>JSON.stringify(e.color)))).map(e=>e?JSON.parse(e):void 0);for(const e of n){const n=await je(r,t.filter(t=>Ue(e,t.color)),a,l);d=Se(r,n,i,e,d)}}else{const t=await je(r,e.filter(e=>e.state===i),a,l);d=Se(r,t,i,void 0,d)}}await xe(d.Hidden[r],a)}}catch(e){o={error:e}}finally{try{u&&!u.done&&(r=f.return)&&await r.call(f)}finally{if(o)throw o.error}}return d}(i,d,n);return await async function(t,i){for(const i in t.Colored)if(t.Colored.hasOwnProperty(i)){const n=t.Colored[i];for(const t of n)await e.webglviewer.getModel(i).setCustomMaterial(t.entityIds,t.material)}for(const i in t.Selected)t.Selected.hasOwnProperty(i)&&e.webglviewer.selection.set(i,t.Selected[i]);for(const n in t.Hidden)if(t.Hidden.hasOwnProperty(n)){const o=e.webglviewer.getModel(n),r=t.Hidden[n];i?(await o.setCustomMaterial(r,{opacity:.2}),await o.setPickPriority(r,2)):await o.setVisibility(r,!1)}}(f,null===(c=d.presentation)||void 0===c?void 0:c.ghost),l},e.on=function(e,t){K.on(e,t)},e.removeEventListener=function(e,t){K.removeListener(e,t)},e.removeIcons=async function(t){t.length&&await e.webglviewer.plugins.get(o.IconsPlugin).remove(t)},Object.defineProperty(e,"__esModule",{value:!0})}));
