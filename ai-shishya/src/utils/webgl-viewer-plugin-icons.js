define(["exports","three.mjs","./three.mjs"],(function(t,e,i){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function s(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function r(t){return"function"==typeof t}var o=!1,a={Promise:void 0,set useDeprecatedSynchronousErrorHandling(t){t&&(new Error).stack;o=t},get useDeprecatedSynchronousErrorHandling(){return o}};function c(t){setTimeout((function(){throw t}),0)}var h={closed:!0,next:function(t){},error:function(t){if(a.useDeprecatedSynchronousErrorHandling)throw t;c(t)},complete:function(){}},u=function(){return Array.isArray||function(t){return t&&"number"==typeof t.length}}();var l=function(){function t(t){return Error.call(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(t,e){return e+1+") "+t.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t,this}return t.prototype=Object.create(Error.prototype),t}(),p=function(){function t(t){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,t&&(this._ctorUnsubscribe=!0,this._unsubscribe=t)}return t.prototype.unsubscribe=function(){var e;if(!this.closed){var i,n=this,s=n._parentOrParents,o=n._ctorUnsubscribe,a=n._unsubscribe,c=n._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,s instanceof t)s.remove(this);else if(null!==s)for(var h=0;h<s.length;++h){s[h].remove(this)}if(r(a)){o&&(this._unsubscribe=void 0);try{a.call(this)}catch(t){e=t instanceof l?d(t.errors):[t]}}if(u(c)){h=-1;for(var p=c.length;++h<p;){var f=c[h];if(null!==(i=f)&&"object"==typeof i)try{f.unsubscribe()}catch(t){e=e||[],t instanceof l?e=e.concat(d(t.errors)):e.push(t)}}}if(e)throw new l(e)}},t.prototype.add=function(e){var i=e;if(!e)return t.EMPTY;switch(typeof e){case"function":i=new t(e);case"object":if(i===this||i.closed||"function"!=typeof i.unsubscribe)return i;if(this.closed)return i.unsubscribe(),i;if(!(i instanceof t)){var n=i;(i=new t)._subscriptions=[n]}break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}var s=i._parentOrParents;if(null===s)i._parentOrParents=this;else if(s instanceof t){if(s===this)return i;i._parentOrParents=[s,this]}else{if(-1!==s.indexOf(this))return i;s.push(this)}var r=this._subscriptions;return null===r?this._subscriptions=[i]:r.push(i),i},t.prototype.remove=function(t){var e=this._subscriptions;if(e){var i=e.indexOf(t);-1!==i&&e.splice(i,1)}},t.EMPTY=function(t){return t.closed=!0,t}(new t),t}();function d(t){return t.reduce((function(t,e){return t.concat(e instanceof l?e.errors:e)}),[])}var f=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),b=function(t){function e(i,n,s){var r=t.call(this)||this;switch(r.syncErrorValue=null,r.syncErrorThrown=!1,r.syncErrorThrowable=!1,r.isStopped=!1,arguments.length){case 0:r.destination=h;break;case 1:if(!i){r.destination=h;break}if("object"==typeof i){i instanceof e?(r.syncErrorThrowable=i.syncErrorThrowable,r.destination=i,i.add(r)):(r.syncErrorThrowable=!0,r.destination=new g(r,i));break}default:r.syncErrorThrowable=!0,r.destination=new g(r,i,n,s)}return r}return s(e,t),e.prototype[f]=function(){return this},e.create=function(t,i,n){var s=new e(t,i,n);return s.syncErrorThrowable=!1,s},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this))},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){this.destination.error(t),this.unsubscribe()},e.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},e.prototype._unsubscribeAndRecycle=function(){var t=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=t,this},e}(p),g=function(t){function e(e,i,n,s){var o,a=t.call(this)||this;a._parentSubscriber=e;var c=a;return r(i)?o=i:i&&(o=i.next,n=i.error,s=i.complete,i!==h&&(r((c=Object.create(i)).unsubscribe)&&a.add(c.unsubscribe.bind(c)),c.unsubscribe=a.unsubscribe.bind(a))),a._context=c,a._next=o,a._error=n,a._complete=s,a}return s(e,t),e.prototype.next=function(t){if(!this.isStopped&&this._next){var e=this._parentSubscriber;a.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?this.__tryOrSetError(e,this._next,t)&&this.unsubscribe():this.__tryOrUnsub(this._next,t)}},e.prototype.error=function(t){if(!this.isStopped){var e=this._parentSubscriber,i=a.useDeprecatedSynchronousErrorHandling;if(this._error)i&&e.syncErrorThrowable?(this.__tryOrSetError(e,this._error,t),this.unsubscribe()):(this.__tryOrUnsub(this._error,t),this.unsubscribe());else if(e.syncErrorThrowable)i?(e.syncErrorValue=t,e.syncErrorThrown=!0):c(t),this.unsubscribe();else{if(this.unsubscribe(),i)throw t;c(t)}}},e.prototype.complete=function(){var t=this;if(!this.isStopped){var e=this._parentSubscriber;if(this._complete){var i=function(){return t._complete.call(t._context)};a.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?(this.__tryOrSetError(e,i),this.unsubscribe()):(this.__tryOrUnsub(i),this.unsubscribe())}else this.unsubscribe()}},e.prototype.__tryOrUnsub=function(t,e){try{t.call(this._context,e)}catch(t){if(this.unsubscribe(),a.useDeprecatedSynchronousErrorHandling)throw t;c(t)}},e.prototype.__tryOrSetError=function(t,e,i){if(!a.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{e.call(this._context,i)}catch(e){return a.useDeprecatedSynchronousErrorHandling?(t.syncErrorValue=e,t.syncErrorThrown=!0,!0):(c(e),!0)}return!1},e.prototype._unsubscribe=function(){var t=this._parentSubscriber;this._context=null,this._parentSubscriber=null,t.unsubscribe()},e}(b);var y=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function _(t){return t}function m(t){return 0===t.length?_:1===t.length?t[0]:function(e){return t.reduce((function(t,e){return e(t)}),e)}}var v=function(){function t(t){this._isScalar=!1,t&&(this._subscribe=t)}return t.prototype.lift=function(e){var i=new t;return i.source=this,i.operator=e,i},t.prototype.subscribe=function(t,e,i){var n=this.operator,s=function(t,e,i){if(t){if(t instanceof b)return t;if(t[f])return t[f]()}return t||e||i?new b(t,e,i):new b(h)}(t,e,i);if(n?s.add(n.call(s,this.source)):s.add(this.source||a.useDeprecatedSynchronousErrorHandling&&!s.syncErrorThrowable?this._subscribe(s):this._trySubscribe(s)),a.useDeprecatedSynchronousErrorHandling&&s.syncErrorThrowable&&(s.syncErrorThrowable=!1,s.syncErrorThrown))throw s.syncErrorValue;return s},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){a.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),!function(t){for(;t;){var e=t,i=e.closed,n=e.destination,s=e.isStopped;if(i||s)return!1;t=n&&n instanceof b?n:null}return!0}(t)?console.warn(e):t.error(e)}},t.prototype.forEach=function(t,e){var i=this;return new(e=S(e))((function(e,n){var s;s=i.subscribe((function(e){try{t(e)}catch(t){n(t),s&&s.unsubscribe()}}),n,e)}))},t.prototype._subscribe=function(t){var e=this.source;return e&&e.subscribe(t)},t.prototype[y]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return 0===t.length?this:m(t)(this)},t.prototype.toPromise=function(t){var e=this;return new(t=S(t))((function(t,i){var n;e.subscribe((function(t){return n=t}),(function(t){return i(t)}),(function(){return t(n)}))}))},t.create=function(e){return new t(e)},t}();function S(t){if(t||(t=Promise),!t)throw new Error("no Promise impl found");return t}var x=function(){function t(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return t.prototype=Object.create(Error.prototype),t}(),w=function(t){function e(e,i){var n=t.call(this)||this;return n.subject=e,n.subscriber=i,n.closed=!1,n}return s(e,t),e.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var t=this.subject,e=t.observers;if(this.subject=null,e&&0!==e.length&&!t.isStopped&&!t.closed){var i=e.indexOf(this.subscriber);-1!==i&&e.splice(i,1)}}},e}(p),P=function(t){function e(e){var i=t.call(this,e)||this;return i.destination=e,i}return s(e,t),e}(b),z=function(t){function e(){var e=t.call(this)||this;return e.observers=[],e.closed=!1,e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return s(e,t),e.prototype[f]=function(){return new P(this)},e.prototype.lift=function(t){var e=new E(this,this);return e.operator=t,e},e.prototype.next=function(t){if(this.closed)throw new x;if(!this.isStopped)for(var e=this.observers,i=e.length,n=e.slice(),s=0;s<i;s++)n[s].next(t)},e.prototype.error=function(t){if(this.closed)throw new x;this.hasError=!0,this.thrownError=t,this.isStopped=!0;for(var e=this.observers,i=e.length,n=e.slice(),s=0;s<i;s++)n[s].error(t);this.observers.length=0},e.prototype.complete=function(){if(this.closed)throw new x;this.isStopped=!0;for(var t=this.observers,e=t.length,i=t.slice(),n=0;n<e;n++)i[n].complete();this.observers.length=0},e.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},e.prototype._trySubscribe=function(e){if(this.closed)throw new x;return t.prototype._trySubscribe.call(this,e)},e.prototype._subscribe=function(t){if(this.closed)throw new x;return this.hasError?(t.error(this.thrownError),p.EMPTY):this.isStopped?(t.complete(),p.EMPTY):(this.observers.push(t),new w(this,t))},e.prototype.asObservable=function(){var t=new v;return t.source=this,t},e.create=function(t,e){return new E(t,e)},e}(v),E=function(t){function e(e,i){var n=t.call(this)||this;return n.destination=e,n.source=i,n}return s(e,t),e.prototype.next=function(t){var e=this.destination;e&&e.next&&e.next(t)},e.prototype.error=function(t){var e=this.destination;e&&e.error&&this.destination.error(t)},e.prototype.complete=function(){var t=this.destination;t&&t.complete&&this.destination.complete()},e.prototype._subscribe=function(t){return this.source?this.source.subscribe(t):p.EMPTY},e}(z),C=function(t){function e(e){var i=t.call(this)||this;return i._value=e,i}return s(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),e.prototype._subscribe=function(e){var i=t.prototype._subscribe.call(this,e);return i&&!i.closed&&e.next(this._value),i},e.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new x;return this._value},e.prototype.next=function(e){t.prototype.next.call(this,this._value=e)},e}(z);class A{}A.zero=Object.freeze(new e.Vector3(0,0,0)),A.one=Object.freeze(new e.Vector3(1,1,1)),A.up=Object.freeze(new e.Vector3(0,0,1)),A.down=Object.freeze(new e.Vector3(0,0,-1)),A.forward=Object.freeze(new e.Vector3(0,1,0)),A.back=Object.freeze(new e.Vector3(0,-1,0)),A.right=Object.freeze(new e.Vector3(1,0,0)),A.left=Object.freeze(new e.Vector3(-1,0,0));class T extends e.Object3D{constructor(t){super(),super.name=t,this.boundingBox=new C(new e.Box3),this.up.copy(A.up)}get modelId(){return this.name}getBoundingBox(t){return Promise.resolve(this.boundingBox.value)}subscribeToBoundingBox(t){this.boundingBox.subscribe(t)}transform(t){const i=(new e.Matrix4).fromArray(t.elements),n=this.matrixWorld.clone();i.decompose(this.position,this.quaternion,this.scale);const s=i.multiply(n.invert());this.boundingBox.value.applyMatrix4(s),this.updateMatrixWorld(!0),this.boundingBox.next(this.boundingBox.value)}isLoading(){return!1}dispose(){}}class U{constructor(t,i,n){this.camera=t,this.container=i,this.settings=n,this._clusters=[],this.tmpPosition=new e.Vector3,this.tmpScreenPosition=new e.Vector3}get clustersCount(){return this._clustersCount}addPoint(t,e){if(this.tmpPosition.x=t.position.x,this.tmpPosition.y=t.position.y,this.tmpPosition.z=t.position.z,this.tmpScreenPosition.copy(this.tmpPosition),this.tmpPosition.sub(e),this.tmpScreenPosition.project(this.camera),this.tmpScreenPosition.x=(1+this.tmpScreenPosition.x)*this.container.clientWidth*.5,this.tmpScreenPosition.y=(1-this.tmpScreenPosition.y)*this.container.clientHeight*.5,this.tmpScreenPosition.x<0||this.tmpScreenPosition.x>this.container.clientWidth||this.tmpScreenPosition.y<0||this.tmpScreenPosition.y>this.container.clientHeight)return;let i=this.findClosestCluster(this.tmpScreenPosition);i?i.add(t.id,this.tmpPosition,this.tmpScreenPosition):this.positions.length>=3*(this._clustersCount+1)&&(this._clusters.length>this._clustersCount?i=this._clusters[this._clustersCount]:(i=new O(this._clustersCount),this._clusters.push(i)),i.reset(t,this.positions,this.tmpPosition,this.tmpScreenPosition),this._clustersCount++)}findClosestCluster(t){if(0===this._clustersCount)return null;function e(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}let i,n=null;for(let s=0;s<this._clustersCount;s++){const r=this._clusters[s],o=n?e(n.screenPosition,t):999999,a=e(r.screenPosition,t);(o<this.settings.clusterRadius||a<this.settings.clusterRadius)&&(i=a<o&&a<this.settings.clusterRadius?r:n),n=r}return i}fillBadgeAttributes(t,e,i){let n=0;const s=1/i;for(let r=0;r<this.clustersCount;r++){const o=this._clusters[r];if(o.iconsCount>1){const r=3*n;t[r]=o.x,t[r+1]=o.y,t[r+2]=o.z;const a=4*n;e[a]=Math.min(o.iconsCount,i-1)*s,e[a+1]=0,e[a+2]=e[a]+s,e[a+3]=1,n++}}return n}getCluster(t){return this._clusters[t]}reset(t){this._clustersCount=0,this.positions=t}}class O{constructor(t){this.iconsCount=1,this.iconIds=[],this._screenPosition=new e.Vector2,this.index=3*t}get screenPosition(){return this._screenPosition}reset(t,e,i,n){this.positions=e,this.iconsCount=1,this.iconIds=[t.id],this._screenPosition.x=n.x,this._screenPosition.y=n.y,this.x=i.x,this.y=i.y,this.z=i.z,this.mainIcon=t}add(t,e,i){this.x=(this.x*this.iconsCount+e.x)/(this.iconsCount+1),this.y=(this.y*this.iconsCount+e.y)/(this.iconsCount+1),this.z=(this.z*this.iconsCount+e.z)/(this.iconsCount+1),this._screenPosition.x=(this._screenPosition.x*this.iconsCount+i.x)/(this.iconsCount+1),this._screenPosition.y=(this._screenPosition.y*this.iconsCount+i.y)/(this.iconsCount+1),this.iconIds.push(t),this.iconsCount++}set x(t){this.positions[this.index]=t}get x(){return this.positions[this.index]}set y(t){this.positions[this.index+1]=t}get y(){return this.positions[this.index+1]}set z(t){this.positions[this.index+2]=t}get z(){return this.positions[this.index+2]}}function M(t,i,n,s,r){let o,a="index"===i?t.getIndex():t.getAttribute(i);return a&&a.array.length>=n*s&&a.array.length<n*s*2?(a.count=n,a.updateRange.count=n*s,a.needsUpdate=!0):(o=new r(n*s),a=new e.BufferAttribute(o,s),"index"===i?t.setIndex(a):t.setAttribute(i,a)),a}new e.Vector3;class B extends e.Points{constructor(t,i,n,s){super(new e.BufferGeometry,s),this._camera=t,this._container=i,this.pointSize=n,this.sphere=new e.Sphere,this.vec3=new e.Vector3}raycast(t,e){const i=this.geometry,n=this.matrixWorld;if(null===i.boundingSphere&&i.computeBoundingSphere(),this.sphere.copy(i.boundingSphere),this.sphere.applyMatrix4(n),this.sphere.radius+=this._getWorldSize(this.sphere.center.distanceTo(this._camera.position)+this.sphere.radius),!1===t.ray.intersectsSphere(this.sphere))return;const s=this.geometry.attributes.position;for(let i=0,r=s.count;i<r;i++){const r=this.vec3.fromArray(s.array,3*i).applyMatrix4(n);this._raycastPoint(r,i,t,e)}}_getWorldSize(t){return this._camera.getViewWorldSize(t)*this.pointSize/this._container.clientWidth}_raycastPoint(t,e,i,n){const s=this._getWorldSize(t.distanceTo(this._camera.position));if(i.ray.distanceSqToPoint(t)<s*s){const s=i.ray.closestPointToPoint(t,this.vec3),r=i.ray.origin.distanceTo(s);if(r<i.near||r>i.far)return;n.push({distance:r,point:this.vec3.clone(),index:e,face:null,object:this})}}}class j extends e.ShaderMaterial{constructor(t,e){super(t),this.isDepthPeelingMaterial=!0,this._globalUniforms=e,this.origOpacity=t.uniforms.opacity.value,this.origTransparent=t.transparent,delete this.transparent}get transparent(){return this._globalUniforms&&void 0!==this._globalUniforms.globalTransparent?this._globalUniforms.globalTransparent:this.origTransparent}set transparent(t){this.origTransparent=t}updateTransparency(){if(this._globalUniforms){this._globalUniforms.globalOpacity&&(this.uniforms.opacity.value=this.origOpacity*this._globalUniforms.globalOpacity.value);const t=this.origTransparent||void 0!==this._globalUniforms.globalTransparent;this.uniforms.transparent.value=Number(t),this.blending=t?e.NormalBlending:e.NoBlending}}}class I extends j{constructor(t,e){super(t,e),this.isWVMaterial=!0,this.clipping=!0,this.morphTargets=!1,this.lights=!1}setIntersection(t){this.clipIntersection=t,this.needsUpdate=!0}get color(){return this.uniforms.diffuse.value}}class V extends I{constructor(t,i){const n=Object.assign(e.UniformsUtils.clone(e.ShaderLib.points.uniforms),{diffuse:{value:new e.Color(t.color)},map:{type:"t",value:t.map},offset:{value:new e.Vector2},size:{value:t.size},opacity:{value:void 0!==t.opacity?t.opacity:1},transparent:{value:void 0!==t.transparent&&t.transparent}},i),s=Object.assign({uniforms:n,defines:{USE_MAP:!0,USE_SIZEBUFFER:!!t.useSizeBuffer,ALPHA_FORMAT:!(!t.map||t.map.format!==e.AlphaFormat)},vertexShader:"\nuniform float size;\nuniform float pixelRatio;\nuniform vec2 offset;\nuniform vec2 viewSize;\n\n#include <common>\n#include <clipping_planes_pars_vertex>\n\n// vec4(leftUpUV, rightDownUV)\nattribute vec4 pointUv;\nvarying vec4 vUv;\n\n#ifdef USE_SIZEBUFFER\n    // vec4(leftUpXY, rightDownXY) from BillboardGeometryBuilder\n    attribute vec4 pointSize; \n    varying vec4 vPointSize;\n\n    varying float pSize;\n#endif\n\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\n    #ifdef USE_SIZEBUFFER\n        pSize = abs(max(max(-pointSize.x, -pointSize.y), max(pointSize.z, pointSize.w))) * 2.0;\n        vPointSize = pointSize;\n    #else\n        float pSize = size; \n    #endif\n\n    #ifdef USE_SIZEATTENUATION\n\t\tgl_PointSize = viewSize.y * projectionMatrix[1][1] * pSize / gl_Position.w;\n        gl_Position.xy += projectionMatrix[1][1] * offset * vec2(viewSize.y / viewSize.x, 1.0);\n    #else\n\t\tgl_PointSize = pSize * pixelRatio;\n        gl_Position.xy += offset * vec2(viewSize.y / viewSize.x, 1.0) * gl_Position.w;\n    #endif\n    \n    vUv = pointUv;\n    \n    #include <clipping_planes_vertex>\n}",fragmentShader:"\n#include <common>\n#include <map_particle_pars_fragment>\n#include <clipping_planes_pars_fragment>\n#include <depth_peeling_pars_fragment>\n\nuniform vec3 diffuse;\nuniform float opacity;\n\nvarying vec4 vUv; // vec4(leftUpUV, rightDownUV)\n\n#ifdef USE_SIZEBUFFER \n    varying vec4 vPointSize; // vec4(leftUpXY, rightDownXY) from BillboardGeometryBuilder\n    varying float pSize;\n#endif\n\nvoid main() {\n    #include <clipping_planes_fragment>\n    #include <depth_peeling_fragment>\n    \n\tvec4 diffuseColor = vec4(diffuse, opacity);\n\n    #ifdef USE_SIZEBUFFER\n        // Normalising the point coord to [-1,1]^2, then multiplying with the point size to obtain pixel coordinate relative to point center:\n        vec2 pixelCoord = (gl_PointCoord * 2.0 - 1.0) * 0.5 * pSize;\n        \n        // Discarding pixels outsize the defined point size. Since inverted point sizes (such as (-1,1) to (1,-1)) have to be supported, we must compare to the min and max of the axis:\n        if (pixelCoord.x < min(vPointSize.x, vPointSize.z) ||\n            pixelCoord.x > max(vPointSize.x, vPointSize.z) ||\n            pixelCoord.y < min(vPointSize.y, vPointSize.w) ||\n            pixelCoord.y > max(vPointSize.y, vPointSize.w)\n        ) discard;\n        \n        vec2 realSize = vPointSize.zw - vPointSize.xy;\n        vec2 localCoord = (pixelCoord - vPointSize.xy) / realSize;\n        vec2 uv = localCoord * (vUv.zw - vUv.xy) + vUv.xy;\n    #else\n        vec2 uv = gl_PointCoord * (vUv.zw - vUv.xy) + vUv.xy;\n    #endif\n    uv = vec2(uv.x, 1.0 - uv.y);        // Vertical correction\n    \n\tvec4 mapTexel = texture2D(map, uv);\n\t#ifdef ALPHA_FORMAT\n\t    mapTexel.rgb = vec3(1.0);\n\t#endif\n\tdiffuseColor *= mapTexel;\n    \n\t#include <alphatest_fragment>\n\n\tgl_FragColor = diffuseColor;\n}"},t);delete s.color,delete s.map,delete s.size,delete s.sizeAttenuation,delete s.useSizeBuffer,delete s.offset,super(s,i),this._parameters=t,this.offset=t.offset,this.sizeAttenuation=t.sizeAttenuation,this.alphaTest=.001}get isPointsMaterial(){if(!this.sizeAttenuation&&this.offset){const t=this.uniforms.viewSize.value.y;this.uniforms.offset.value.copy(this.offset).multiplyScalar(window.devicePixelRatio/t)}else this.offset&&this._parameters.map.image&&this.uniforms.offset.value.copy(this.offset);return this.updateTransparency(),!1}clone(){const t=new V(this._parameters,this._globalUniforms);return t.sizeAttenuation=this.sizeAttenuation,t}}class D extends e.Object3D{constructor(t,e,i,n,s,r,o,a){super(),this._camera=t,this._container=e,this._renderingManager=i,this.badgeTextureAtlas=n,this.badgeAtlasSize=s,this.iconsAtlas=r,this.iconPaths=o,this.settings=a,this._data=[],this._clusterer=new U(this._camera,this._container,this.settings)}clearData(){this._data=[]}addIconData(t){this._data.push(t)}isEmpty(){return 0===this._data.length}update(){this.icons||this.createIcons(this._data[0]),this.badges||this.createBadges(this._data[0]),this.updateGeometry(this._data)}getGlobalUniformsWithoutOpacity(){const t=Object.assign({},this._renderingManager.uniforms);return delete t.globalOpacity,delete t.globalTransparent,t}createIcons(t){const e=new V({size:t.size,map:this.iconsAtlas,transparent:!0,clippingPlanes:this._renderingManager.clippingPlanes},this.getGlobalUniformsWithoutOpacity());e.depthTest=!1,e.depthWrite=!1;const i=new B(this._camera,this._container,t.size,e);this.add(i),this.icons=i}createBadges(t){const i=new V({size:16,map:this.badgeTextureAtlas,offset:new e.Vector2(0,1.4*t.size),transparent:!0,clippingPlanes:this._renderingManager.clippingPlanes},this.getGlobalUniformsWithoutOpacity());i.depthTest=!1,i.depthWrite=!1;const n=new e.BufferGeometry,s=new e.Points(n,i);this.add(s),this.badges=s}fillIconUVs(t){for(let e=0;e<this._clusterer.clustersCount;e++){const i=this._clusterer.getCluster(e).mainIcon,n=this.iconPaths.indexOf(i.iconPath),s=4*e;t[s]=n/this.iconPaths.length,t[s+1]=0,t[s+2]=(n+1)/this.iconPaths.length,t[s+3]=1}}getCluster(t){return this._clusterer.getCluster(t)}updateGeometry(t){const e=t.length,i=this.icons.geometry,n=M(i,"position",Math.min(t.length,500),3,Float32Array).array,s=this._clusterer;s.reset(n);for(let i=0;i<e;i++)s.addPoint(t[i],this.position);{const t=i.getAttribute("position"),e=M(i,"pointUv",s.clustersCount,4,Float32Array);this.fillIconUVs(e.array),t.count=s.clustersCount,t.updateRange.count=3*s.clustersCount,t.needsUpdate=!0,e.count=s.clustersCount,e.updateRange.count=4*s.clustersCount,e.needsUpdate=!0,i.computeBoundingSphere(),i.computeBoundingBox()}{const t=this.badges.geometry,e=M(t,"position",s.clustersCount,3,Float32Array),i=M(t,"pointUv",s.clustersCount,4,Float32Array),n=s.fillBadgeAttributes(e.array,i.array,this.badgeAtlasSize);e.count=n,e.updateRange.count=3*n,e.needsUpdate=!0,i.count=n,i.updateRange.count=4*n,i.needsUpdate=!0}}}class R extends T{constructor(t,i,n,s,r){super(R.ModelId),this._data=t,this._camera=i,this._container=n,this._renderingManager=s,this._settings=r,this.batchSize=400,this.badgeAtlasSize=11,this.iconSizeInAtlas=128,this.iconsAtlas=new e.Texture,this.canvas2d=document.createElement("canvas"),this.context2d=this.canvas2d.getContext("2d"),this.updatingAtlas=!1,this.vec3=new e.Vector3,this.pick=(()=>t=>{if(0===this.batches.length)return;const e=t.intersectObjects(this.batches.map((t=>t.icons)),!1)[0];if(e){const i=this.batches.find((t=>t.icons===e.object)).getCluster(e.index),n={model:this,id:i.mainIcon.id,childrenIds:i.iconIds,object:null,ray:t.ray,pickPriority:1};return Promise.resolve(Object.assign(n,e))}})(),this.badgeTextureAtlas=this.createBadgeTextureAtlas()}static get ModelId(){return"icons"}get batches(){return this.children}createBadgeTextureAtlas(){const t=64,i=document.createElement("canvas"),n=i.getContext("2d");i.width=t*this.badgeAtlasSize,i.height=t,n.font="51.2px Arial",n.textAlign="center",n.textBaseline="middle";for(let e=0;e<this.badgeAtlasSize;e++)n.fillStyle="white",n.beginPath(),n.rect(t*e,0,t,t),n.fill(),n.lineWidth=6,n.strokeStyle="gray",n.stroke(),n.fillStyle="black",n.fillText(e===this.badgeAtlasSize-1?"•":e.toString(),t*(e+.5),37);const s=new e.Texture(i);return s.needsUpdate=!0,s}update(){if(0===this._data.length)return this.clear(),void this._renderingManager.redraw();for(const t of this.batches)t.clearData();for(const t of this._data){const e=this.vec3.copy(t.position).divideScalar(this.batchSize).round().multiplyScalar(this.batchSize);let i=this.batches.find((t=>t.position.distanceToSquared(e)<.01));i||(i=new D(this._camera,this._container,this._renderingManager,this.badgeTextureAtlas,this.badgeAtlasSize,this.iconsAtlas,this.iconPaths,this._settings),i.position.copy(e),this.add(i)),i.addIconData(t)}for(const t of this.batches)t.isEmpty()?this.remove(t):t.update();this.computeBoundingBox(),this._renderingManager.redraw()}async updateIconTextureAtlas(){const t=Array.from(new Set(this._data.map((t=>t.iconPath))));if(!this.iconPaths||t.find((t=>!this.iconPaths.includes(t)))||this.iconPaths.length!==t.length){if(this.updatingAtlas)throw new Error("Unable to update atlas texture is parallel, make sure you are awaiting the Promise");this.updatingAtlas=!0,this.iconPaths?(this.iconPaths.length=0,this.iconPaths.push(...t)):this.iconPaths=t,this.canvas2d.width=this.iconSizeInAtlas*t.length,this.canvas2d.height=this.iconSizeInAtlas;for(let e=0;e<t.length;e++)this.context2d.drawImage(await this.createImage(t[e]),this.iconSizeInAtlas*e,0,this.iconSizeInAtlas,this.iconSizeInAtlas);this.iconsAtlas.image=this.canvas2d,this.iconsAtlas.needsUpdate=!0,this.updatingAtlas=!1}}async createImage(t){return new Promise((e=>{const i=new Image;i.onload=()=>e(i),i.crossOrigin="anonymous",i.src=t}))}computeBoundingBox(){this.boundingBox.value.makeEmpty();const t=new e.Box3;this.batches.forEach((e=>{e.icons.geometry.boundingBox&&(t.copy(e.icons.geometry.boundingBox).min.add(e.position),t.max.add(e.position),this.boundingBox.value.union(t))})),this.boundingBox.next(this.boundingBox.value)}}function F(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}var H,W,k;Object.assign(F.prototype,{setSize:function(){},render:function(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),F.FullScreenQuad=(H=new i.OrthographicCamera(-1,1,1,-1,0,1),W=new i.PlaneGeometry(2,2),k=function(t){this._mesh=new i.Mesh(W,t)},Object.defineProperty(k.prototype,"material",{get:function(){return this._mesh.material},set:function(t){this._mesh.material=t}}),Object.assign(k.prototype,{dispose:function(){this._mesh.geometry.dispose()},render:function(t){t.render(this._mesh,H)}}),k);var G=function(t,e,n,s,r){F.call(this),this.scene=t,this.camera=e,this.overrideMaterial=n,this.clearColor=s,this.clearAlpha=void 0!==r?r:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new i.Color};G.prototype=Object.assign(Object.create(F.prototype),{constructor:G,render:function(t,e,i){var n,s,r=t.autoClear;t.autoClear=!1,void 0!==this.overrideMaterial&&(s=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(t.getClearColor(this._oldClearColor),n=t.getClearAlpha(),t.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&t.clearDepth(),t.setRenderTarget(this.renderToScreen?null:i),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),t.render(this.scene,this.camera),this.clearColor&&t.setClearColor(this._oldClearColor,n),void 0!==this.overrideMaterial&&(this.scene.overrideMaterial=s),t.autoClear=r}});t.IconsPlugin=class extends class{get version(){return"DEV_BUILD"}}{constructor(t){super(),this._data=[],this.settings=t||{clusterRadius:120}}get name(){return"icons"}set api(t){this._api=t}getIcons(){return this._data}getModel(){return this._model||(this._model=new R(this._data,this._api.camera,this._api.container,this._api.renderingManager,this.settings),this._api.models.add(this._model,!1),this.createRenderPass(),this._api.eventDispatcher.subscribe("navigationend",(()=>this._model.update()))),this._model}createRenderPass(){const t=new e.Scene;t.add(this._model);const i=new G(t,this._api.camera);i.clear=!1,this._api.renderingManager.composer.addPassAfterSelection(i)}async add(t){(t instanceof Array?t:[t]).forEach((t=>this._data.push(t))),await this.getModel().updateIconTextureAtlas(),this.getModel().update()}async remove(t){(t instanceof Array?t:[t]).forEach((t=>this._data.splice(this._data.indexOf(t),1))),await this.getModel().updateIconTextureAtlas(),this.getModel().update()}clear(){this._data.length=0,this.getModel().update()}},t.PointIconModel=R,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map
