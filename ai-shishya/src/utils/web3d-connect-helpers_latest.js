define(["exports","@technology/web3d-plugin-trimbim","@technology/web3d-plugin-markup","@technology/web3d-plugin-icons","@technology/web3d-plugin-trimbim/dist/esnext/Extras/ConnectIdentifier/ConnectIdentifier","@technology/web3d"],(function(e,t,n,i,o,r){"use strict";const s={},a=function(e){if(s[e])return s[e];const t={},n={debug:"#7f8c8d",log:"#2ecc71",warn:"#f39c12",error:"#c0392b"},print=(t,...i)=>{const o=[`%c${e}`,[`border: 1px solid ${n[t]}`,"border-radius: 0.5em",`color: ${n[t]}`,"font-weight: bold","padding: 2px 0.5em"].join(";")];console[t](...o,...i)};for(const e of Object.keys(n))t[e]=(...t)=>print(e,...t);return s[e]=t,t}("App");function logDebug(...e){a.debug(...e)}function logError(...e){a.error(...e)}function logWarning(...e){a.warn(...e)}function defined(...e){return e&&-1===e.findIndex((e=>void 0===e))}new Promise((e=>{}));class c{storage=new Map;itemInsertionCallback;get length(){return this.storage.size}getItem(e){const t=this.storage.get(e);return void 0===t?null:t}setItem(e,t){this.storage.set(e,t),this.itemInsertionCallback&&this.itemInsertionCallback(this.length)}removeItem(e){this.storage.delete(e)}clear(){return this.storage.clear()}key(e){const t=[];for(const e of this.storage.keys())t.push(e);return t[e]}}class d{storageType;_underlyingStorage;constructor(e){this.storageType=e,this._underlyingStorage=this.getStorage()}getStorage(){let e;try{e="undefined"==typeof window?global[this.storageType]:window[this.storageType];const t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch(t){if(22!==t.code&&1014!==t.code&&"QuotaExceededError"!==t.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==t.name||!e||0===e.length){const e="undefined"==typeof window?global:window,t=`emulated${this.storageType}`;return e.hasOwnProperty(t)||(e[t]=new c),e[t]}throw t}}get underlyingStorage(){return this._underlyingStorage}reload(){this._underlyingStorage=this.getStorage()}get length(){return this._underlyingStorage.length}getItem(e){return this._underlyingStorage.getItem(e)}setItem(e,t){return this._underlyingStorage.setItem(e,t)}removeItem(e){return this._underlyingStorage.removeItem(e)}clear(){return this._underlyingStorage.clear()}key(e){return this._underlyingStorage.key(e)}}function cross(e,t){return{x:e.y*t.z-e.z*t.y,y:e.z*t.x-e.x*t.z,z:e.x*t.y-e.y*t.x}}function dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}function magnitude(e){return Math.sqrt(function(e){return dot(e,e)}(e))}function normalize(e){return scale(e,1/magnitude(e))}function scale(e,t){return{x:e.x*t,y:e.y*t,z:e.z*t}}function vector3(e,t,n){return{x:e,y:t,z:n}}var u,l;new d("localStorage"),new d("sessionStorage"),function(e){e[e.AllowNegative=1]="AllowNegative",e[e.AllowIntegers=2]="AllowIntegers",e[e.AllowDecimals=4]="AllowDecimals",e[e.AllowScientific=8]="AllowScientific",e[e.AllowFractions=16]="AllowFractions",e[e.Any=31]="Any"}(u||(u={})),function(e){e[e.Feet=0]="Feet",e[e.Inches=1]="Inches",e[e.FeetInches=2]="FeetInches"}(l||(l={}));class p extends Error{constructor(e,t,n){super(p.formatMessage(e,t)),this.response=e,this.errorMessage=t,this.errorCode=n,Error.captureStackTrace&&Error.captureStackTrace(this,p)}static formatMessage(e,t){return`HTTP ${e.status} (${e.statusText}): ${t}`}}var m={};Object.defineProperty(m,"__esModule",{value:!0});var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},g="undefined"!=typeof window&&void 0!==window.document,v="object"===("undefined"==typeof self?"undefined":f(self))&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,h="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;m.isBrowser=g,m.isWebWorker=v,m.isNode=h,m.isJsDom=function(){return"undefined"!=typeof window&&"nodejs"===window.name||navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")};var __awaiter$3=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i.throw(e))}catch(e){r(e)}}function step(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))};class w{constructor(e,t,n){this.service=e,this.response=t,this.data=n,this.retryCount=0}hasNextPage(){if(this.data&&this.data.hasOwnProperty("next")){return null!==this.data.next}return!1}nextPage(){return __awaiter$3(this,void 0,void 0,(function*(){if(!this.hasNextPage())throw new Error("There is no next page for this response.");const e=this.data.next;return this.service.makeRequest(e)}))}}var y,__awaiter$2=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i.throw(e))}catch(e){r(e)}}function step(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))};function extractEndpoint(e){const t=e.indexOf("//"),n=e.indexOf("/",t+2);return e.substring(0,n)}function delay(e){return new Promise((t=>{setTimeout(t,e)}))}class C{constructor(e){if(this.config=e,this.defaultRetryCount=3,!this.config.serviceUri)throw new Error("The serviceUri is required")}makeRequest(e,t="GET",n,i,o=!0){return __awaiter$2(this,void 0,void 0,(function*(){const r=new Headers({Accept:"application/json"});i&&i.forEach(((e,t)=>{r.append(t,e)}));const s=yield this.request(e,t,n,r,o);if(204!==s.response.status){const e=s.response.headers.get("content-type");if(null!==e&&-1===e.indexOf("application/json"))throw new p(s.response,"Cannot deserialize response body as it is not in a JSON format.");s.data=yield s.response.json()}return s}))}getItemsWithPages(e,t,n,i,o,r=!0){return __awaiter$2(this,void 0,void 0,(function*(){const s=null!=o?o:new Headers;s.has("Range")&&s.delete("Range");const a={start:0,end:n-1};s.append("Range",`items=${a.start}-${a.end}`);let c=yield this.makeRequest(e,"GET",i,s,r);for(;;){const o=this.getRange(c);let d;if(Array.isArray(c.data)&&0!==c.data.length&&o&&o.total&&o.end<o.total-1&&o&&o.total&&(s.delete("Range"),a.start=o.end+1,a.end=Math.min(o.total-1,a.start+n-1),s.append("Range",`items=${a.start}-${a.end}`),d=this.makeRequest(e,"GET",i,s,r)),t(c),!d)break;c=yield d}}))}request(e,t="GET",n,i,o=!0){return __awaiter$2(this,void 0,void 0,(function*(){const r=e.startsWith("http")?e:e.startsWith("/")?extractEndpoint(this.config.serviceUri)+e:this.config.serviceUri+e,s=new Headers;return(i?i.get("Content-Type"):void 0)||void 0===n||s.set("Content-Type","application/json"),i&&i.forEach(((e,t)=>{s.append(t,e)})),this.fetchWithRetry(r,{body:n,headers:s,method:t,redirect:"follow"},o)}))}maxRetries(){return void 0!==this.config.maxRetries?this.config.maxRetries:this.defaultRetryCount}calculateRetryDelay(e){if(0===e)return 0;{const t=100;return Math.random()*(Math.pow(2,e-1)*t)}}retryableError(e){return!!(this.timeoutError(e)||this.networkingError(e)||this.expiredCredentialsError(e)||this.throttledError(e)||e.response.status>=500)}networkingError(e){return"NetworkingError"===e.errorCode}timeoutError(e){return"TimeoutError"===e.errorCode}expiredCredentialsError(e){if(401===e.response.status){const e=this.config.credentials;return e&&"boolean"==typeof e.expired&&(e.expired=!0),!0}return!1}throttledError(e){return 429===e.response.status}fetchWithRetry(e,t,n=!0){return __awaiter$2(this,void 0,void 0,(function*(){const i=this.config.logger,o=new w(this,new Response,void 0);for(;;){const r=this.config.credentials;if(n&&r){if("function"==typeof r.get)try{yield r.get()}catch(e){throw void 0!==i&&this.log(`[TID] Failed to acquire tokens: ${e.message}`),e}r.token&&t.headers.set("Authorization","Bearer "+r.token)}const s=Date.now(),a=yield this.fetch(e,t);if(void 0!==i){const n=(Date.now()-s)/1e3,i=new Date(s).toISOString(),r=t.body?t.body.length:0,c=a.headers.get("content-length"),d=`${i} [TC HTTP] ${t.method} ${e} ${a.status} ${n} ${o.retryCount} ${r} ${c}`;this.log(d)}if(o.response=a,a.ok)return o;{let e;const t=a.headers.get("content-type");if(t&&-1!==t.indexOf("application/json")){const t=yield a.json();e=new p(a,t.message,t.code||t.errorcode)}else{const t=yield a.text();e=new p(a,t)}if(!(o.retryCount+1<this.maxRetries()&&this.retryableError(e)))throw e;{const e=a.headers.get("retry-after"),t=e?1e3*parseInt(e,10):0,n=this.calculateRetryDelay(o.retryCount)+t;yield delay(n),o.retryCount++}}}}))}fetch(e,t){return fetch(e,t)}getRange(e){if(e.response.headers.has("Content-Range"))try{const t=e.response.headers.get("Content-Range").split(" ")[1].split("/"),n=t[0].split("-"),i=Number(n[0]),o=Number(n[1]);return{start:i,end:o,total:Number(t[1])}}catch(e){return}}log(e){return __awaiter$2(this,void 0,void 0,(function*(){const t=this.config.logger;void 0!==t&&("function"==typeof t.log?t.log(e):"function"==typeof t.write&&t.write(e+"\n"))}))}}class T{constructor(e){this.obj=e}get origin(){return this.obj.origin}get isMaster(){return this.obj.isMaster}get location(){return this.obj.location}get tcApi(){return this.obj["tc-api"]}get orgApi(){return this.obj["org-api"]}get psetApi(){return this.obj["pset-api"]}get projectsApi(){return this.obj["projects-api"]}}!function(e){e[e.Selected=1]="Selected",e[e.Hidden=4]="Hidden",e[e.SelectedHidden=5]="SelectedHidden",e[e.Visible=6]="Visible",e[e.SelectedVisible=7]="SelectedVisible",e[e.Highlighted=8]="Highlighted"}(y||(y={}));var __awaiter$1=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i.throw(e))}catch(e){r(e)}}function step(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))};const P="https:",k={};class V extends C{static isFile(e){return"FILE"===e.type}static isFolder(e){return"FOLDER"===e.type}static formatUrlFromOrigin(e,t){return P+e+"/tc/api/2.0/"+t}constructor(e){super(Object.assign(Object.assign({},{serviceUri:"https://app.connect.trimble.com/tc/api/2.0/"}),e))}search(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=[`query=${t.query}`];t.projectId&&n.push(`projectId=${t.projectId}`),t.type&&n.push(`type=${t.type}`),t.startDate&&n.push(`startDate=${t.startDate}`),t.endDate&&n.push(`endDate=${t.endDate}`);let i=t.sort;if(t.sort&&t.sort.length){const e=t.sort[0];-1===[" ","+","-"].indexOf(e)&&(i=" "+i)}i&&n.push(`sort=${i}`);const o=V.formatUrlFromOrigin(e,"search?"+n.join("&")),r=t.range?new Headers({Range:`items=${t.range.start}-${t.range.end}`}):void 0;return yield this.makeRequest(o,"GET",void 0,r)}))}listServers(){return __awaiter$1(this,void 0,void 0,(function*(){const e=yield this.makeRequest("regions");return e.data=e.data.map((e=>new T(e))),e}))}getUserDetails(e){return __awaiter$1(this,void 0,void 0,(function*(){return this.makeRequest(`users/${e}`)}))}listProjects(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,"projects"),n=yield this.makeRequest(t);for(const t of n.data)t.origin=e.origin;return n}))}getProject(e,t){return __awaiter$1(this,void 0,void 0,(function*(){if(!e)throw Error("id is required");const n=t?[t]:(yield this.listServers()).data;for(const t of n)try{const n=V.formatUrlFromOrigin(t.origin,`projects/${e}`),i=yield this.makeRequest(n);if(i)return i.data.origin=t.origin,i}catch(e){}throw Error("Project with id is not found")}))}patchProject(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(t,`projects/${e}`);return this.makeRequest(i,"PATCH",JSON.stringify(n))}))}updateLastVisitedOnProject(e){return __awaiter$1(this,void 0,void 0,(function*(){const t={lastVisitedOn:function(e){let t=e.toISOString();return t=t.substr(0,t.indexOf("."))+"+0000",t}(new Date)};return this.patchProject(e.id,e.origin,t)}))}listProjectMembers(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`projects/${e.id}/users`);return this.makeRequest(t)}))}listProjectFileSystemStructure(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`sync/${e.id}?excludeVersion=true`);return this.makeRequest(t)}))}createUserGroup(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,"groups");return this.makeRequest(n,"POST",JSON.stringify({name:t,projectId:e.id}))}))}removeUserGroup(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`groups/${t}`);return this.request(n,"DELETE")}))}listUserGroups(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`groups?projectId=${e.id}`);return this.makeRequest(t)}))}listUsersInGroup(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`groups/${t}/users`);return this.makeRequest(n)}))}addUsersToGroup(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(e.origin,`groups/${t}/users`),o=JSON.stringify(n.map((e=>({id:e}))));return this.makeRequest(i,"POST",o)}))}removeUsersFromGroup(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(e.origin,`groups/${t}/users`),o=JSON.stringify(n.map((e=>({id:e}))));return this.request(i,"DELETE",o)}))}getUserProjectDetails(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e,"projects/me");return this.makeRequest(t)}))}inviteUserToProject(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(e.origin,`projects/${e.id}/users`);return this.makeRequest(i,"POST",JSON.stringify({email:t,role:n}))}))}removeUserFromProject(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`projects/${e.id}/users/${t}`);return this.request(n,"DELETE")}))}listUsersByCompanyId(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e,`companies/${t}/users`);return this.makeRequest(n)}))}getProjectSettings(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`projects/${e.id}/settings`);return this.makeRequest(t)}))}putProjectSettings(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`projects/${e.id}/settings`);return this.request(n,"PATCH",JSON.stringify(t))}))}listFolderEntries(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=e.rootId||e.id,n=V.formatUrlFromOrigin(e.origin,`folders/${t}/items`),i=yield this.makeRequest(n);for(const t of i.data)t.origin=e.origin;return i.data.sort(((e,t)=>"FOLDER"===e.type&&"FILE"===t.type?-1:"FILE"===e.type&&"FOLDER"===t.type?1:e.name.localeCompare(t.name))),i}))}getFileStatus(e,t,n,i){return __awaiter$1(this,void 0,void 0,(function*(){let o=V.formatUrlFromOrigin(e.origin,`files/${t}/status`);const r=[];return n&&r.push(`versionId=${n}`),i&&r.push(`format=${i}`),r.length>0&&(o+="?"+r.join("&")),this.makeRequest(o)}))}getProjectSyncStatus(e,t){return __awaiter$1(this,void 0,void 0,(function*(){let n=V.formatUrlFromOrigin(e.origin,`projects/${e.id}/status`);return void 0!==t&&(n+=`?encode=${t}`),this.makeRequest(n)}))}getProjectSyncObjects(e,t,n,i){return __awaiter$1(this,void 0,void 0,(function*(){let o=V.formatUrlFromOrigin(e.origin,`projects/${e.id}/objects`);const r=[`status=${t}`];return n&&r.push(`types=${n}`),void 0!==i&&r.push(`combineStreams=${i}`),o+="?"+r.join("&"),this.makeRequest(o)}))}getFile(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){let i=V.formatUrlFromOrigin(e.origin,`files/${t}`);const o=[];n&&o.push(`versionId=${n}`),o.length>0&&(i+="?"+o.join("&"));const r=yield this.makeRequest(i);return r.data.origin=e.origin,r}))}getFileVersions(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`files/${t}/versions`),i=yield this.makeRequest(n);return i.data.forEach((t=>t.origin=e.origin)),i}))}getFileVersionsWithPages(e,t,n,i=1e3){return __awaiter$1(this,void 0,void 0,(function*(){const o=V.formatUrlFromOrigin(e.origin,`files/${t}/versions`);yield this.getItemsWithPages(o,(t=>{t.data.forEach((t=>t.origin=e.origin)),n(t)}),i)}))}updateFile(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`files/${t.id}`),i=yield this.makeRequest(n,"PATCH",JSON.stringify(t,((e,t)=>excludeProperty("id",e,t))));return i.data.origin=e.origin,i}))}getFolder(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`folders/${t}`),i=yield this.makeRequest(n);return i.data.origin=e.origin,i}))}getFileDownloadUrl(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){let i=V.formatUrlFromOrigin(e.origin,`files/fs/${e.id}/downloadurl`);const o=[];return t&&o.push(`versionId=${t}`),n&&o.push(`format=${n}`),o.length>0&&(i+="?"+o.join("&")),this.makeRequest(i)}))}uploadFileContent(e,t,n,i){return __awaiter$1(this,void 0,void 0,(function*(){const o=V.formatUrlFromOrigin(e.origin,"files/fs/initiate"),r=V.formatUrlFromOrigin(e.origin,"files/fs/commit"),s=t.map((e=>__awaiter$1(this,void 0,void 0,(function*(){const t=JSON.stringify({parentId:n,parentType:i,name:e.name}),s=(yield this.makeRequest(o,"POST",t)).data;yield fetch(s.uploadURL,{method:"PUT",body:e});return yield this.makeRequest(r,"POST",JSON.stringify({uploadId:s.uploadId}))})))),a=yield Promise.all(s);return a.forEach((t=>t.data.origin=e.origin)),a}))}assimilateFile(e,t,n="TRB"){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(e.origin,`files/${t.id}/process`),o=JSON.stringify({format:n,versionId:t.versionId});return this.request(i,"POST",o)}))}putPresentationFileContent(e,t,n,i){return __awaiter$1(this,void 0,void 0,(function*(){const o=new FormData;o.append("file",e,e.name);const r=V.formatUrlFromOrigin(t.origin,`files/representation?fileId=${t.id}&versionId=${i||t.versionId}&format=${n}`);return this.request(r,"POST",o,new Headers({"Content-Type":"multipart/form-data"}))}))}getImage(e,t){return __awaiter$1(this,void 0,void 0,(function*(){let n=t;const i=t.startsWith("/tc/static/")||t.startsWith("/tc/ng-static/")||t.startsWith("/assets/img/");if(t.startsWith("/")&&(n=(!i&&e&&P+e.origin||extractEndpoint(this.config.serviceUri))+t),n in k)return k[n];if(i)return k[n]=n;{const e=yield this.request(n),t=yield e.response.blob();return k[n]=URL.createObjectURL(t)}}))}getPlacement(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`files/${e.id}/alignment`);if(t)try{const e=yield this.makeRequest(`${n}?versionId=${t}`,"GET");if(null==e?void 0:e.data)return e}catch(e){}return this.makeRequest(n,"GET")}))}putPlacement(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){let i="";n&&(i=`?versionId=${n}`);const o=V.formatUrlFromOrigin(e.origin,`files/${e.id}/alignment${i}`);return this.makeRequest(o,"PUT",JSON.stringify(t))}))}listToDos(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`todos?projectId=${e.id}`),n=yield this.makeRequest(t);for(const t of n.data)t.origin=e.origin;return n}))}getToDo(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`todos/${t}`),i=yield this.makeRequest(n);if(i.data.origin=e.origin,i.data.projectId!==e.id)throw new Error("Item belongs to other project");return i}))}createToDo(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,"todos"),i=yield this.makeRequest(n,"POST",JSON.stringify(t,excludeOrigin));return i.data.origin=e.origin,i}))}updateToDo(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`todos/${t.id}`),i=yield this.makeRequest(n,"PATCH",JSON.stringify(t,excludeOrigin));return i.data.origin=e.origin,i}))}removeToDo(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`todos/${t}`);return this.request(n,"DELETE")}))}listToDoComments(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`comments?projectId=${e.projectId}&objectId=${e.id}&objectType=TODO`),n=yield this.makeRequest(t);for(const t of n.data)t.origin=e.origin;return n}))}listComments(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(e.origin,`comments?projectId=${e.id}&objectId=${t}&objectType=${n}`),o=yield this.makeRequest(i);for(const t of o.data)t.origin=e.origin;return o}))}listAttachments(e,t,n,i){return __awaiter$1(this,void 0,void 0,(function*(){const o="TODO"===i?"todos":"comments",r=V.formatUrlFromOrigin(e,`${o}/${n}/attachments?projectId=${t}`),s=yield this.makeRequest(r);for(const t of s.data)t.origin=e;return s}))}listToDoAttachments(e){return __awaiter$1(this,void 0,void 0,(function*(){return this.listAttachments(e.origin,e.projectId,e.id,"TODO")}))}addAttachmentsToEntity(e,t,n,i){return __awaiter$1(this,void 0,void 0,(function*(){const o="TODO"===n.type?"todos":"comments",r=V.formatUrlFromOrigin(e,`${o}/${n.id}/attachments?projectId=${t}`),s=[];i.forEach((e=>{const t="URL"===e.type?{type:e.type,url:e.id,urlName:e.urlName||""}:{type:e.type,id:e.id,embedded:e.embedded||!1};s.push(t)}));const a=JSON.stringify(s),c=yield this.makeRequest(r,"POST",a);return c.data.origin=e,c}))}attachViewToTodo(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`todos/${e.id}/attachments?projectId=${e.projectId}`),i=yield this.makeRequest(n,"POST",JSON.stringify([{type:"VIEW",id:t.id}]));return i.data.origin=e.origin,i}))}removeAttachment(e,t,n,i,o,r){return __awaiter$1(this,void 0,void 0,(function*(){const s="TODO"===i?"todos":"comments",a=V.formatUrlFromOrigin(e,`${s}/${n}/attachments?projectId=${t}`);return this.request(a,"DELETE",JSON.stringify([{id:o,type:r}]))}))}createComment(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,"comments"),i=yield this.makeRequest(n,"POST",JSON.stringify(t));return i.data.origin=e.origin,i}))}updateComment(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`comments/${e.id}`),n=yield this.makeRequest(t,"PATCH",JSON.stringify({description:e.description}));return n.data.origin=e.origin,n}))}deleteComment(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`comments/${t}`);return this.request(n,"DELETE")}))}list2DViews(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`views2d?projectId=${e.id}`),n=yield this.makeRequest(t);for(const t of n.data)t.origin=e.origin;return n}))}get2DView(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`views2d/${t}`),i=yield this.makeRequest(n);if(i.data.origin=e.origin,i.data.projectId!==e.id)throw new Error("Item belongs to different project");return i}))}create2DView(e,t){return __awaiter$1(this,void 0,void 0,(function*(){""===t.description&&(t.description=void 0);const n=V.formatUrlFromOrigin(e.origin,"views2d"),i=yield this.makeRequest(n,"POST",JSON.stringify(t,excludeOrigin));return i.data.origin=e.origin,i}))}update2DView(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`views2d/${t.id}`),i=yield this.makeRequest(n,"PATCH",JSON.stringify(t,excludeOrigin));return i.data.origin=e.origin,i}))}remove2DView(e,t,n=!1){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(e.origin,`views2d/${t}?force=${n}`);return this.request(i,"DELETE")}))}listViews(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`views?projectId=${e.id}`),n=yield this.makeRequest(t);for(const t of n.data)t.origin=e.origin;return n}))}getView(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`views/${t}`),i=yield this.makeRequest(n);if(i.data.origin=e.origin,i.data.projectId!==e.id)throw new Error("Item belongs to different project");return i}))}createView(e,t){return __awaiter$1(this,void 0,void 0,(function*(){""===t.description&&(t.description=void 0);const n=V.formatUrlFromOrigin(e.origin,"views"),i=yield this.makeRequest(n,"POST",JSON.stringify(t,excludeOrigin));return i.data.origin=e.origin,i}))}updateView(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`views/${t.id}`),i=yield this.makeRequest(n,"PATCH",JSON.stringify(t,excludeOrigin));return i.data.origin=e.origin,i}))}removeView(e,t,n=!1){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(e.origin,`views/${t}?force=${n}`);return this.request(i,"DELETE")}))}createViewGroup(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(e.origin,"viewgroups"),o=yield this.makeRequest(i,"POST",JSON.stringify({projectId:e.id,name:t,views:n}));return o.data.origin=e.origin,o}))}removeViewGroup(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`viewgroups/${t}`);return this.request(n,"DELETE")}))}updateViewGroup(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`viewgroups/${t.id}`),i=yield this.makeRequest(n,"PATCH",JSON.stringify({name:t.name,views:t.views}));return i.data.origin=e.origin,i}))}listViewGroups(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`viewgroups?projectId=${e.id}`),n=yield this.makeRequest(t);for(const t of n.data)t.origin=e.origin;return n}))}listTags(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`tags?projectId=${e.id}`),n=yield this.makeRequest(t);for(const t of n.data)t.origin=e.origin;return n}))}createTag(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,"tags"),i=yield this.makeRequest(n,"POST",JSON.stringify(t,excludeOrigin));return i.data.origin=e.origin,i}))}addObjectToTag(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(e.origin,`tags/${e.id}/objects`);return this.request(i,"POST",JSON.stringify([{id:t,objectType:n}]))}))}removeObjectFromTag(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(e.origin,`tags/${e.id}/objects`);return this.request(i,"DELETE",JSON.stringify([{id:t,objectType:n}]))}))}listTagsInObject(e,t,n){return __awaiter$1(this,void 0,void 0,(function*(){const i=V.formatUrlFromOrigin(e.origin,`tags?objectId=${t}&objectType=${n}&projectId=${e.id}`),o=yield this.makeRequest(i);for(const t of o.data)t.origin=e.origin;return o}))}getLinksByFile(e,t,n,i,o=!1,r=!1){return __awaiter$1(this,void 0,void 0,(function*(){let s=`objectlink?id=${t}`;s+=void 0!==n?`&versionId=${n}`:"",s+=void 0!==i?`&sourceId=${i}`:"",s+=`&includeDeleted=${o}`,s+=`&full=${r}&detail=${r}`;const a=V.formatUrlFromOrigin(e.origin,s);return this.makeRequest(a,"GET")}))}getLinksByEntity(e,t,n,i=!1){return __awaiter$1(this,void 0,void 0,(function*(){const o="URL"===n?encodeURIComponent(t):t,r=V.formatUrlFromOrigin(e.origin,`objectlink/target?projectId=${e.id}&type=${n}&id=${o}&includeDeleted=${i}`);return this.makeRequest(r)}))}createObjectLink(e,t,n,i,o,r,s){return __awaiter$1(this,void 0,void 0,(function*(){const a=i.map((e=>({sourceId:e,type:"BIMOBJECT"}))),c={source:{id:t,versionId:n,data:a},target:{id:o,type:r}};"URL"===r&&(c.name=s);const d=V.formatUrlFromOrigin(e.origin,"objectlink");return this.makeRequest(d,"POST",JSON.stringify(c))}))}updateObjectLink(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`objectlink/${t.id}`);return this.makeRequest(n,"PATCH",JSON.stringify(t))}))}deleteObjectLink(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`objectlink/${t}`);return this.request(n,"DELETE")}))}listClashSets(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=V.formatUrlFromOrigin(e.origin,`clashsets?projectId=${e.id}`),n=yield this.makeRequest(t);return n.data.forEach((t=>t.origin=e.origin)),n}))}getClashSetDetails(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`clashsets/${t}`),i=yield this.makeRequest(n);return i.data.origin=e.origin,i}))}createClashSet(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,"clashsets"),i=yield this.makeRequest(n,"POST",JSON.stringify(t,excludeOrigin));return i.data.origin=e.origin,i}))}updateClashSet(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`clashsets/${t.id}`),i=yield this.makeRequest(n,"PATCH",JSON.stringify(t,excludeOrigin));return i.data.origin=e.origin,i}))}deleteClashSet(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`clashsets/${t}`);return this.request(n,"DELETE")}))}getClashItems(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e.origin,`clashsets/${t}/items`),i=yield this.makeRequest(n);return i.data.forEach((t=>t.origin=e.origin)),i}))}getClashItemsWithPages(e,t,n,i=1e3){return __awaiter$1(this,void 0,void 0,(function*(){const o=V.formatUrlFromOrigin(e.origin,`clashsets/${t}/items`);yield this.getItemsWithPages(o,(t=>{t.data.forEach((t=>t.origin=e.origin)),n(t)}),i)}))}getShare(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const n=V.formatUrlFromOrigin(e,`shares/token/${t}`),i=yield this.makeRequest(n);return i.data.origin=e,i}))}}function excludeOrigin(e,t){return excludeProperty("origin",e,t)}function excludeProperty(e,t,n){return t===e?void 0:n}new V;var __awaiter=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i.throw(e))}catch(e){r(e)}}function step(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))};new class extends C{constructor(e){super(Object.assign(Object.assign({},{serviceUri:"https://user-api.connect.trimble.com/v1/"}),e))}createUserProperty(e){return __awaiter(this,void 0,void 0,(function*(){const t=`users/${e.tidUuid}/properties`;return this.makeRequest(t,"PUT",JSON.stringify(e))}))}getUserProperties(e){return __awaiter(this,void 0,void 0,(function*(){const t=`users/${e}/properties/`;return this.makeRequest(t)}))}getUserProperty(e,t){return __awaiter(this,void 0,void 0,(function*(){const n=`users/${t}/properties/${e}`;return this.makeRequest(n)}))}updateUserProperty(e){return __awaiter(this,void 0,void 0,(function*(){const t=`users/${e.tidUuid}/properties`;return this.makeRequest(t,"PUT",JSON.stringify(e))}))}deleteUserProperty(e,t){return __awaiter(this,void 0,void 0,(function*(){const n=`users/${t}/properties/${e}`;return this.request(n,"DELETE")}))}};var b,E={exports:{}},O="object"==typeof Reflect?Reflect:null,M=O&&"function"==typeof O.apply?O.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};b=O&&"function"==typeof O.ownKeys?O.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var I=Number.isNaN||function(e){return e!=e};function EventEmitter(){EventEmitter.init.call(this)}E.exports=EventEmitter,E.exports.once=function(e,t){return new Promise((function(n,i){function errorListener(n){e.removeListener(t,resolver),i(n)}function resolver(){"function"==typeof e.removeListener&&e.removeListener("error",errorListener),n([].slice.call(arguments))}eventTargetAgnosticAddListener(e,t,resolver,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&eventTargetAgnosticAddListener(e,"error",t,n)}(e,errorListener,{once:!0})}))},EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._eventsCount=0,EventEmitter.prototype._maxListeners=void 0;var j=10;function checkListener(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function _getMaxListeners(e){return void 0===e._maxListeners?EventEmitter.defaultMaxListeners:e._maxListeners}function _addListener(e,t,n,i){var o,r,s,a;if(checkListener(n),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),r=e._events),s=r[t]),void 0===s)s=r[t]=n,++e._eventsCount;else if("function"==typeof s?s=r[t]=i?[n,s]:[s,n]:i?s.unshift(n):s.push(n),(o=_getMaxListeners(e))>0&&s.length>o&&!s.warned){s.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=s.length,a=c,console&&console.warn&&console.warn(a)}return e}function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(e,t,n){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},o=onceWrapper.bind(i);return o.listener=n,i.wrapFn=o,o}function _listeners(e,t,n){var i=e._events;if(void 0===i)return[];var o=i[t];return void 0===o?[]:"function"==typeof o?n?[o.listener||o]:[o]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(o):arrayClone(o,o.length)}function listenerCount(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function arrayClone(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}function eventTargetAgnosticAddListener(e,t,n,i){if("function"==typeof e.on)i.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function wrapListener(o){i.once&&e.removeEventListener(t,wrapListener),n(o)}))}}Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return j},set:function(e){if("number"!=typeof e||e<0||I(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");j=e}}),EventEmitter.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||I(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},EventEmitter.prototype.getMaxListeners=function(){return _getMaxListeners(this)},EventEmitter.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i="error"===e,o=this._events;if(void 0!==o)i=i&&void 0===o.error;else if(!i)return!1;if(i){var r;if(t.length>0&&(r=t[0]),r instanceof Error)throw r;var s=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw s.context=r,s}var a=o[e];if(void 0===a)return!1;if("function"==typeof a)M(a,this,t);else{var c=a.length,d=arrayClone(a,c);for(n=0;n<c;++n)M(d[n],this,t)}return!0},EventEmitter.prototype.addListener=function(e,t){return _addListener(this,e,t,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(e,t){return _addListener(this,e,t,!0)},EventEmitter.prototype.once=function(e,t){return checkListener(t),this.on(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.prependOnceListener=function(e,t){return checkListener(t),this.prependListener(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.removeListener=function(e,t){var n,i,o,r,s;if(checkListener(t),void 0===(i=this._events))return this;if(void 0===(n=i[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(o=-1,r=n.length-1;r>=0;r--)if(n[r]===t||n[r].listener===t){s=n[r].listener,o=r;break}if(o<0)return this;0===o?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,o),1===n.length&&(i[e]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",e,s||t)}return this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function(e){var t,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var o,r=Object.keys(n);for(i=0;i<r.length;++i)"removeListener"!==(o=r[i])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},EventEmitter.prototype.listeners=function(e){return _listeners(this,e,!0)},EventEmitter.prototype.rawListeners=function(e){return _listeners(this,e,!1)},EventEmitter.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):listenerCount.call(e,t)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?b(this._events):[]},e.web3DViewer=void 0,e.markupPlugin=void 0,e.trimbimPlugin=void 0;const S=new o.ConnectIdentifierBuilder,D=new E.exports.EventEmitter;var x;function emit(e,t){D.emit(e,t,!1)}function getTrimbimModel(n){return e.web3DViewer.getModel(n,t.TrimbimModel)}function createCameraData(){return{position:e.web3DViewer.camera.position,quaternion:e.web3DViewer.camera.quaternion,rotation:quaternionToRotation(e.web3DViewer.camera.quaternion),direction:e.web3DViewer.camera.direction,projectionType:e.web3DViewer.camera.projectionType,fieldOfView:e.web3DViewer.camera.fieldOfView,orthoSize:e.web3DViewer.camera.orthoSize}}function rotationToQuaternion(e){let t=e.yaw;Math.abs(e.pitch-Math.PI)<.001&&(t+=Math.PI);const n=(new r.Euler).set(e.pitch,0,t,"YZX");return(new r.Quaternion).setFromEuler(n)}function quaternionToRotation(e){const t=new r.Vector3(0,0,-1).applyQuaternion(e),n=Math.PI-Math.atan2(Math.sqrt(t.x*t.x+t.y*t.y),t.z);Math.abs(t.z)>.9999&&t.set(0,1,0).applyQuaternion(e);return{pitch:n,yaw:-Math.atan2(t.x,t.y)}}async function getEntityIds(e,t,n,i=!1){t=t.filter((e=>void 0!==e));const o=[];if(n)for(const e of t){const t=n.tryGetEntityFromPersistentIdentifier(e);if(void 0!==t)o.push(t);else{const t=n.tryGetEntityFromNonPersistentIdentifier(e);if(t.length)if(t.length>1){const n=t.filter((e=>o.indexOf(e)<0));o.push((n.length?n:t)[0]),i||logDebug(`Multiple entityIds [${t.join(", ")}] were found for identifier: '${e}'.`)}else o.push(t[0]);else o.push(void 0),i||logWarning(`No entityId has been found for identifier: '${e}'.`)}}else e&&o.push(...await e.guidsToEntityIds(t));return Promise.resolve(o)}async function getPersistentIds(e,t){return Array.from((await async function(e,t){const n=new Map,i=[],o=getTrimbimModel(e);if(o){let r=[],s=[];try{r=await o.getEntities(t);getTrimbimModel(e)&&(s=await o.getBoundingBoxesForConnectIdentifier(t))}catch(e){logError(e)}for(let e=0;e<r.length;e++){const t=r[e];try{let i=S.tryGetPersistentIdentifier(t);void 0===i&&(i=S.tryGetNonPersistentIdentifier(t,s[e])),n.set(t,i)}catch(e){n.set(t,""),i.push(t.id.toString())}}i.length&&logError(`Unable to get persistent or non-persistent identifier for the following entitiIds: ${i.join(", ")}`)}return Promise.resolve(n)}(e,t)).values())}async function getGrids(e){return await e.findEntitiesByClass("IFCGRID")}e.Web3DWrapperEventName=void 0,(x=e.Web3DWrapperEventName||(e.Web3DWrapperEventName={})).ActivateGhostMode="ActivateGhostMode",x.EnableAnnotations="EnableAnnotations",x.EnableClipPlanes="EnableClipPlanes",x.EnableGrids="EnableGrids",x.EnableObjectLinks="EnableObjectLinks",x.IconPick="IconPick",x.ObjectPick="ObjectPick";function addConnectCloudMarkupToViewer(t){e.web3DViewer.tools.get(n.CloudMarkupTool).add({point:convertConnectPointToViewerPoint(t.positionX,t.positionY,t.positionZ),normal:convertConnectDirectionToViewerDirection(t.planeA,t.planeB,t.planeC)},t.width/1e3/2,t.height/1e3/2,convertConnectColorToViewerColor(t.color))}function convertConnectSectionPlaneToViewerClipPlane(e){return{normal:convertConnectDirectionToViewerDirection(e.directionX,e.directionY,e.directionZ),position:convertConnectPointToViewerPoint(e.positionX,e.positionY,e.positionZ)}}function addConnectLineMarkupToViewer(t){return e.web3DViewer.tools.get(n.LineMarkupTool).add({point:convertConnectPointToViewerPoint(t.positionX,t.positionY,t.positionZ)},{point:convertConnectPointToViewerPoint(t.position2X,t.position2Y,t.position2Z)},convertConnectColorToViewerColor(t.color))}function addConnectArrowMarkupToViewer(t){return e.web3DViewer.tools.get(n.ArrowMarkupTool).add({point:convertConnectPointToViewerPoint(t.positionX,t.positionY,t.positionZ)},{point:convertConnectPointToViewerPoint(t.position2X,t.position2Y,t.position2Z)},convertConnectColorToViewerColor(t.color))}function addConnectTextMarkupToViewer(t){e.web3DViewer.tools.get(n.TextMarkupTool).add({point:convertConnectPointToViewerPoint(t.position2X,t.position2Y,t.position2Z)},{point:convertConnectPointToViewerPoint(t.positionX,t.positionY,t.positionZ)},convertConnectColorToViewerColor(t.color),t.text)}function addConnectFreelineMarkupToViewer(t){const i=[];for(const e of t.lines)i.push(convertConnectPointToViewerPoint(e.positionX,e.positionY,e.positionZ)),i.push(convertConnectPointToViewerPoint(e.position2X,e.position2Y,e.position2Z));e.web3DViewer.tools.get(n.FreelineMarkupTool).add(i,convertConnectColorToViewerColor(t.color))}function addConnectSinglePointMeasurementToViewer(t){e.web3DViewer.tools.get(n.PointMarkupTool).add({point:convertConnectPointToViewerPoint(t.positionX,t.positionY,t.positionZ)},convertConnectColorToViewerColor(t.color))}function convertConnectPick(e,t){switch(e.type){case"line":case"lineSegment":return{snapType:1,point:convertConnectPointToViewerPoint(e.positionX,e.positionY,e.positionZ),snapLineStart:convertConnectPointToViewerPoint(e.positionX,e.positionY,e.positionZ),snapLineEnd:convertConnectPointToViewerPoint(e.position2X,e.position2Y,e.position2Z)};case"point":return{id:t[e.referenceObject]?t[e.referenceObject].objectRuntimeId:void 0,model:t[e.referenceObject]?getTrimbimModel(t[e.referenceObject].modelVersionId):void 0,snapType:2,point:convertConnectPointToViewerPoint(e.positionX,e.positionY,e.positionZ)};case"plane":return{snapType:0,point:convertConnectPointToViewerPoint(e.positionX,e.positionY,e.positionZ),normal:convertConnectDirectionToViewerDirection(e.directionX,e.directionY,e.directionZ)};default:return null}}function addConnectMeasurementMarkupToViewer(t,i){let o=convertConnectPick(t.start,i),s=convertConnectPick(t.end,i);if(0===o.snapType){const e=o;o=s,s=e,1===s.snapType&&o.point.copy(o.snapLineStart).add(o.snapLineEnd).multiplyScalar(.5)}if(1===o.snapType&&1===s.snapType){const e=o;o=s,s=e;const t=o.snapLineEnd.clone().sub(o.snapLineStart),n=s.snapLineEnd.clone().sub(s.snapLineStart),i=t.dot(n);if(Math.abs(i)<.999){const e=new r.Line3(s.snapLineStart,s.snapLineEnd).closestPointToPoint(o.point,!1,new r.Vector3);o={snapType:2,point:o.point.clone()},s={snapType:2,point:e}}}if(1===o.snapType&&2===s.snapType){const e=o;o=s,s=e}return e.web3DViewer.tools.get(n.MeasurementTool).add(o,s,convertConnectColorToViewerColor(t.color))}function addConnectAngleMeasurementToViewer(t,i){let o,r,s;return isNaN(t.positionX)||isNaN(t.positionY)||isNaN(t.positionZ)?(o=convertConnectPick(t.start,i),r=convertConnectPick(t.end,i)):(o=convertConnectPick({type:"point",positionX:t.positionX,positionY:t.positionY,positionZ:t.positionZ,referenceObject:t.referenceObject},i),s=convertConnectPick(t.start,i),r=convertConnectPick(t.end,i)),e.web3DViewer.tools.get(n.AngleMeasurementTool).add(o,r,s,convertConnectColorToViewerColor(t.color))}function convertConnectCameraToViewerCamera(e){const t=new r.Vector3(Math.sin(e.pitch)*Math.sin(e.yaw),-Math.sin(e.pitch)*Math.cos(e.yaw),Math.cos(e.pitch));return convertConnectCameraDetailsToViewerCamera(new r.Vector3(e.targetX+e.distance*t.x,e.targetY+e.distance*t.y,e.targetZ+e.distance*t.z),void 0,{pitch:e.pitch,yaw:e.yaw},e.projectionType,e.viewAngle,e.viewScale)}function convertConnectCameraDetailsToViewerCamera(e,t,n,i,o,s){return{position:e&&convertConnectPointToViewerPoint(e.x,e.y,e.z),quaternion:t?t.clone().multiply((new r.Quaternion).setFromEuler(new r.Euler(0,Math.PI,0))):void 0,rotation:n,direction:void 0,projectionType:i,fieldOfView:o,orthoSize:s}}function convertConnectDirectionToViewerDirection(e,t,n){return new r.Vector3(-e,-t,-n)}function convertConnectPointToViewerPoint(e,t,n){return new r.Vector3(e/1e3,t/1e3,n/1e3)}function convertConnectColorToViewerColor(e){return void 0!==e.r?new r.Color(e.r/255,e.g/255,e.b/255):void 0}function convertViewerColorToConnectColor(e){return{r:255*e.r,g:255*e.g,b:255*e.b,a:255}}function convertViewerTextMarkupToConnectMarkup(e){let t=(n=e.text,(new DOMParser).parseFromString(n,"text/html").body.textContent||"").trim();var n;if(""===t)return null;t.length>250&&(t=t.substring(0,250));const{x:i,y:o,z:r}=convertViewerPointToConnectPoint(e.endPick.point),{x:s,y:a,z:c}=convertViewerPointToConnectPoint(e.startPick.point);return{type:"text",positionX:i,positionY:o,positionZ:r,position2X:s,position2Y:a,position2Z:c,color:convertViewerColorToConnectColor(e.color),text:t,screenSpaceDistance:0,width:0}}function convertViewerMaterialToConnectColor(e){var t;if(e){if(e.color)return{r:255*e.color.r,g:255*e.color.g,b:255*e.color.b,a:255*(null!==(t=e.opacity)&&void 0!==t?t:1)};if(void 0!==e.opacity)return{a:255*e.opacity}}}function convertViewerLineMarkupToConnectMarkup(e){const{x:t,y:n,z:i}=convertViewerPointToConnectPoint(e.startPick.point),{x:o,y:r,z:s}=convertViewerPointToConnectPoint(e.endPick.point);return{type:"line",positionX:t,positionY:n,positionZ:i,position2X:o,position2Y:r,position2Z:s,color:convertViewerColorToConnectColor(e.color)}}function convertViewerArrowMarkupToConnectMarkup(e){const{x:t,y:n,z:i}=convertViewerPointToConnectPoint(e.startPick.point),{x:o,y:r,z:s}=convertViewerPointToConnectPoint(e.endPick.point);return{type:"arrow",positionX:t,positionY:n,positionZ:i,position2X:o,position2Y:r,position2Z:s,color:convertViewerColorToConnectColor(e.color)}}function convertViewerCloudMarkupToConnectMarkup(e){const{x:t,y:n,z:i}=convertViewerPointToConnectPoint(e.position),{x:o,y:r,z:s}=convertViewerDirectionToConnectDirection(e.normal);return{type:"cloud",positionX:t,positionY:n,positionZ:i,planeA:o,planeB:r,planeC:s,planeD:dot(e.normal,e.position),width:1e3*e.width*2,height:1e3*e.height*2,color:convertViewerColorToConnectColor(e.color)}}function convertViewerFreelineMarkupToConnectMarkup(e,t){const n=[];for(let t=0;t<e.points.length-1;t++){const{x:i,y:o,z:r}=convertViewerPointToConnectPoint(e.points[t].clone().applyMatrix4(e.matrixWorld)),{x:s,y:a,z:c}=convertViewerPointToConnectPoint(e.points[t+1].clone().applyMatrix4(e.matrixWorld));n.push({positionX:i,positionY:o,positionZ:r,position2X:s,position2Y:a,position2Z:c})}return{type:"redlines",camera:t,lines:n,color:convertViewerColorToConnectColor(e.color)}}function convertViewerPointMarkupToConnectMarkup(e){const{x:t,y:n,z:i}=convertViewerPointToConnectPoint(e.position);return{type:"measure",positionX:t,positionY:n,positionZ:i,position2X:t,position2Y:n,position2Z:i,color:convertViewerColorToConnectColor(e.color)}}function convertViewerPick(e,t){if(!e)return null;switch(e.snapType){case 4:case 2:{const{x:n,y:i,z:o}=convertViewerPointToConnectPoint(e.point);return{type:"point",referenceObject:e.model&&e.id&&t[e.model.modelId]?t[e.model.modelId][e.id]:void 0,positionX:n,positionY:i,positionZ:o}}case 3:case 1:{const{x:n,y:i,z:o}=convertViewerPointToConnectPoint(e.point),{x:r,y:s,z:a}=convertViewerPointToConnectPoint(e.snapLineEnd);return{type:"lineSegment",referenceObject:e.model&&e.id&&t[e.model.modelId]?t[e.model.modelId][e.id]:void 0,positionX:n,positionY:i,positionZ:o,position2X:r,position2Y:s,position2Z:a}}case 0:{const{x:n,y:i,z:o}=convertViewerPointToConnectPoint(e.point),{x:r,y:s,z:a}=convertViewerDirectionToConnectDirection(e.normal);return{type:"plane",referenceObject:e.model&&e.id&&t[e.model.modelId]?t[e.model.modelId][e.id]:void 0,positionX:n,positionY:i,positionZ:o,directionX:r,directionY:s,directionZ:a}}default:return null}}function convertViewerMeasurementToConnectMarkup(e){const t=0!==e.axisIndex||0!==e.directionIndex,n=0===e.startPick.snapType,i=1===e.startPick.snapType&&1===e.endPick.snapType,o=1===e.startPick.snapType&&2===e.endPick.snapType,r=t||n||i||o;let s=r?{snapType:2,point:e.getMainLine().start.clone(),model:e.startPick.model,id:e.startPick.id}:e.startPick,a=r?{snapType:2,point:e.getMainLine().end.clone(),model:e.endPick.model,id:e.endPick.id}:e.endPick;if(0===s.snapType&&0===a.snapType){const e=s;s=a,a=e}return new Promise((t=>{getObjectRuntimeIdToPersistentIdMap(e).then((n=>{t({type:"measure_with_pick",unitType:"Metric",quantityUnit:"millimeter",quantityUnitFormat:"mm",start:convertViewerPick(s,n),end:convertViewerPick(a,n),color:convertViewerColorToConnectColor(e.color)})}))}))}function convertViewerAngleMeasurementToConnectMarkup(e){return new Promise((t=>{getObjectRuntimeIdToPersistentIdMap(e).then((n=>{let i={type:"angle",start:convertViewerPick(e.startPick,n),end:convertViewerPick(e.endPick,n),color:convertViewerColorToConnectColor(e.color)};if(e.secondPick){const t=convertViewerPick(e.startPick,n);i=function(e,...t){return Object.assign({},e,...t)}(i,{positionX:t.positionX,positionY:t.positionY,positionZ:t.positionZ,referenceObject:t.referenceObject,start:convertViewerPick(e.secondPick,n)})}return t(i)}))}))}function convertViewerCameraToConnectCamera(e){return{distance:1e3,projectionType:e.projectionType,targetX:1e3*(e.position.x+e.direction.x),targetY:1e3*(e.position.y+e.direction.y),targetZ:1e3*(e.position.z+e.direction.z),viewAngle:e.fieldOfView,viewScale:e.orthoSize||0,pitch:e.rotation.pitch,yaw:e.rotation.yaw}}function convertViewerDirectionToConnectDirection(e){return{x:-e.x,y:-e.y,z:-e.z}}function convertViewerPointToConnectPoint(e){return{x:1e3*e.x,y:1e3*e.y,z:1e3*e.z}}function convertViewerClipPlaneToConnectSectionPlane(e){const{x:t,y:n,z:i}=convertViewerDirectionToConnectDirection(e.normal),{x:o,y:r,z:s}=convertViewerPointToConnectPoint(e.position);return{directionX:t,directionY:n,directionZ:i,positionX:o,positionY:r,positionZ:s}}function convertApiCameraToViewerCamera(e){const t=e;let n;return void 0!==t.pitch&&void 0!==t.yaw?n=void 0:t.quaternion?n=(new r.Quaternion).copy(t.quaternion):t.lookAt&&t.upDirection&&(n=(new r.Quaternion).setFromRotationMatrix((new r.Matrix4).lookAt(t.lookAt,t.position,t.upDirection))),isApiCamera(t)?convertConnectCameraDetailsToViewerCamera(convertViewerPointToConnectPoint(t.position),n,void 0!==t.pitch?{pitch:t.pitch,yaw:t.yaw}:void 0,t.projectionType,t.fieldOfView,t.orthoSize):isConnectCamera(e)?convertConnectCameraToViewerCamera(e):void 0}function isApiCamera(e){return e&&(defined(e.position)||defined(e.lookAt)||defined(e.quaternion))}function isConnectCamera(e){return e&&(void 0!==e.targetX||void 0!==e.targetY||void 0!==e.targetZ||void 0!==e.pitch||void 0!==e.yaw||void 0!==e.distance)}function getObjectRuntimeIdToPersistentIdMap(e){return new Promise((t=>{const n={};Promise.all([e.startPick.model&&e.startPick.id?getPersistentIds(e.startPick.model.modelId,[e.startPick.id]):Promise.resolve([void 0]),e.endPick.model&&e.endPick.id?getPersistentIds(e.endPick.model.modelId,[e.endPick.id]):Promise.resolve([void 0])]).then((i=>{e.startPick.model&&e.startPick.id&&(n[e.startPick.model.modelId]={[e.startPick.id]:i[0][0]}),e.endPick.model&&e.endPick.id&&(n[e.endPick.model.modelId]?n[e.endPick.model.modelId][e.endPick.id]=i[1][0]:n[e.endPick.model.modelId]={[e.endPick.id]:i[1][0]}),t(n)}))}))}function getPersistentObjectIdToRuntimeIdMap(e){return new Promise((t=>{const n=e.models.map((e=>getTrimbimModel(e))).filter((e=>e)),i=e.markups.reduce(((e,t)=>{var n,i;return(null===(n=t.start)||void 0===n?void 0:n.referenceObject)&&!e.includes(t.start.referenceObject)&&e.push(t.start.referenceObject),(null===(i=t.end)||void 0===i?void 0:i.referenceObject)&&!e.includes(t.end.referenceObject)&&e.push(t.end.referenceObject),e}),[]),o=i.map((e=>new Promise((t=>{Promise.all(n.map((t=>getEntityIds(t,[e],void 0)))).then((e=>{const i=e.findIndex((e=>!!e[0]));t(i>-1?{objectRuntimeId:e[i][0],modelVersionId:n[i].modelId}:{objectRuntimeId:void 0,modelVersionId:void 0})}))}))));Promise.all(o).then((e=>{const n=i.reduce(((t,n,i)=>(e[i].objectRuntimeId&&e[i].modelVersionId&&(t[n]=e[i]),t)),{});t(n)}))}))}var F;async function getView(e){let t;if("string"==typeof e){if(t=await async function(e){return new Promise(((t,n)=>{const i=new XMLHttpRequest;i.open("GET",e,!0),i.withCredentials=!0,i.responseType="json",i.onload=()=>t(i.response),i.onerror=()=>n("Error loading "+e),i.send()}))}(e),!t)throw new Error("Error in fetching the view from JSON file")}else t=e;return Promise.resolve(t)}async function configureCamera(t){t.projectionType&&(e.web3DViewer.camera.projectionType=t.projectionType),t.fieldOfView&&(e.web3DViewer.camera.fieldOfView=t.fieldOfView),t.orthoSize&&(e.web3DViewer.camera.orthoSize=t.orthoSize),t.position&&(e.web3DViewer.camera.position=t.position),t.quaternion&&(e.web3DViewer.camera.quaternion=t.quaternion),t.rotation&&(e.web3DViewer.camera.quaternion=rotationToQuaternion(t.rotation))}async function getEntityStatesFromView(t,n,i){const o={Hidden:{},Selected:{},Colored:{}},r=function(t,n){const i=new Map;for(let o=0;o<t.files.length;o++){const r=n?n.get(t.files[o]):t.models[o],s=e.web3DViewer.getModel(r);s&&i.set(r,[o,r,s])}return i}(n,i),s=[];for(const e of r)s.push(new Promise((async i=>{var r,s;try{const[a,[c,d,u]]=e,l=t?t.get(a):void 0;if((null===(r=n.presentation)||void 0===r?void 0:r.elementTypes)&&await getAllEntityStatesForElementTypes(n.presentation.elementTypes,u,o,d),null===(s=n.presentation)||void 0===s?void 0:s.elements){const e=n.presentation.elements.filter((e=>e.versionId===n.models[c])),t=new Set(e.map((e=>e.state)));for(const n of t){const t=e.filter((e=>e.state===n)),i=Array.from(new Set(t.map((e=>JSON.stringify(e.color))))).map((e=>e?JSON.parse(e):void 0)).filter((e=>void 0!==e));for(const e of i){getEntityStatesForElementTypes(d,await getEntityIds(u,t.filter((t=>colorEqual(e,t.color))).map((e=>e.sourceId)),l),n,e,o)}getEntityStatesForElementTypes(d,await getEntityIds(u,t.filter((e=>!e.color)).map((e=>e.sourceId)),l),n,void 0,o)}}await handleGridsVisibility(o.Hidden[d],u)}catch(t){logError(`Failed to prepare entity states for model ${e[0]}`,t)}finally{i()}})));return await async function(e){return Promise.all(e.map((e=>e.then((e=>({result:e,status:"fulfilled"})),(e=>({error:e,status:"rejected"}))))))}(s),o}function addClipPlanes(n){n&&n.map(convertConnectSectionPlaneToViewerClipPlane).forEach((n=>{e.web3DViewer.tools.get(t.ClipPlaneTool).add(n.position,n.normal,void 0,"view")}))}async function addMarkups(e){if(e.markups){const t=await getPersistentObjectIdToRuntimeIdMap(e);e.markups.forEach((e=>{switch(e.type){case"cloud":addConnectCloudMarkupToViewer(e);break;case"line":addConnectLineMarkupToViewer(e);break;case"arrow":addConnectArrowMarkupToViewer(e);break;case"text":addConnectTextMarkupToViewer(e);break;case"redlines":addConnectFreelineMarkupToViewer(e);break;case"measure_with_pick":addConnectMeasurementMarkupToViewer(e,t);break;case"measure":addConnectSinglePointMeasurementToViewer(e);break;case"angle":addConnectAngleMeasurementToViewer(e,t);break;default:throw new Error(`Unknown markup type: '${e.type}'`)}}))}}async function getAllEntityStatesForElementTypes(e,t,n,i){for(const o of e){getEntityStatesForElementTypes(i,await t.findEntitiesByClass(o.type),o.state,o.color,n)}}function getEntityStatesForElementTypes(e,t,n,i,o){if(!(t.length<=0)&&(void 0!==n&&(function(e){if(e===y.Hidden||e===y.SelectedHidden)return!0;return!1}(n)&&(o.Hidden[e]?o.Hidden[e].push(...t):o.Hidden[e]=[...t]),function(e){if(e===y.Selected||e===y.SelectedVisible)return!0;return!1}(n)&&(o.Selected[e]?o.Selected[e].push(...t):o.Selected[e]=[...t])),void 0!==i)){const n={opacity:i.a/255},r=convertConnectColorToViewerColor(i);if(r&&(n.color=r),o.Colored[e]){const i=o.Colored[e].find((e=>colorEqual(e.material.color,n.color)));i?i.entityIds.push(...t):o.Colored[e].push({material:n,entityIds:[...t]})}else o.Colored[e]=[{material:n,entityIds:[...t]}]}}function colorEqual(e,t){return e&&t?e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a:e===t}async function handleGridsVisibility(t,n){const i=await getGrids(n);if(t){const o=i.filter((e=>!t.includes(e)));o.length>0&&(await n.setVisibility(o,!0),emit(e.Web3DWrapperEventName.EnableGrids,!0))}else await n.setVisibility(i,!0),emit(e.Web3DWrapperEventName.EnableGrids,!0);return Promise.resolve()}e.ClipPlaneOrigin=void 0,(F=e.ClipPlaneOrigin||(e.ClipPlaneOrigin={})).Extension="extension",F.View="view";let $=0;e.GHOST_MODE_OPACITY=.2,e.addClipPlanes=addClipPlanes,e.addCloudMarkupToViewer=function(t){return e.web3DViewer.tools.get(n.CloudMarkupTool).add({point:convertConnectPointToViewerPoint(t.position.x,t.position.y,t.position.z),normal:new r.Vector3(t.normal.x,t.normal.y,t.normal.z)},t.width,t.height,convertConnectColorToViewerColor(t.color))},e.addConnectAngleMeasurementToViewer=addConnectAngleMeasurementToViewer,e.addConnectArrowMarkupToViewer=addConnectArrowMarkupToViewer,e.addConnectCloudMarkupToViewer=addConnectCloudMarkupToViewer,e.addConnectFreelineMarkupToViewer=addConnectFreelineMarkupToViewer,e.addConnectLineMarkupToViewer=addConnectLineMarkupToViewer,e.addConnectMeasurementMarkupToViewer=addConnectMeasurementMarkupToViewer,e.addConnectSinglePointMeasurementToViewer=addConnectSinglePointMeasurementToViewer,e.addConnectTextMarkupToViewer=addConnectTextMarkupToViewer,e.addIcons=async function(t){if(t.length)return e.web3DViewer.plugins.get(i.IconsPlugin).add(t)},e.addMarkups=addMarkups,e.addTextMarkupToViewer=function(t){return e.web3DViewer.tools.get(n.TextMarkupTool).add({point:convertConnectPointToViewerPoint(t.positionX,t.positionY,t.positionZ)},{point:convertConnectPointToViewerPoint(t.position2X,t.position2Y,t.position2Z)},convertConnectColorToViewerColor(t.color),t.text)},e.clearIcons=async function(){const t=e.web3DViewer.plugins.get(i.IconsPlugin),n=t.getIcons().filter((e=>e.id>=0));return n&&n.length?t.remove(n):Promise.resolve()},e.configure=function(t,n,o){e.web3DViewer=t,e.markupPlugin=n,e.trimbimPlugin=o,e.web3DViewer.addEventListener("pick",(t=>{if(t.detail.modelId===i.PointIconModel.ModelId)for(const n of e.web3DViewer.plugins.get(i.IconsPlugin).getIcons())if(n.id===t.detail.id){emit(e.Web3DWrapperEventName.IconPick,{icon:n,detail:t.detail});break}emit(e.Web3DWrapperEventName.ObjectPick,t.detail)}))},e.convertApiCameraToViewerCamera=convertApiCameraToViewerCamera,e.convertConnectAlignmentToViewerPlacement=function(e){const t=convertConnectPointToViewerPoint(e.locationX,e.locationY,e.locationZ),n=normalize(vector3(e.axisX,e.axisY,e.axisZ)),i=normalize(cross(n,vector3(e.refDirectionX,e.refDirectionY,e.refDirectionZ))),o=normalize(cross(i,n)),r=e.scale;return function(e,t,n,i){return{elements:[e.x,e.y,e.z,0,t.x,t.y,t.z,0,n.x,n.y,n.z,0,i.x,i.y,i.z,1]}}(scale(o,r),scale(i,r),scale(n,r),t)},e.convertConnectCameraDetailsToViewerCamera=convertConnectCameraDetailsToViewerCamera,e.convertConnectCameraToViewerCamera=convertConnectCameraToViewerCamera,e.convertConnectColorToViewerColor=convertConnectColorToViewerColor,e.convertConnectDirectionToViewerDirection=convertConnectDirectionToViewerDirection,e.convertConnectPointToViewerPoint=convertConnectPointToViewerPoint,e.convertConnectSectionPlaneToViewerClipPlane=convertConnectSectionPlaneToViewerClipPlane,e.convertViewerAngleMeasurementToConnectMarkup=convertViewerAngleMeasurementToConnectMarkup,e.convertViewerArrowMarkupToConnectMarkup=convertViewerArrowMarkupToConnectMarkup,e.convertViewerCameraToConnectCamera=convertViewerCameraToConnectCamera,e.convertViewerClipPlaneToConnectSectionPlane=convertViewerClipPlaneToConnectSectionPlane,e.convertViewerCloudMarkupToConnectMarkup=convertViewerCloudMarkupToConnectMarkup,e.convertViewerColorToConnectColor=convertViewerColorToConnectColor,e.convertViewerDirectionToConnectDirection=convertViewerDirectionToConnectDirection,e.convertViewerFreelineMarkupToConnectMarkup=convertViewerFreelineMarkupToConnectMarkup,e.convertViewerLineMarkupToConnectMarkup=convertViewerLineMarkupToConnectMarkup,e.convertViewerMaterialToConnectColor=convertViewerMaterialToConnectColor,e.convertViewerMeasurementToConnectMarkup=convertViewerMeasurementToConnectMarkup,e.convertViewerPointMarkupToConnectMarkup=convertViewerPointMarkupToConnectMarkup,e.convertViewerPointToConnectPoint=convertViewerPointToConnectPoint,e.convertViewerTextMarkupToConnectMarkup=convertViewerTextMarkupToConnectMarkup,e.createCameraData=createCameraData,e.createLinkIcons=async function(t,n){const i=[],o=e.web3DViewer.getModel(t);if(o&&n.length>0){const e=await o.getBoundingBoxes(n.map((e=>e.entityId)));for(let t=0;t<n.length;t++){const o=n[t],s=e[t].getCenter(new r.Vector3);i.push({iconPath:o.icon,id:o.iconId,position:s,size:o.iconSize})}}return i},e.createView=async function(i,o,r,s){const a=await(c=await e.web3DViewer.screenshot(s),new Promise((e=>{const t=new FileReader;t.onload=t=>e(t.target.result),t.readAsDataURL(c)})));var c;const d=convertViewerCameraToConnectCamera(createCameraData()),u=e.markupPlugin.getMarkups(),l=await async function(t,n){const i=[];for(const n of t){const t=e.web3DViewer.selection.get(n),o=getTrimbimModel(n);if(o){const e=await o.getVisibleEntityIds(!1),r=await o.getEntityIdsByPickPriority(2),s=(await o.getCustomMaterialEntityIds()).filter((e=>!r.includes(e))),a=await o.getCustomMaterials(s),c=t&&t.filter((t=>e.includes(t)));let d=t,u=e;if(c&&(d=t&&t.filter((e=>!c.includes(e))),u=e.filter((e=>!c.includes(e)))),r&&r.length>0&&u.push(...r),d){const e=await getPersistentIds(n,d);for(let t=0;t<e.length;t++){const r=e[t];i.push({sourceId:r,state:y.Selected,versionId:n,isRecursive:t<d.length&&(await o.getHierarchyChildren([d[t]],!0)).length>0})}}if(u){(await getPersistentIds(n,u)).forEach((e=>{i.push({sourceId:e,state:y.Hidden,versionId:n})}))}if(c){(await getPersistentIds(n,c)).forEach((e=>{i.push({sourceId:e,state:y.SelectedHidden,versionId:n})}))}if(s){const e=await getPersistentIds(n,s);for(let t=0;t<e.length;t++){const r=e[t],c=convertViewerMaterialToConnectColor(a[t]),d=t<s.length&&(await o.getHierarchyChildren([s[t]],!0)).length>0,u=i.find((e=>e.sourceId===r&&e.versionId===n));u?(u.color=c,u.isRecursive=d):i.push({sourceId:r,state:y.Visible,versionId:n,color:c,isRecursive:d})}}}}return{elementTypes:[],elements:i,ghost:n.ghostMode,isCriticalEnabled:!1,isDocumentsEnabled:!1,isIgnoredEnabled:!1,isNewEnabled:!1,isNotesEnabled:n.notesEnabled,isPendingEnabled:!1,isResolvedEnabled:!1,transparencyLevel:100*e.web3DViewer.settings.globalOpacity,transparent:1!==e.web3DViewer.settings.globalOpacity,wireframe:!1}}(o,r),p=e.web3DViewer.tools.get(t.ClipPlaneTool).getClipPlanes().map(convertViewerClipPlaneToConnectSectionPlane),m=u.filter((e=>e.name!==n.MeasurementTool.Name&&e.name!==n.AngleMeasurementTool.Name)).map((e=>{if(e.name===n.TextMarkupTool.Name)return convertViewerTextMarkupToConnectMarkup(e);if(e.name===n.ArrowMarkupTool.Name)return convertViewerArrowMarkupToConnectMarkup(e);if(e.name===n.CloudMarkupTool.Name)return convertViewerCloudMarkupToConnectMarkup(e);if(e.name===n.LineMarkupTool.Name)return convertViewerLineMarkupToConnectMarkup(e);if(e.name===n.FreelineMarkupTool.Name)return convertViewerFreelineMarkupToConnectMarkup(e,d);if(e.name===n.PointMarkupTool.Name)return convertViewerPointMarkupToConnectMarkup(e);throw new Error("Unknown markup type")})),f=await Promise.all(u.filter((e=>e.name===n.MeasurementTool.Name)).map((e=>new Promise((t=>{convertViewerMeasurementToConnectMarkup(e).then((e=>{t(e)}))}))))),g=await Promise.all(u.filter((e=>e.name===n.AngleMeasurementTool.Name)).map((e=>new Promise((t=>{convertViewerAngleMeasurementToConnectMarkup(e).then((e=>{t(e)}))}))))),v={origin:"",camera:d,files:i,imageData:a,markups:[...m,...f,...g].filter((e=>null!=e)),models:o,presentation:l,sectionPlanes:p};return Promise.resolve(v)},e.emit=emit,e.eventEmitter=D,e.generateApiIconId=function(){return--$},e.getCameraUpDirection=function(e){if(e&&e.quaternion){const t=new r.Matrix4;t.makeRotationFromQuaternion(e.quaternion);const n=new r.Vector3,i=new r.Vector3,o=new r.Vector3;return t.extractBasis(n,i,o),i}},e.getEntityIds=getEntityIds,e.getEntityStatesForElementTypes=getEntityStatesForElementTypes,e.getGrids=getGrids,e.getLayerVisibility=async function(e,t){return await e.getLayerVisibility(t)},e.getLayers=async function(e,t){return t&&t.length>0?await e.findLayersByEntities(t):await e.getLayers()},e.getObjectRuntimeIdToPersistentIdMap=getObjectRuntimeIdToPersistentIdMap,e.getPartIdsFromAssemblyIds=async function(e,t){const n=getTrimbimModel(e);return n?await n.getHierarchyChildren(t,!0):[]},e.getPersistentIds=getPersistentIds,e.getPersistentObjectIdToRuntimeIdMap=getPersistentObjectIdToRuntimeIdMap,e.getTrimbimModel=getTrimbimModel,e.getView=getView,e.getVisibleGridIdsInView=async function(t,n,i,o){let r,s;const a=await getEntityStatesFromView(t,n,o),c=e.web3DViewer.getModel(i);if(c){const e=await getGrids(c);a.Hidden.hasOwnProperty(i)&&(r=a.Hidden[i]),s=r?e.filter((e=>!r.includes(e))):e}return s},e.identifierBuilder=S,e.isApiCamera=isApiCamera,e.isBackgroundImage360=function(){return e.web3DViewer.isCubeBackground()},e.isConnectCamera=isConnectCamera,e.loadAPIView=async function(e){let t;t=isApiCamera(e.camera)?convertApiCameraToViewerCamera(e.camera):convertConnectCameraToViewerCamera(e.camera),await configureCamera(t),addClipPlanes(e.sectionPlanes)},e.loadViewToWeb3D=async function(t,n,i,o){var r,s,a,c,d;let u=!0;const l=await getView(t),p=convertConnectCameraToViewerCamera(l.camera);await configureCamera(p),await async function(t){if(!t)return;for(const n of Object.keys(t)){const i=e.web3DViewer.getModel(n);if(i){const e=t[n];for(const t of e)await i.setLayerVisibility(t,!1)}}}(o);try{addClipPlanes(l.sectionPlanes)}catch(e){logError("Error while loading clip planes of view.",e),u=!1}try{await addMarkups(l)}catch(e){logError("Error while loading markups of view.",e),u=!1}!async function(t){var n;const i=(null===(n=t.presentation)||void 0===n?void 0:n.transparencyLevel)?t.presentation.transparencyLevel:100;e.web3DViewer.settings.globalOpacity=i/100}(l),emit(e.Web3DWrapperEventName.ActivateGhostMode,null===(r=l.presentation)||void 0===r?void 0:r.ghost),emit(e.Web3DWrapperEventName.EnableObjectLinks,null===(s=l.presentation)||void 0===s?void 0:s.isNotesEnabled),emit(e.Web3DWrapperEventName.EnableAnnotations,(null===(a=l.markups)||void 0===a?void 0:a.length)>0),emit(e.Web3DWrapperEventName.EnableClipPlanes,(null===(c=l.sectionPlanes)||void 0===c?void 0:c.length)>0);const m=await getEntityStatesFromView(n,l,i);return await async function(t,n){const i=new Map;for(const n in t.Colored)if(t.Colored.hasOwnProperty(n)){const o=e.web3DViewer.getModel(n),r=t.Hidden.hasOwnProperty(n)?t.Hidden[n]:[],s=t.Colored[n];for(const e of s){await o.setCustomMaterial([...e.entityIds],e.material);const t=e.entityIds.filter((e=>!r.includes(e)));i.has(n)?i.set(n,Array.from(new Set([...i.get(n),...t]))):i.set(n,t)}}for(const i in t.Hidden)if(t.Hidden.hasOwnProperty(i)){const o=e.web3DViewer.getModel(i),r=t.Hidden[i];n?(await o.setCustomMaterial(r,{opacity:.2}),await o.setPickPriority(r,2)):await o.setVisibility(r,!1)}for(const n in t.Selected)t.Selected.hasOwnProperty(n)&&e.web3DViewer.selection.set(n,t.Selected[n]),i.has(n)?i.set(n,Array.from(new Set([...i.get(n),...t.Selected[n]]))):i.set(n,t.Selected[n]);i.forEach((async(t,n)=>{const i=e.web3DViewer.getModel(n),o=await i.getHierarchyParents(t,void 0,!0);o.length&&await i.setVisibility(o,!0)}))}(m,null===(d=l.presentation)||void 0===d?void 0:d.ghost),u},e.on=function(e,t){D.on(e,t)},e.quaternionToRotation=quaternionToRotation,e.removeEventListener=function(e,t){D.removeListener(e,t)},e.removeIcons=async function(t){if(t.length)return e.web3DViewer.plugins.get(i.IconsPlugin).remove(t)},e.rotationToQuaternion=rotationToQuaternion,e.setLayerVisibility=async function(e,t,n){return await e.setLayerVisibility(t,n)},Object.defineProperty(e,"__esModule",{value:!0})}));
