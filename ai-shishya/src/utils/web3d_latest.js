import{Euler as t,Quaternion as e,Vector3 as i,Color as n,Line3 as o,Matrix4 as r,Vector2 as s}from"@technology/web3d";import{TrimbimModel as a,ClipPlaneTool as c}from"@technology/web3d-plugin-trimbim";import{CloudMarkupTool as d,LineMarkupTool as u,ArrowMarkupTool as l,TextMarkupTool as f,FreelineMarkupTool as p,PointMarkupTool as g,MeasurementTool as h}from"@technology/web3d-plugin-markup";import{PointIconModel as m,IconsPlugin as y}from"@technology/web3d-plugin-icons";import{ConnectIdentifierBuilder as v}from"@technology/web3d-plugin-trimbim/dist/esnext/Extras/ConnectIdentifier/ConnectIdentifier";const w={};let O=1;const b={},k=function(t){if(b[t])return b[t];const e={},i={debug:"#7f8c8d",log:"#2ecc71",warn:"#f39c12",error:"#c0392b"},n=(e,...n)=>{const o=[`%c${t}`,[`border: 1px solid ${i[e]}`,"border-radius: 0.5em",`color: ${i[e]}`,"font-weight: bold","padding: 2px 0.5em"].join(";")];console[e](...o,...n)};for(const t of Object.keys(i))e[t]=(...e)=>n(t,...e);return b[t]=e,e}("App");function P(...t){k.debug(...t)}function j(...t){k.error(...t)}function E(...t){k.warn(...t)}function I(t){return t.reduce(((t,e)=>t.concat(e)),[])}const S={},T=[],$=new Promise((t=>{}));function R(t,e,i){const n={};for(const o in t){const r=t[o];if((void 0!==i||"onConnect"!==o&&"onRequest"!==o)&&r)if("object"==typeof r){const t=i&&i+"."+String(o)||String(o);n[o]=R(r,e,t)}else n[o]=e(o,t[o],i)}return n}!function(t){const e=O++;w[e]=t}({request:(t,e,i,n)=>{if(".connect_api_client_v1"===i)return $.then((()=>{let i=T.find((e=>e.dispatcher===t));var n;return i?i.origin=e:(i={dispatcher:t,origin:e},T.push(i)),(n=S)&&"function"==typeof n.onConnect&&S.onConnect(i),R(S,((t,e)=>"function"==typeof e?".api_function_v1":e))}));{const r=T.find((i=>i.dispatcher===t&&i.origin===e));if(r){if((o=S)&&"function"==typeof o.onRequest){const t=S.onRequest(r,i,n);if(void 0!==t)return t}const t=function(t,e){const i=e.split(".");let n=t;for(const t of i)n="object"==typeof n&&n&&t in n?n[t]:void 0;return n}(S,i);if("function"==typeof t){const e=t.apply(void 0,n);return void 0===e?Promise.resolve(e):e}return Promise.resolve(t)}return}var o}});class x{storage=new Map;itemInsertionCallback;get length(){return this.storage.size}getItem(t){const e=this.storage.get(t);return void 0===e?null:e}setItem(t,e){this.storage.set(t,e),this.itemInsertionCallback&&this.itemInsertionCallback(this.length)}removeItem(t){this.storage.delete(t)}clear(){return this.storage.clear()}key(t){const e=[];for(const t of this.storage.keys())e.push(t);return e[t]}}class F{storageType;_underlyingStorage;constructor(t){this.storageType=t,this._underlyingStorage=this.getStorage()}getStorage(){let t;try{t="undefined"==typeof window?global[this.storageType]:window[this.storageType];const e="__storage_test__";return t.setItem(e,e),t.removeItem(e),t}catch(e){if(22!==e.code&&1014!==e.code&&"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||!t||0===t.length){const t="undefined"==typeof window?global:window,e=`emulated${this.storageType}`;return t.hasOwnProperty(e)||(t[e]=new x),t[e]}throw e}}get underlyingStorage(){return this._underlyingStorage}reload(){this._underlyingStorage=this.getStorage()}get length(){return this._underlyingStorage.length}getItem(t){return this._underlyingStorage.getItem(t)}setItem(t,e){return this._underlyingStorage.setItem(t,e)}removeItem(t){return this._underlyingStorage.removeItem(t)}clear(){return this._underlyingStorage.clear()}key(t){return this._underlyingStorage.key(t)}}function U(t,e){return{x:t.y*e.z-t.z*e.y,y:t.z*e.x-t.x*e.z,z:t.x*e.y-t.y*e.x}}function q(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function L(t){return Math.sqrt(function(t){return q(t,t)}(t))}function C(t){return D(t,1/L(t))}function D(t,e){return{x:t.x*e,y:t.y*e,z:t.z*e}}function N(t,e,i){return{x:t,y:e,z:i}}var M,_;new F("localStorage"),new F("sessionStorage"),function(t){t[t.AllowNegative=1]="AllowNegative",t[t.AllowIntegers=2]="AllowIntegers",t[t.AllowDecimals=4]="AllowDecimals",t[t.AllowScientific=8]="AllowScientific",t[t.AllowFractions=16]="AllowFractions",t[t.Any=31]="Any"}(M||(M={})),function(t){t[t.Feet=0]="Feet",t[t.Inches=1]="Inches",t[t.FeetInches=2]="FeetInches"}(_||(_={}));class A extends Error{constructor(t,e,i){super(A.formatMessage(t,e)),this.response=t,this.errorMessage=e,this.errorCode=i,Error.captureStackTrace&&Error.captureStackTrace(this,A)}static formatMessage(t,e){return`HTTP ${t.status} (${t.statusText}): ${e}`}}var z={};Object.defineProperty(z,"__esModule",{value:!0});var V="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},X="undefined"!=typeof window&&void 0!==window.document,Y="object"===("undefined"==typeof self?"undefined":V(self))&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,Z="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;z.isBrowser=X,z.isWebWorker=Y,z.isNode=Z,z.isJsDom=function(){return"undefined"!=typeof window&&"nodejs"===window.name||navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")};var H=function(t,e,i,n){return new(i||(i=Promise))((function(o,r){function s(t){try{c(n.next(t))}catch(t){r(t)}}function a(t){try{c(n.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}c((n=n.apply(t,e||[])).next())}))};class J{constructor(t,e,i){this.service=t,this.response=e,this.data=i,this.retryCount=0}hasNextPage(){if(this.data&&this.data.hasOwnProperty("next")){return null!==this.data.next}return!1}nextPage(){return H(this,void 0,void 0,(function*(){if(!this.hasNextPage())throw new Error("There is no next page for this response.");const t=this.data.next;return this.service.makeRequest(t)}))}}var G=function(t,e,i,n){return new(i||(i=Promise))((function(o,r){function s(t){try{c(n.next(t))}catch(t){r(t)}}function a(t){try{c(n.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}c((n=n.apply(t,e||[])).next())}))};function B(t){const e=t.indexOf("//"),i=t.indexOf("/",e+2);return t.substring(0,i)}function W(t){return new Promise((e=>{setTimeout(e,t)}))}class Q{constructor(t){if(this.config=t,this.defaultRetryCount=3,!this.config.serviceUri)throw new Error("The serviceUri is required")}makeRequest(t,e="GET",i,n,o=!0){return G(this,void 0,void 0,(function*(){const r=new Headers({Accept:"application/json"});n&&n.forEach(((t,e)=>{r.append(e,t)}));const s=yield this.request(t,e,i,r,o);if(204!==s.response.status){const t=s.response.headers.get("content-type");if(null!==t&&-1===t.indexOf("application/json"))throw new A(s.response,"Cannot deserialize response body as it is not in a JSON format.");s.data=yield s.response.json()}return s}))}getItemsWithPages(t,e,i,n,o,r=!0){return G(this,void 0,void 0,(function*(){const s=null!=o?o:new Headers;s.has("Range")&&s.delete("Range");const a={start:0,end:i-1};s.append("Range",`items=${a.start}-${a.end}`);let c=yield this.makeRequest(t,"GET",n,s,r);for(;;){const o=this.getRange(c);let d;if(Array.isArray(c.data)&&0!==c.data.length&&o&&o.total&&o.end<o.total-1&&o&&o.total&&(s.delete("Range"),a.start=o.end+1,a.end=Math.min(o.total-1,a.start+i-1),s.append("Range",`items=${a.start}-${a.end}`),d=this.makeRequest(t,"GET",n,s,r)),e(c),!d)break;c=yield d}}))}request(t,e="GET",i,n,o=!0){return G(this,void 0,void 0,(function*(){const r=t.startsWith("http")?t:t.startsWith("/")?B(this.config.serviceUri)+t:this.config.serviceUri+t,s=new Headers;return(n?n.get("Content-Type"):void 0)||void 0===i||s.set("Content-Type","application/json"),n&&n.forEach(((t,e)=>{s.append(e,t)})),this.fetchWithRetry(r,{body:i,headers:s,method:e,redirect:"follow"},o)}))}maxRetries(){return void 0!==this.config.maxRetries?this.config.maxRetries:this.defaultRetryCount}calculateRetryDelay(t){if(0===t)return 0;{const e=100;return Math.random()*(Math.pow(2,t-1)*e)}}retryableError(t){return!!(this.timeoutError(t)||this.networkingError(t)||this.expiredCredentialsError(t)||this.throttledError(t)||t.response.status>=500)}networkingError(t){return"NetworkingError"===t.errorCode}timeoutError(t){return"TimeoutError"===t.errorCode}expiredCredentialsError(t){if(401===t.response.status){const t=this.config.credentials;return t&&"boolean"==typeof t.expired&&(t.expired=!0),!0}return!1}throttledError(t){return 429===t.response.status}fetchWithRetry(t,e,i=!0){return G(this,void 0,void 0,(function*(){const n=this.config.logger,o=new J(this,new Response,void 0);for(;;){const r=this.config.credentials;if(i&&r){if("function"==typeof r.get)try{yield r.get()}catch(t){throw void 0!==n&&this.log(`[TID] Failed to acquire tokens: ${t.message}`),t}r.token&&e.headers.set("Authorization","Bearer "+r.token)}const s=Date.now(),a=yield this.fetch(t,e);if(void 0!==n){const i=(Date.now()-s)/1e3,n=new Date(s).toISOString(),r=e.body?e.body.length:0,c=a.headers.get("content-length"),d=`${n} [TC HTTP] ${e.method} ${t} ${a.status} ${i} ${o.retryCount} ${r} ${c}`;this.log(d)}if(o.response=a,a.ok)return o;{let t;const e=a.headers.get("content-type");if(e&&-1!==e.indexOf("application/json")){const e=yield a.json();t=new A(a,e.message,e.code||e.errorcode)}else{const e=yield a.text();t=new A(a,e)}if(!(o.retryCount+1<this.maxRetries()&&this.retryableError(t)))throw t;{const t=a.headers.get("retry-after"),e=t?1e3*parseInt(t,10):0,i=this.calculateRetryDelay(o.retryCount)+e;yield W(i),o.retryCount++}}}}))}fetch(t,e){return fetch(t,e)}getRange(t){if(t.response.headers.has("Content-Range"))try{const e=t.response.headers.get("Content-Range").split(" ")[1].split("/"),i=e[0].split("-"),n=Number(i[0]),o=Number(i[1]);return{start:n,end:o,total:Number(e[1])}}catch(t){return}}log(t){return G(this,void 0,void 0,(function*(){const e=this.config.logger;void 0!==e&&("function"==typeof e.log?e.log(t):"function"==typeof e.write&&e.write(t+"\n"))}))}}var K=function(t,e,i,n){return new(i||(i=Promise))((function(o,r){function s(t){try{c(n.next(t))}catch(t){r(t)}}function a(t){try{c(n.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}c((n=n.apply(t,e||[])).next())}))};const tt={};class et{constructor(t){this.obj=t}get origin(){return this.obj.origin}get isMaster(){return this.obj.isMaster}get location(){return this.obj.location}get tcApi(){return this.obj["tc-api"]}get orgApi(){return this.obj["org-api"]}get psetApi(){return this.obj["pset-api"]}get projectsApi(){return this.obj["projects-api"]}}var it;!function(t){t[t.Selected=1]="Selected",t[t.Hidden=4]="Hidden",t[t.SelectedHidden=5]="SelectedHidden",t[t.Visible=6]="Visible",t[t.SelectedVisible=7]="SelectedVisible",t[t.Highlighted=8]="Highlighted"}(it||(it={}));class nt extends Q{static isFile(t){return"FILE"===t.type}static isFolder(t){return"FOLDER"===t.type}static formatUrlFromOrigin(t,e){return"https:"+t+"/tc/api/2.0/"+e}constructor(t){super(Object.assign(Object.assign({},{serviceUri:"https://app.connect.trimble.com/tc/api/2.0/"}),t))}search(t,e){return K(this,void 0,void 0,(function*(){const i=[`query=${e.query}`];e.projectId&&i.push(`projectId=${e.projectId}`),e.type&&i.push(`type=${e.type}`),e.startDate&&i.push(`startDate=${e.startDate}`),e.endDate&&i.push(`endDate=${e.endDate}`);let n=e.sort;if(e.sort&&e.sort.length){const t=e.sort[0];-1===[" ","+","-"].indexOf(t)&&(n=" "+n)}n&&i.push(`sort=${n}`);const o=nt.formatUrlFromOrigin(t,"search?"+i.join("&")),r=e.range?new Headers({Range:`items=${e.range.start}-${e.range.end}`}):void 0;return yield this.makeRequest(o,"GET",void 0,r)}))}listServers(){return K(this,void 0,void 0,(function*(){const t=yield this.makeRequest("regions");return t.data=t.data.map((t=>new et(t))),t}))}getUserDetails(t){return K(this,void 0,void 0,(function*(){return this.makeRequest(`users/${t}`)}))}listProjects(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,"projects"),i=yield this.makeRequest(e);for(const e of i.data)e.origin=t.origin;return i}))}getProject(t,e){return K(this,void 0,void 0,(function*(){if(!t)throw Error("id is required");const i=e?[e]:(yield this.listServers()).data;for(const e of i)try{const i=nt.formatUrlFromOrigin(e.origin,`projects/${t}`),n=yield this.makeRequest(i);if(n)return n.data.origin=e.origin,n}catch(t){}throw Error("Project with id is not found")}))}patchProject(t,e,i){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(e,`projects/${t}`);return this.makeRequest(n,"PATCH",JSON.stringify(i))}))}updateLastVisitedOnProject(t){return K(this,void 0,void 0,(function*(){const e={lastVisitedOn:function(t){let e=t.toISOString();return e=e.substr(0,e.indexOf("."))+"+0000",e}(new Date)};return this.patchProject(t.id,t.origin,e)}))}listProjectMembers(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`projects/${t.id}/users`);return this.makeRequest(e)}))}listProjectFileSystemStructure(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`sync/${t.id}?excludeVersion=false`);return this.makeRequest(e)}))}createUserGroup(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,"groups");return this.makeRequest(i,"POST",JSON.stringify({name:e,projectId:t.id}))}))}removeUserGroup(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`groups/${e}`);return this.request(i,"DELETE")}))}listUserGroups(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`groups?projectId=${t.id}`);return this.makeRequest(e)}))}listUsersInGroup(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`groups/${e}/users`);return this.makeRequest(i)}))}addUsersToGroup(t,e,i){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(t.origin,`groups/${e}/users`),o=JSON.stringify(i.map((t=>({id:t}))));return this.makeRequest(n,"POST",o)}))}removeUsersFromGroup(t,e,i){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(t.origin,`groups/${e}/users`),o=JSON.stringify(i.map((t=>({id:t}))));return this.request(n,"DELETE",o)}))}getUserProjectDetails(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t,"projects/me");return this.makeRequest(e)}))}inviteUserToProject(t,e,i){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(t.origin,`projects/${t.id}/users`);return this.makeRequest(n,"POST",JSON.stringify({email:e,role:i}))}))}removeUserFromProject(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`projects/${t.id}/users/${e}`);return this.request(i,"DELETE")}))}listUsersByCompanyId(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t,`companies/${e}/users`);return this.makeRequest(i)}))}getProjectSettings(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`projects/${t.id}/settings`);return this.makeRequest(e)}))}putProjectSettings(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`projects/${t.id}/settings`);return this.request(i,"PATCH",JSON.stringify(e))}))}listFolderEntries(t){return K(this,void 0,void 0,(function*(){const e=t.rootId||t.id,i=nt.formatUrlFromOrigin(t.origin,`folders/${e}/items`),n=yield this.makeRequest(i);for(const e of n.data)e.origin=t.origin;return n.data.sort(((t,e)=>"FOLDER"===t.type&&"FILE"===e.type?-1:"FILE"===t.type&&"FOLDER"===e.type?1:t.name.localeCompare(e.name))),n}))}getFileStatus(t,e,i,n){return K(this,void 0,void 0,(function*(){let o=nt.formatUrlFromOrigin(t.origin,`files/${e}/status`);const r=[];return i&&r.push(`versionId=${i}`),n&&r.push(`format=${n}`),r.length>0&&(o+="?"+r.join("&")),this.makeRequest(o)}))}getProjectSyncStatus(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`projects/${t.id}/status`);return this.makeRequest(e)}))}getProjectSyncObjects(t,e,i){return K(this,void 0,void 0,(function*(){let n=nt.formatUrlFromOrigin(t.origin,`projects/${t.id}/objects`);const o=[`status=${e}`];return i&&o.push(`types=${i}`),n+="?"+o.join("&"),this.makeRequest(n)}))}getFile(t,e,i){return K(this,void 0,void 0,(function*(){let n=nt.formatUrlFromOrigin(t.origin,`files/${e}`);const o=[];i&&o.push(`versionId=${i}`),o.length>0&&(n+="?"+o.join("&"));const r=yield this.makeRequest(n);return r.data.origin=t.origin,r}))}getFileVersions(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`files/${e}/versions`),n=yield this.makeRequest(i);return n.data.forEach((e=>e.origin=t.origin)),n}))}updateFile(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`files/${e.id}`),n=yield this.makeRequest(i,"PATCH",JSON.stringify(e,((t,e)=>rt("id",t,e))));return n.data.origin=t.origin,n}))}getFolder(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`folders/${e}`),n=yield this.makeRequest(i);return n.data.origin=t.origin,n}))}getFileDownloadUrl(t,e,i){return K(this,void 0,void 0,(function*(){let n=nt.formatUrlFromOrigin(t.origin,`files/fs/${t.id}/downloadurl`);const o=[];return e&&o.push(`versionId=${e}`),i&&o.push(`format=${i}`),o.length>0&&(n+="?"+o.join("&")),this.makeRequest(n)}))}uploadFileContent(t,e,i,n){return K(this,void 0,void 0,(function*(){const o=nt.formatUrlFromOrigin(t.origin,"files/fs/initiate"),r=nt.formatUrlFromOrigin(t.origin,"files/fs/commit"),s=e.map((t=>K(this,void 0,void 0,(function*(){const e=JSON.stringify({parentId:i,parentType:n,name:t.name}),s=(yield this.makeRequest(o,"POST",e)).data;yield fetch(s.uploadURL,{method:"PUT",body:t});return yield this.makeRequest(r,"POST",JSON.stringify({uploadId:s.uploadId}))})))),a=yield Promise.all(s);return a.forEach((e=>e.data.origin=t.origin)),a}))}assimilateFile(t,e,i="TRB"){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(t.origin,`files/${e.id}/process`),o=JSON.stringify({format:i,versionId:e.versionId});return this.request(n,"POST",o)}))}putPresentationFileContent(t,e,i,n){return K(this,void 0,void 0,(function*(){const o=new FormData;o.append("file",t,t.name);const r=nt.formatUrlFromOrigin(e.origin,`files/representation?fileId=${e.id}&versionId=${n||e.versionId}&format=${i}`);return this.request(r,"POST",o,new Headers({"Content-Type":"multipart/form-data"}))}))}getImage(t,e){return K(this,void 0,void 0,(function*(){let i=e;const n=e.startsWith("/tc/static/")||e.startsWith("/tc/ng-static/")||e.startsWith("/assets/img/");if(e.startsWith("/")&&(i=(!n&&t&&"https:"+t.origin||B(this.config.serviceUri))+e),i in tt)return tt[i];if(n)return tt[i]=i;{const t=yield this.request(i),e=yield t.response.blob();return tt[i]=URL.createObjectURL(e)}}))}getPlacement(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`files/${t.id}/alignment`);if(e)try{const t=yield this.makeRequest(`${i}?versionId=${e}`,"GET");if(null==t?void 0:t.data)return t}catch(t){}return this.makeRequest(i,"GET")}))}putPlacement(t,e,i){return K(this,void 0,void 0,(function*(){let n="";i&&(n=`?versionId=${i}`);const o=nt.formatUrlFromOrigin(t.origin,`files/${t.id}/alignment${n}`);return this.makeRequest(o,"PUT",JSON.stringify(e))}))}listToDos(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`todos?projectId=${t.id}`),i=yield this.makeRequest(e);for(const e of i.data)e.origin=t.origin;return i}))}getToDo(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`todos/${e}`),n=yield this.makeRequest(i);if(n.data.origin=t.origin,n.data.projectId!==t.id)throw new Error("Item belongs to other project");return n}))}createToDo(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,"todos"),n=yield this.makeRequest(i,"POST",JSON.stringify(e,ot));return n.data.origin=t.origin,n}))}updateToDo(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`todos/${e.id}`),n=yield this.makeRequest(i,"PATCH",JSON.stringify(e,ot));return n.data.origin=t.origin,n}))}removeToDo(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`todos/${e}`);return this.request(i,"DELETE")}))}listToDoComments(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`comments?projectId=${t.projectId}&objectId=${t.id}&objectType=TODO`),i=yield this.makeRequest(e);for(const e of i.data)e.origin=t.origin;return i}))}listComments(t,e,i){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(t.origin,`comments?projectId=${t.id}&objectId=${e}&objectType=${i}`),o=yield this.makeRequest(n);for(const e of o.data)e.origin=t.origin;return o}))}listAttachments(t,e,i,n){return K(this,void 0,void 0,(function*(){const o="TODO"===n?"todos":"comments",r=nt.formatUrlFromOrigin(t,`${o}/${i}/attachments?projectId=${e}`),s=yield this.makeRequest(r);for(const e of s.data)e.origin=t;return s}))}listToDoAttachments(t){return K(this,void 0,void 0,(function*(){return this.listAttachments(t.origin,t.projectId,t.id,"TODO")}))}addAttachmentsToEntity(t,e,i,n){return K(this,void 0,void 0,(function*(){const o="TODO"===i.type?"todos":"comments",r=nt.formatUrlFromOrigin(t,`${o}/${i.id}/attachments?projectId=${e}`),s=[];n.forEach((t=>{const e="URL"===t.type?{type:t.type,url:t.id,urlName:t.urlName||""}:{type:t.type,id:t.id,embedded:t.embedded||!1};s.push(e)}));const a=JSON.stringify(s),c=yield this.makeRequest(r,"POST",a);return c.data.origin=t,c}))}attachViewToTodo(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`todos/${t.id}/attachments?projectId=${t.projectId}`),n=yield this.makeRequest(i,"POST",JSON.stringify([{type:"VIEW",id:e.id}]));return n.data.origin=t.origin,n}))}removeAttachment(t,e,i,n,o,r){return K(this,void 0,void 0,(function*(){const s="TODO"===n?"todos":"comments",a=nt.formatUrlFromOrigin(t,`${s}/${i}/attachments?projectId=${e}`);return this.request(a,"DELETE",JSON.stringify([{id:o,type:r}]))}))}createComment(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,"comments"),n=yield this.makeRequest(i,"POST",JSON.stringify(e));return n.data.origin=t.origin,n}))}updateComment(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`comments/${t.id}`),i=yield this.makeRequest(e,"PATCH",JSON.stringify({description:t.description}));return i.data.origin=t.origin,i}))}deleteComment(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`comments/${e}`);return this.request(i,"DELETE")}))}list2DViews(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`views2d?projectId=${t.id}`),i=yield this.makeRequest(e);for(const e of i.data)e.origin=t.origin;return i}))}get2DView(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`views2d/${e}`),n=yield this.makeRequest(i);if(n.data.origin=t.origin,n.data.projectId!==t.id)throw new Error("Item belongs to different project");return n}))}create2DView(t,e){return K(this,void 0,void 0,(function*(){""===e.description&&(e.description=void 0);const i=nt.formatUrlFromOrigin(t.origin,"views2d"),n=yield this.makeRequest(i,"POST",JSON.stringify(e,ot));return n.data.origin=t.origin,n}))}update2DView(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`views2d/${e.id}`),n=yield this.makeRequest(i,"PATCH",JSON.stringify(e,ot));return n.data.origin=t.origin,n}))}remove2DView(t,e,i=!1){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(t.origin,`views2d/${e}?force=${i}`);return this.request(n,"DELETE")}))}listViews(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`views?projectId=${t.id}`),i=yield this.makeRequest(e);for(const e of i.data)e.origin=t.origin;return i}))}getView(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`views/${e}`),n=yield this.makeRequest(i);if(n.data.origin=t.origin,n.data.projectId!==t.id)throw new Error("Item belongs to different project");return n}))}createView(t,e){return K(this,void 0,void 0,(function*(){""===e.description&&(e.description=void 0);const i=nt.formatUrlFromOrigin(t.origin,"views"),n=yield this.makeRequest(i,"POST",JSON.stringify(e,ot));return n.data.origin=t.origin,n}))}updateView(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`views/${e.id}`),n=yield this.makeRequest(i,"PATCH",JSON.stringify(e,ot));return n.data.origin=t.origin,n}))}removeView(t,e,i=!1){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(t.origin,`views/${e}?force=${i}`);return this.request(n,"DELETE")}))}createViewGroup(t,e,i){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(t.origin,"viewgroups"),o=yield this.makeRequest(n,"POST",JSON.stringify({projectId:t.id,name:e,views:i}));return o.data.origin=t.origin,o}))}removeViewGroup(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`viewgroups/${e}`);return this.request(i,"DELETE")}))}updateViewGroup(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`viewgroups/${e.id}`),n=yield this.makeRequest(i,"PATCH",JSON.stringify({name:e.name,views:e.views}));return n.data.origin=t.origin,n}))}listViewGroups(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`viewgroups?projectId=${t.id}`),i=yield this.makeRequest(e);for(const e of i.data)e.origin=t.origin;return i}))}listTags(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`tags?projectId=${t.id}`),i=yield this.makeRequest(e);for(const e of i.data)e.origin=t.origin;return i}))}createTag(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,"tags"),n=yield this.makeRequest(i,"POST",JSON.stringify(e,ot));return n.data.origin=t.origin,n}))}addObjectToTag(t,e,i){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(t.origin,`tags/${t.id}/objects`);return this.request(n,"POST",JSON.stringify([{id:e,objectType:i}]))}))}removeObjectFromTag(t,e,i){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(t.origin,`tags/${t.id}/objects`);return this.request(n,"DELETE",JSON.stringify([{id:e,objectType:i}]))}))}listTagsInObject(t,e,i){return K(this,void 0,void 0,(function*(){const n=nt.formatUrlFromOrigin(t.origin,`tags?objectId=${e}&objectType=${i}&projectId=${t.id}`),o=yield this.makeRequest(n);for(const e of o.data)e.origin=t.origin;return o}))}getLinksByFile(t,e,i,n=!1,o=!1){return K(this,void 0,void 0,(function*(){let r=`objectlink?id=${e}`;r+=void 0!==i?`&versionId=${i}`:"",r+=`&includeDeleted=${n}`,r+=`&full=${o}&detail=${o}`;const s=nt.formatUrlFromOrigin(t.origin,r);return this.makeRequest(s,"GET")}))}getLinksByEntity(t,e,i,n=!1){return K(this,void 0,void 0,(function*(){const o="URL"===i?encodeURIComponent(e):e,r=nt.formatUrlFromOrigin(t.origin,`objectlink/target?projectId=${t.id}&type=${i}&id=${o}&includeDeleted=${n}`);return this.makeRequest(r)}))}createObjectLink(t,e,i,n,o,r,s){return K(this,void 0,void 0,(function*(){const a=n.map((t=>({sourceId:t,type:"BIMOBJECT"}))),c={source:{id:e,versionId:i,data:a},target:{id:o,type:r}};"URL"===r&&(c.name=s);const d=nt.formatUrlFromOrigin(t.origin,"objectlink");return this.makeRequest(d,"POST",JSON.stringify(c))}))}updateObjectLink(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`objectlink/${e.id}`);return this.makeRequest(i,"PATCH",JSON.stringify(e))}))}deleteObjectLink(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`objectlink/${e}`);return this.request(i,"DELETE")}))}listClashSets(t){return K(this,void 0,void 0,(function*(){const e=nt.formatUrlFromOrigin(t.origin,`clashsets?projectId=${t.id}`),i=yield this.makeRequest(e);return i.data.forEach((e=>e.origin=t.origin)),i}))}getClashSetDetails(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`clashsets/${e}`),n=yield this.makeRequest(i);return n.data.origin=t.origin,n}))}createClashSet(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,"clashsets"),n=yield this.makeRequest(i,"POST",JSON.stringify(e,ot));return n.data.origin=t.origin,n}))}updateClashSet(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`clashsets/${e.id}`),n=yield this.makeRequest(i,"PATCH",JSON.stringify(e,ot));return n.data.origin=t.origin,n}))}deleteClashSet(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`clashsets/${e}`);return this.request(i,"DELETE")}))}getClashItems(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t.origin,`clashsets/${e}/items`),n=yield this.makeRequest(i);return n.data.forEach((e=>e.origin=t.origin)),n}))}getClashItemsWithPages(t,e,i,n=1e3){return K(this,void 0,void 0,(function*(){const o=nt.formatUrlFromOrigin(t.origin,`clashsets/${e}/items`);yield this.getItemsWithPages(o,(e=>{e.data.forEach((e=>e.origin=t.origin)),i(e)}),n)}))}getShare(t,e){return K(this,void 0,void 0,(function*(){const i=nt.formatUrlFromOrigin(t,`shares/token/${e}`),n=yield this.makeRequest(i);return n.data.origin=t,n}))}}function ot(t,e){return rt("origin",t,e)}function rt(t,e,i){return e===t?void 0:i}new nt;var st=function(t,e,i,n){return new(i||(i=Promise))((function(o,r){function s(t){try{c(n.next(t))}catch(t){r(t)}}function a(t){try{c(n.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}c((n=n.apply(t,e||[])).next())}))};new class extends Q{constructor(t){super(Object.assign(Object.assign({},{serviceUri:"https://user.connect.trimble.com/v1/"}),t))}createUserProperty(t){return st(this,void 0,void 0,(function*(){const e=`users/${t.tidUuid}/properties`;return this.makeRequest(e,"POST",JSON.stringify(t))}))}getUserProperty(t,e){return st(this,void 0,void 0,(function*(){const i=`users/${e}/properties/${t}`;return this.makeRequest(i)}))}updateUserProperty(t){return st(this,void 0,void 0,(function*(){const e=`users/${t.tidUuid}/properties/${t.key}`;return this.makeRequest(e,"PUT",JSON.stringify(t))}))}deleteUserProperty(t,e){return st(this,void 0,void 0,(function*(){const i=`users/${e}/properties/${t}`;return this.makeRequest(i,"DELETE")}))}};var at,ct={exports:{}},dt="object"==typeof Reflect?Reflect:null,ut=dt&&"function"==typeof dt.apply?dt.apply:function(t,e,i){return Function.prototype.apply.call(t,e,i)};at=dt&&"function"==typeof dt.ownKeys?dt.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var lt=Number.isNaN||function(t){return t!=t};function ft(){ft.init.call(this)}ct.exports=ft,ct.exports.once=function(t,e){return new Promise((function(i,n){function o(i){t.removeListener(e,r),n(i)}function r(){"function"==typeof t.removeListener&&t.removeListener("error",o),i([].slice.call(arguments))}kt(t,e,r,{once:!0}),"error"!==e&&function(t,e,i){"function"==typeof t.on&&kt(t,"error",e,i)}(t,o,{once:!0})}))},ft.EventEmitter=ft,ft.prototype._events=void 0,ft.prototype._eventsCount=0,ft.prototype._maxListeners=void 0;var pt=10;function gt(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function ht(t){return void 0===t._maxListeners?ft.defaultMaxListeners:t._maxListeners}function mt(t,e,i,n){var o,r,s,a;if(gt(i),void 0===(r=t._events)?(r=t._events=Object.create(null),t._eventsCount=0):(void 0!==r.newListener&&(t.emit("newListener",e,i.listener?i.listener:i),r=t._events),s=r[e]),void 0===s)s=r[e]=i,++t._eventsCount;else if("function"==typeof s?s=r[e]=n?[i,s]:[s,i]:n?s.unshift(i):s.push(i),(o=ht(t))>0&&s.length>o&&!s.warned){s.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=t,c.type=e,c.count=s.length,a=c,console&&console.warn&&console.warn(a)}return t}function yt(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function vt(t,e,i){var n={fired:!1,wrapFn:void 0,target:t,type:e,listener:i},o=yt.bind(n);return o.listener=i,n.wrapFn=o,o}function wt(t,e,i){var n=t._events;if(void 0===n)return[];var o=n[e];return void 0===o?[]:"function"==typeof o?i?[o.listener||o]:[o]:i?function(t){for(var e=new Array(t.length),i=0;i<e.length;++i)e[i]=t[i].listener||t[i];return e}(o):bt(o,o.length)}function Ot(t){var e=this._events;if(void 0!==e){var i=e[t];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function bt(t,e){for(var i=new Array(e),n=0;n<e;++n)i[n]=t[n];return i}function kt(t,e,i,n){if("function"==typeof t.on)n.once?t.once(e,i):t.on(e,i);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,(function o(r){n.once&&t.removeEventListener(e,o),i(r)}))}}Object.defineProperty(ft,"defaultMaxListeners",{enumerable:!0,get:function(){return pt},set:function(t){if("number"!=typeof t||t<0||lt(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");pt=t}}),ft.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},ft.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||lt(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},ft.prototype.getMaxListeners=function(){return ht(this)},ft.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e.push(arguments[i]);var n="error"===t,o=this._events;if(void 0!==o)n=n&&void 0===o.error;else if(!n)return!1;if(n){var r;if(e.length>0&&(r=e[0]),r instanceof Error)throw r;var s=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw s.context=r,s}var a=o[t];if(void 0===a)return!1;if("function"==typeof a)ut(a,this,e);else{var c=a.length,d=bt(a,c);for(i=0;i<c;++i)ut(d[i],this,e)}return!0},ft.prototype.addListener=function(t,e){return mt(this,t,e,!1)},ft.prototype.on=ft.prototype.addListener,ft.prototype.prependListener=function(t,e){return mt(this,t,e,!0)},ft.prototype.once=function(t,e){return gt(e),this.on(t,vt(this,t,e)),this},ft.prototype.prependOnceListener=function(t,e){return gt(e),this.prependListener(t,vt(this,t,e)),this},ft.prototype.removeListener=function(t,e){var i,n,o,r,s;if(gt(e),void 0===(n=this._events))return this;if(void 0===(i=n[t]))return this;if(i===e||i.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,i.listener||e));else if("function"!=typeof i){for(o=-1,r=i.length-1;r>=0;r--)if(i[r]===e||i[r].listener===e){s=i[r].listener,o=r;break}if(o<0)return this;0===o?i.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(i,o),1===i.length&&(n[t]=i[0]),void 0!==n.removeListener&&this.emit("removeListener",t,s||e)}return this},ft.prototype.off=ft.prototype.removeListener,ft.prototype.removeAllListeners=function(t){var e,i,n;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[t]),this;if(0===arguments.length){var o,r=Object.keys(i);for(n=0;n<r.length;++n)"removeListener"!==(o=r[n])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=i[t]))this.removeListener(t,e);else if(void 0!==e)for(n=e.length-1;n>=0;n--)this.removeListener(t,e[n]);return this},ft.prototype.listeners=function(t){return wt(this,t,!0)},ft.prototype.rawListeners=function(t){return wt(this,t,!1)},ft.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):Ot.call(t,e)},ft.prototype.listenerCount=Ot,ft.prototype.eventNames=function(){return this._eventsCount>0?at(this._events):[]};var Pt=ct.exports;let jt,Et,It;const St=new v,Tt=new Pt.EventEmitter;var $t;function Rt(t,e,i){jt=t,Et=e,It=i,jt.addEventListener("pick",(t=>{if(t.detail.modelId===m.ModelId)for(const e of jt.plugins.get(y).getIcons())if(e.id===t.detail.id){Ut($t.IconPick,e);break}Ut($t.ObjectPick,t.detail)}))}function xt(t,e){Tt.on(t,e)}function Ft(t,e){Tt.removeListener(t,e)}function Ut(t,e){Tt.emit(t,e,!1)}function qt(t){return jt.getModel(t,a)}function Lt(){return{position:jt.camera.position,quaternion:jt.camera.quaternion,rotation:Dt(jt.camera.quaternion),direction:jt.camera.direction,projectionType:jt.camera.projectionType,fieldOfView:jt.camera.fieldOfView,orthoSize:jt.camera.orthoSize}}function Ct(i){let n=i.yaw;Math.abs(i.pitch-Math.PI)<.001&&(n+=Math.PI);const o=(new t).set(i.pitch,0,n,"YZX");return(new e).setFromEuler(o)}function Dt(t){const e=new i(0,0,-1).applyQuaternion(t),n=Math.PI-Math.atan2(Math.sqrt(e.x*e.x+e.y*e.y),e.z);Math.abs(e.z)>.9999&&e.set(0,1,0).applyQuaternion(t);return{pitch:n,yaw:-Math.atan2(e.x,e.y)}}async function Nt(t,e,i){e=e.filter((t=>void 0!==t));const n=[];if(i)for(const t of e){const e=i.tryGetEntityFromPersistentIdentifier(t);if(void 0!==e)n.push(e);else{const e=i.tryGetEntityFromNonPersistentIdentifier(t);e.length?(n.push(e[0]),e.length>1&&P(`Multiple entityIds [${n.join(", ")}] were found for identifier: ${t}.`)):(n.push(void 0),E(`No entityId has been found for identifier: [${t}].`))}}else t&&n.push(...await t.guidsToEntityIds(e));return Promise.resolve(n)}async function Mt(t,e){return Array.from((await async function(t,e){const i=new Map,n=[],o=qt(t);if(o){const t=await o.getEntities(e),r=await o.getUntransformedBoundingBoxes(e);for(let e=0;e<t.length;e++){const o=t[e];try{let t=St.tryGetPersistentIdentifier(o);void 0===t&&(t=St.tryGetNonPersistentIdentifier(o,r[e])),i.set(o,t)}catch(t){i.set(o,""),n.push(o.id.toString())}}n.length&&j(`Unable to get persistent or non-persistent identifier for the following entitiIds: ${n.join(", ")}`)}return Promise.resolve(i)}(t,e)).values())}async function _t(t,e){const i=qt(t);return i?await i.getHierarchyChildren(e,!0):[]}async function At(t,e=!0){const i=await zt(t);if(i.length>0){const n=await t.getUntransformedBoundingBoxes(i),o=Math.min(...n.map((t=>t.min.z))),r=n.reduce(((t,e,n)=>(Math.abs(e.min.z-o)<.001&&t.push(i[n]),t)),[]);r&&r.length>0&&(await t.setVisibility(i.filter((t=>!r.includes(t))),!1),await t.setVisibility(r,e))}return Promise.resolve()}async function zt(t){return await t.findEntitiesByClass("IFCGRID")}!function(t){t.ActivateGhostMode="ActivateGhostMode",t.EnableGrids="EnableGrids",t.EnableObjectLinks="EnableObjectLinks",t.IconPick="IconPick",t.ObjectPick="ObjectPick"}($t||($t={}));function Vt(t){const e=oe(t.locationX,t.locationY,t.locationZ),i=C(N(t.axisX,t.axisY,t.axisZ)),n=C(U(i,N(t.refDirectionX,t.refDirectionY,t.refDirectionZ))),o=C(U(n,i)),r=t.scale;return function(t,e,i,n){return{elements:[t.x,t.y,t.z,0,e.x,e.y,e.z,0,i.x,i.y,i.z,0,n.x,n.y,n.z,1]}}(D(o,r),D(n,r),D(i,r),e)}function Xt(t){jt.tools.get(d).add({point:oe(t.positionX,t.positionY,t.positionZ),normal:ne(t.planeA,t.planeB,t.planeC)},t.width/1e3/2,t.height/1e3/2,re(t.color))}function Yt(t){return jt.tools.get(d).add({point:oe(t.position.x,t.position.y,t.position.z),normal:new i(t.normal.x,t.normal.y,t.normal.z)},t.width,t.height,re(t.color))}function Zt(t){return{normal:ne(t.directionX,t.directionY,t.directionZ),position:oe(t.positionX,t.positionY,t.positionZ)}}function Ht(t){return jt.tools.get(u).add({point:oe(t.positionX,t.positionY,t.positionZ)},{point:oe(t.position2X,t.position2Y,t.position2Z)},re(t.color))}function Jt(t){return jt.tools.get(l).add({point:oe(t.positionX,t.positionY,t.positionZ)},{point:oe(t.position2X,t.position2Y,t.position2Z)},re(t.color))}function Gt(t){return jt.tools.get(f).add({point:oe(t.positionX,t.positionY,t.positionZ)},{point:oe(t.position2X,t.position2Y,t.position2Z)},re(t.color),t.text)}function Bt(t){jt.tools.get(f).add({point:oe(t.position2X,t.position2Y,t.position2Z)},{point:oe(t.positionX,t.positionY,t.positionZ)},re(t.color),t.text)}function Wt(t){const e=[];for(const i of t.lines)e.push(oe(i.positionX,i.positionY,i.positionZ)),e.push(oe(i.position2X,i.position2Y,i.position2Z));jt.tools.get(p).add(e,re(t.color))}function Qt(t){jt.tools.get(g).add({point:oe(t.positionX,t.positionY,t.positionZ)},re(t.color))}function Kt(t,e){const n=t=>{switch(t.type){case"lineSegment":return{snapType:1,point:oe(t.positionX,t.positionY,t.positionZ),snapLineStart:oe(t.positionX,t.positionY,t.positionZ),snapLineEnd:oe(t.position2X,t.position2Y,t.position2Z)};case"point":return{id:e[t.referenceObject]?e[t.referenceObject].objectRuntimeId:void 0,model:e[t.referenceObject]?qt(e[t.referenceObject].modelVersionId):void 0,snapType:2,point:oe(t.positionX,t.positionY,t.positionZ)};case"plane":return{snapType:0,point:oe(t.positionX,t.positionY,t.positionZ),normal:ne(t.directionX,t.directionY,t.directionZ)};default:return null}};let r=n(t.start),s=n(t.end);if(0===r.snapType){const t=r;r=s,s=t,1===s.snapType&&r.point.copy(r.snapLineStart).add(r.snapLineEnd).multiplyScalar(.5)}if(1===r.snapType&&1===s.snapType){const t=r;r=s,s=t;const e=r.snapLineEnd.clone().sub(r.snapLineStart),n=s.snapLineEnd.clone().sub(s.snapLineStart),a=e.dot(n);if(Math.abs(a)<.999){const t=new o(s.snapLineStart,s.snapLineEnd).closestPointToPoint(r.point,!1,new i);r={snapType:2,point:r.point.clone()},s={snapType:2,point:t}}}if(1===r.snapType&&2===s.snapType){const t=r;r=s,s=t}return jt.tools.get(h).add(r,s,re(t.color))}function te(t){const e=new i(Math.sin(t.pitch)*Math.sin(t.yaw),-Math.sin(t.pitch)*Math.cos(t.yaw),Math.cos(t.pitch));return ie(new i(t.targetX+t.distance*e.x,t.targetY+t.distance*e.y,t.targetZ+t.distance*e.z),void 0,{pitch:t.pitch,yaw:t.yaw},t.projectionType,t.viewAngle,t.viewScale)}function ee(t){if(t&&t.quaternion){const e=new r;e.makeRotationFromQuaternion(t.quaternion);const n=new i,o=new i,s=new i;return e.extractBasis(n,o,s),o}}function ie(i,n,o,r,s,a){return{position:i&&oe(i.x,i.y,i.z),quaternion:n?n.clone().multiply((new e).setFromEuler(new t(0,Math.PI,0))):void 0,rotation:o,direction:void 0,projectionType:r,fieldOfView:s,orthoSize:a}}function ne(t,e,n){return new i(-t,-e,-n)}function oe(t,e,n){return new i(t/1e3,e/1e3,n/1e3)}function re(t){return void 0!==t.r?new n(t.r/255,t.g/255,t.b/255):void 0}function se(t){return{r:255*t.r,g:255*t.g,b:255*t.b,a:255}}function ae(t){let e=(i=t.text,(new DOMParser).parseFromString(i,"text/html").body.textContent||"").trim();var i;if(""===e)return null;e.length>250&&(e=e.substring(0,250));const{x:n,y:o,z:r}=ye(t.endPick.point),{x:s,y:a,z:c}=ye(t.startPick.point);return{type:"text",positionX:n,positionY:o,positionZ:r,position2X:s,position2Y:a,position2Z:c,color:se(t.color),text:e,screenSpaceDistance:0,width:0}}function ce(t){var e;if(t){if(t.color)return{r:255*t.color.r,g:255*t.color.g,b:255*t.color.b,a:255*(null!==(e=t.opacity)&&void 0!==e?e:1)};if(void 0!==t.opacity)return{a:255*t.opacity}}}function de(t){const{x:e,y:i,z:n}=ye(t.startPick.point),{x:o,y:r,z:s}=ye(t.endPick.point);return{type:"line",positionX:e,positionY:i,positionZ:n,position2X:o,position2Y:r,position2Z:s,color:se(t.color)}}function ue(t){const{x:e,y:i,z:n}=ye(t.startPick.point),{x:o,y:r,z:s}=ye(t.endPick.point);return{type:"arrow",positionX:e,positionY:i,positionZ:n,position2X:o,position2Y:r,position2Z:s,color:se(t.color)}}function le(t){const{x:e,y:i,z:n}=ye(t.position),{x:o,y:r,z:s}=me(t.normal);return{type:"cloud",positionX:e,positionY:i,positionZ:n,planeA:o,planeB:r,planeC:s,planeD:q(t.normal,t.position),width:1e3*t.width*2,height:1e3*t.height*2,color:se(t.color)}}function fe(t,e){const i=[];for(let e=0;e<t.points.length-1;e++){const{x:n,y:o,z:r}=ye(t.points[e].clone().applyMatrix4(t.matrixWorld)),{x:s,y:a,z:c}=ye(t.points[e+1].clone().applyMatrix4(t.matrixWorld));i.push({positionX:n,positionY:o,positionZ:r,position2X:s,position2Y:a,position2Z:c})}return{type:"redlines",camera:e,lines:i,color:se(t.color)}}function pe(t){const{x:e,y:i,z:n}=ye(t.position);return{type:"measure",positionX:e,positionY:i,positionZ:n,position2X:e,position2Y:i,position2Z:n,color:se(t.color)}}function ge(t){function e(t,e){if(2===t.snapType){const{x:i,y:n,z:o}=ye(t.point);return{type:"point",referenceObject:t.model&&t.id?e[t.model.modelId][t.id]:void 0,positionX:i,positionY:n,positionZ:o}}if(1===t.snapType){const{x:e,y:i,z:n}=ye(t.point),{x:o,y:r,z:s}=ye(t.snapLineEnd);return{type:"lineSegment",positionX:e,positionY:i,positionZ:n,position2X:o,position2Y:r,position2Z:s}}if(0===t.snapType){const{x:e,y:i,z:n}=ye(t.point),{x:o,y:r,z:s}=me(t.normal);return{type:"plane",positionX:e,positionY:i,positionZ:n,directionX:o,directionY:r,directionZ:s}}return null}const i=0!==t.axisIndex||0!==t.directionIndex,n=0===t.startPick.snapType,o=1===t.startPick.snapType&&1===t.endPick.snapType,r=1===t.startPick.snapType&&2===t.endPick.snapType,s=i||n||o||r;let a=s?{snapType:2,point:t.getMainLine().start.clone(),model:t.startPick.model,id:t.startPick.id}:t.startPick,c=s?{snapType:2,point:t.getMainLine().end.clone(),model:t.endPick.model,id:t.endPick.id}:t.endPick;if(0===a.snapType&&0===c.snapType){const t=a;a=c,c=t}return new Promise((i=>{be(t).then((n=>{i({type:"measure_with_pick",unitType:"Metric",quantityUnit:"millimeter",quantityUnitFormat:"mm",start:e(a,n),end:e(c,n),color:se(t.color)})}))}))}function he(t){return{distance:1e3,projectionType:t.projectionType,targetX:1e3*(t.position.x+t.direction.x),targetY:1e3*(t.position.y+t.direction.y),targetZ:1e3*(t.position.z+t.direction.z),viewAngle:t.fieldOfView,viewScale:t.orthoSize||0,pitch:t.rotation.pitch,yaw:t.rotation.yaw}}function me(t){return{x:-t.x,y:-t.y,z:-t.z}}function ye(t){return{x:1e3*t.x,y:1e3*t.y,z:1e3*t.z}}function ve(t){const{x:e,y:i,z:n}=me(t.normal),{x:o,y:r,z:s}=ye(t.position);return{directionX:e,directionY:i,directionZ:n,positionX:o,positionY:r,positionZ:s}}function we(t){const i=t;let n;return void 0!==i.pitch&&void 0!==i.yaw?n=void 0:i.quaternion?n=(new e).copy(i.quaternion):i.lookAt&&i.upDirection&&(n=(new e).setFromRotationMatrix((new r).lookAt(i.lookAt,i.position,i.upDirection))),Oe(i)?ie(ye(i.position),n,void 0!==i.pitch?{pitch:i.pitch,yaw:i.yaw}:void 0,i.projectionType,i.fieldOfView,i.orthoSize):function(t){return t&&void 0!==typeof t.targetX||void 0!==typeof t.targetY||void 0!==typeof t.targetZ||void 0!==typeof t.pitch||void 0!==typeof t.yaw||void 0!==typeof t.distance}(t)?te(t):void 0}function Oe(t){return t&&void 0!==typeof t.position||void 0!==typeof t.lookAt||void 0!==typeof t.quaternion}function be(t){return new Promise((e=>{const i={};Promise.all([t.startPick.model&&t.startPick.id?Mt(t.startPick.model.modelId,[t.startPick.id]):Promise.resolve([void 0]),t.endPick.model&&t.endPick.id?Mt(t.endPick.model.modelId,[t.endPick.id]):Promise.resolve([void 0])]).then((n=>{t.startPick.model&&t.startPick.id&&(i[t.startPick.model.modelId]={[t.startPick.id]:n[0][0]}),t.endPick.model&&t.endPick.id&&(i[t.endPick.model.modelId]?i[t.endPick.model.modelId][t.endPick.id]=n[1][0]:i[t.endPick.model.modelId]={[t.endPick.id]:n[1][0]}),e(i)}))}))}function ke(t){return new Promise((e=>{const i=t.models.map((t=>qt(t))).filter((t=>t)),n=t.markups.reduce(((t,e)=>{var i,n;return(null===(i=e.start)||void 0===i?void 0:i.referenceObject)&&!t.includes(e.start.referenceObject)&&t.push(e.start.referenceObject),(null===(n=e.end)||void 0===n?void 0:n.referenceObject)&&!t.includes(e.end.referenceObject)&&t.push(e.end.referenceObject),t}),[]),o=n.map((t=>new Promise((e=>{Promise.all(i.map((e=>Nt(e,[t],void 0)))).then((t=>{const n=t.findIndex((t=>!!t[0]));e(n>-1?{objectRuntimeId:t[n][0],modelVersionId:i[n].modelId}:{objectRuntimeId:void 0,modelVersionId:void 0})}))}))));Promise.all(o).then((t=>{const i=n.reduce(((e,i,n)=>(t[n].objectRuntimeId&&t[n].modelVersionId&&(e[i]=t[n]),e)),{});e(i)}))}))}const Pe=.2;var je;async function Ee(t,e,i,n){var o,r,s;let a=!0;const c=await Te(t),d=te(c.camera);await $e(d),await async function(t){if(!t)return;for(const e of Object.keys(t)){const i=jt.getModel(e);if(i){const n=t[e];for(const t of n)await i.setLayerVisibility(t,!1)}}}(n);try{Re(c.sectionPlanes)}catch(t){j("Error while loading clip planes of view.",t),a=!1}try{await xe(c)}catch(t){j("Error while loading markups of view.",t),a=!1}!async function(t){var e;const i=(null===(e=t.presentation)||void 0===e?void 0:e.transparencyLevel)?t.presentation.transparencyLevel:100;jt.settings.globalOpacity=i/100}(c),Ut($t.ActivateGhostMode,null===(o=c.presentation)||void 0===o?void 0:o.ghost),Ut($t.EnableObjectLinks,null===(r=c.presentation)||void 0===r?void 0:r.isNotesEnabled);const u=await async function(t,e,i){const n={Hidden:{},Selected:{},Colored:{}},o=function(t,e){const i=new Map;for(let n=0;n<t.files.length;n++){const o=e?e.get(t.files[n]):t.models[n],r=jt.getModel(o);r&&i.set(o,[n,o,r])}return i}(e,i),r=[];for(const i of o)r.push(new Promise((async o=>{var r,s;try{const[a,[c,d,u]]=i,l=t?t.get(a):void 0;if((null===(r=e.presentation)||void 0===r?void 0:r.elementTypes)&&await Fe(e.presentation.elementTypes,u,n,d),null===(s=e.presentation)||void 0===s?void 0:s.elements){const t=e.presentation.elements.filter((t=>t.versionId===e.models[c])),i=new Set(t.map((t=>t.state)));for(const e of i)if(qe(e)){const i=t.filter((t=>t.state===e)),o=Array.from(new Set(i.map((t=>JSON.stringify(t.color))))).map((t=>t?JSON.parse(t):void 0));for(const t of o){Ue(d,await Nt(u,i.filter((e=>Le(t,e.color))).map((t=>t.sourceId)),l),e,t,n)}}else{Ue(d,await Nt(u,t.filter((t=>t.state===e)).map((t=>t.sourceId)),l),e,void 0,n)}}await Ce(n.Hidden[d],u)}catch(t){j(`Failed to prepare entity states for model ${i[0]}`,t)}finally{o()}})));return await async function(t){return Promise.all(t.map((t=>t.then((t=>({result:t,status:"fulfilled"})),(t=>({error:t,status:"rejected"}))))))}(r),n}(e,c,i);return await async function(t,e){const i=new Map;for(const e in t.Colored)if(t.Colored.hasOwnProperty(e)){const n=t.Colored[e];for(const t of n)await jt.getModel(e).setCustomMaterial(t.entityIds,t.material);i.set(e,I(n.map((t=>t.entityIds))))}for(const e in t.Selected)t.Selected.hasOwnProperty(e)&&jt.selection.set(e,t.Selected[e]),i.has(e)?i.set(e,Array.from(new Set([...i.get(e),...t.Selected[e]]))):i.set(e,t.Selected[e]);for(const i in t.Hidden)if(t.Hidden.hasOwnProperty(i)){const n=jt.getModel(i),o=t.Hidden[i];e?(await n.setCustomMaterial(o,{opacity:.2}),await n.setPickPriority(o,2)):await n.setVisibility(o,!1)}i.forEach((async(t,e)=>{const i=jt.getModel(e),n=await i.getHierarchyParents(t,void 0,!0);n.length&&await i.setVisibility(n,!0)}))}(u,null===(s=c.presentation)||void 0===s?void 0:s.ghost),a}async function Ie(t){let e;e=Oe(t.camera)?we(t.camera):te(t.camera),await $e(e),Re(t.sectionPlanes)}async function Se(t,e,i){const n=await(o=await jt.screenshot(new s(278,156)),new Promise((t=>{const e=new FileReader;e.onload=e=>t(e.target.result),e.readAsDataURL(o)})));var o;const r=he(Lt()),a=Et.getMarkups(),m=await async function(t,e){const i=[];for(const e of t){const t=jt.selection.get(e),n=qt(e);if(n){const o=await n.getVisibleEntityIds(!1),r=await n.getEntityIdsByPickPriority(2),s=(await n.getCustomMaterialEntityIds()).filter((t=>!r.includes(t))),a=await n.getCustomMaterials(s),c=t&&t.filter((t=>o.includes(t)));let d=t,u=o;if(c&&(d=t&&t.filter((t=>!c.includes(t))),u=o.filter((t=>!c.includes(t)))),r&&r.length>0&&u.push(...r),s){const t=await Mt(e,s);for(let o=0;o<t.length;o++){const r=t[o];i.push({sourceId:r,state:it.Visible,versionId:e,color:ce(a[o]),isRecursive:o<s.length&&(await n.getHierarchyChildren([s[o]],!0)).length>0})}}if(d){const t=await Mt(e,d);for(let o=0;o<t.length;o++){const r=t[o];i.push({sourceId:r,state:it.Selected,versionId:e,isRecursive:o<d.length&&(await n.getHierarchyChildren([d[o]],!0)).length>0})}}if(u){(await Mt(e,u)).forEach((t=>{i.push({sourceId:t,state:it.Hidden,versionId:e})}))}if(c){(await Mt(e,c)).forEach((t=>{i.push({sourceId:t,state:it.SelectedHidden,versionId:e})}))}}}return{elementTypes:[],elements:i,ghost:e.ghostMode,isCriticalEnabled:!1,isDocumentsEnabled:!1,isIgnoredEnabled:!1,isNewEnabled:!1,isNotesEnabled:e.notesEnabled,isPendingEnabled:!1,isResolvedEnabled:!1,transparencyLevel:100*jt.settings.globalOpacity,transparent:1!==jt.settings.globalOpacity,wireframe:!1}}(e,i),y=jt.tools.get(c).getClipPlanes().map(ve),v=a.filter((t=>t.name!==h.Name)).map((t=>{if(t.name===f.Name)return ae(t);if(t.name===l.Name)return ue(t);if(t.name===d.Name)return le(t);if(t.name===u.Name)return de(t);if(t.name===p.Name)return fe(t,r);if(t.name===g.Name)return pe(t);throw new Error("Unknown markup type")})),w=await Promise.all(a.filter((t=>t.name===h.Name)).map((t=>new Promise((e=>{ge(t).then((t=>{e(t)}))}))))),O={origin:"",camera:r,files:t,imageData:n,markups:[...v,...w].filter((t=>null!=t)),models:e,presentation:m,sectionPlanes:y};return Promise.resolve(O)}async function Te(t){let e;if("string"==typeof t){if(e=await async function(t){return new Promise(((e,i)=>{const n=new XMLHttpRequest;n.open("GET",t,!0),n.withCredentials=!0,n.responseType="json",n.onload=()=>e(n.response),n.onerror=()=>i("Error loading "+t),n.send()}))}(t),!e)throw new Error("Error in fetching the view from JSON file")}else e=t;return Promise.resolve(e)}async function $e(t){t.projectionType&&await jt.camera.setProjectionType(t.projectionType),t.fieldOfView&&(jt.camera.fieldOfView=t.fieldOfView),t.orthoSize&&(jt.camera.orthoSize=t.orthoSize),t.position&&(jt.camera.position=t.position),t.quaternion&&(jt.camera.quaternion=t.quaternion),t.rotation&&(jt.camera.quaternion=Ct(t.rotation))}function Re(t){t&&t.map(Zt).forEach((t=>{jt.tools.get(c).add(t.position,t.normal,void 0,"view")}))}async function xe(t){if(t.markups){const e=await ke(t);t.markups.forEach((t=>{switch(t.type){case"cloud":Xt(t);break;case"line":Ht(t);break;case"arrow":Jt(t);break;case"text":Bt(t);break;case"redlines":Wt(t);break;case"measure_with_pick":Kt(t,e);break;case"measure":Qt(t);break;default:throw new Error(`Unknown markup type: '${t.type}'`)}}))}}async function Fe(t,e,i,n){for(const o of t){Ue(n,await e.findEntitiesByClass(o.type),o.state,o.color,i)}}function Ue(t,e,i,n,o){if(!(e.length<=0)&&(void 0!==i&&(function(t){if(t===it.Hidden||t===it.SelectedHidden)return!0;return!1}(i)&&(o.Hidden[t]?o.Hidden[t].push(...e):o.Hidden[t]=e),function(t){if(t===it.Selected||t===it.SelectedVisible)return!0;return!1}(i)&&(o.Selected[t]?o.Selected[t].push(...e):o.Selected[t]=e)),void 0!==n)){const i={opacity:n.a/255},r=re(n);r&&(i.color=r),o.Colored[t]?o.Colored[t].push({material:i,entityIds:e}):o.Colored[t]=[{material:i,entityIds:e}]}}function qe(t){return t===it.Visible||t===it.SelectedVisible}function Le(t,e){return t&&e?t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a:t===e}async function Ce(t,e){const i=await async function(t){return await t.findEntitiesByClass("IFCGRID")}(e);if(t){const n=i.filter((e=>!t.includes(e)));n.length>0&&(await e.setVisibility(n,!0),Ut($t.EnableGrids,!0))}else await e.setVisibility(i,!0),Ut($t.EnableGrids,!0);return Promise.resolve()}async function De(t,e){const n=[],o=jt.getModel(t);if(o&&e.length>0){const t=await o.getBoundingBoxes(e.map((t=>t.entityId)));for(let o=0;o<e.length;o++){const r=e[o],s=t[o].getCenter(new i);n.push({iconPath:r.icon,id:r.iconId,position:s,size:r.iconSize})}}return n}async function Ne(t){if(t.length)return jt.plugins.get(y).remove(t)}async function Me(t){if(t.length)return jt.plugins.get(y).add(t)}function _e(){const t=jt.plugins.get(y);if(t.getIcons().length)return t.clear()}async function Ae(t,e){return e&&e.length>0?await t.findLayersByEntities(e):await t.getLayers()}async function ze(t,e){return await t.getLayerVisibility(e)}async function Ve(t,e,i){return await t.setLayerVisibility(e,i)}!function(t){t.Extension="extension",t.View="view"}(je||(je={}));export{je as ClipPlaneOrigin,Pe as GHOST_MODE_OPACITY,$t as Web3DWrapperEventName,Re as addClipPlanes,Yt as addCloudMarkupToViewer,Jt as addConnectArrowMarkupToViewer,Xt as addConnectCloudMarkupToViewer,Wt as addConnectFreelineMarkupToViewer,Ht as addConnectLineMarkupToViewer,Kt as addConnectMeasurementMarkupToViewer,Qt as addConnectSinglePointMeasurementToViewer,Bt as addConnectTextMarkupToViewer,Me as addIcons,xe as addMarkups,Gt as addTextMarkupToViewer,_e as clearIcons,Rt as configure,we as convertApiCameraToViewerCamera,Vt as convertConnectAlignmentToViewerPlacement,ie as convertConnectCameraDetailsToViewerCamera,te as convertConnectCameraToViewerCamera,re as convertConnectColorToViewerColor,ne as convertConnectDirectionToViewerDirection,oe as convertConnectPointToViewerPoint,Zt as convertConnectSectionPlaneToViewerClipPlane,ue as convertViewerArrowMarkupToConnectMarkup,he as convertViewerCameraToConnectCamera,ve as convertViewerClipPlaneToConnectSectionPlane,le as convertViewerCloudMarkupToConnectMarkup,se as convertViewerColorToConnectColor,me as convertViewerDirectionToConnectDirection,fe as convertViewerFreelineMarkupToConnectMarkup,de as convertViewerLineMarkupToConnectMarkup,ce as convertViewerMaterialToConnectColor,ge as convertViewerMeasurementToConnectMarkup,pe as convertViewerPointMarkupToConnectMarkup,ye as convertViewerPointToConnectPoint,ae as convertViewerTextMarkupToConnectMarkup,Lt as createCameraData,De as createLinkIcons,Se as createView,Ut as emit,Tt as eventEmitter,ee as getCameraUpDirection,Nt as getEntityIds,Ue as getEntityStatesForElementTypes,zt as getGrids,ze as getLayerVisibility,Ae as getLayers,be as getObjectRuntimeIdToPersistentIdMap,_t as getPartIdsFromAssemblyIds,Mt as getPersistentIds,ke as getPersistentObjectIdToRuntimeIdMap,qt as getTrimbimModel,Te as getView,At as handleGridsVisibility,St as identifierBuilder,Oe as isApiCamera,Ie as loadAPIView,Ee as loadViewToWeb3D,Et as markupPlugin,xt as on,Dt as quaternionToRotation,Ft as removeEventListener,Ne as removeIcons,Ct as rotationToQuaternion,Ve as setLayerVisibility,It as trimbimPlugin,jt as web3DViewer};
