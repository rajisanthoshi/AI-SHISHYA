define(["exports","three.mjs"],(function(t,e){"use strict";class n{constructor(){this.observableOptions={button:0,touchCount:1}}get mouseButton(){return this.observableOptions.button}set mouseButton(t){this.observableOptions.button=t}get touchCount(){return this.observableOptions.touchCount}set touchCount(t){this.observableOptions.touchCount=t}}class r extends e.Raycaster{constructor(){super()}}function i(t){if(0===t.x)return t.y>0?Math.PI/2:-Math.PI/2;if(0===t.y)return t.x>0?0:Math.PI;{const e=Math.atan2(Math.abs(t.y),Math.abs(t.x));return t.x<0?t.y<0?e+Math.PI:e+Math.PI/2:t.y<0?e+1.5*Math.PI:e}}function o(t){const e={x:0,y:0},n=0!==t.touches.length?t.touches:t.changedTouches;for(const t of n)e.x+=t.clientX,e.y+=t.clientY;return e.x/=n.length,e.y/=n.length,e}const s={mm:{inMillimeters:1,symbol:"mm"},cm:{inMillimeters:10,symbol:"cm"},m:{inMillimeters:1e3,symbol:"m"},km:{inMillimeters:1e6,symbol:"km"},ft:{inMillimeters:304.8,symbol:"ft"},in:{inMillimeters:25.4,symbol:"in"},yd:{inMillimeters:914.4,symbol:"yd"},mi:{inMillimeters:1609344,symbol:"mi"},custom:{inMillimeters:1e3,symbol:"m"}};function c(t,e,n=2){const r=s[e];return`${function(t,e){const n=Math.pow(10,e);return Math.round(t*n)/n}(t/r.inMillimeters,n)} ${r.symbol}`}const u=new e.Vector3;function a(t,n,r){let i;t.renderOrder=1,t.traverse((t=>{t instanceof e.Mesh&&(i=t)})),i.onBeforeRender=()=>{let e=n.camera.getProjectionCompensatingScale(t.getWorldPosition(u).distanceTo(n.camera.position));r&&(e=r(e)),t.scale.set(e,e,e),t.updateMatrixWorld(!0)}}
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
var h=function(t,e){return(h=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function l(t,e){function n(){this.constructor=t}h(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function p(t){return"function"==typeof t}var f=!1,d={Promise:void 0,set useDeprecatedSynchronousErrorHandling(t){t&&(new Error).stack;f=t},get useDeprecatedSynchronousErrorHandling(){return f}};function b(t){setTimeout((function(){throw t}),0)}var y={closed:!0,next:function(t){},error:function(t){if(d.useDeprecatedSynchronousErrorHandling)throw t;b(t)},complete:function(){}},v=function(){return Array.isArray||function(t){return t&&"number"==typeof t.length}}();function _(t){return null!==t&&"object"==typeof t}var m=function(){function t(t){return Error.call(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(t,e){return e+1+") "+t.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t,this}return t.prototype=Object.create(Error.prototype),t}(),w=function(){function t(t){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,t&&(this._ctorUnsubscribe=!0,this._unsubscribe=t)}return t.prototype.unsubscribe=function(){var e;if(!this.closed){var n=this,r=n._parentOrParents,i=n._ctorUnsubscribe,o=n._unsubscribe,s=n._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,r instanceof t)r.remove(this);else if(null!==r)for(var c=0;c<r.length;++c){r[c].remove(this)}if(p(o)){i&&(this._unsubscribe=void 0);try{o.call(this)}catch(t){e=t instanceof m?g(t.errors):[t]}}if(v(s)){c=-1;for(var u=s.length;++c<u;){var a=s[c];if(_(a))try{a.unsubscribe()}catch(t){e=e||[],t instanceof m?e=e.concat(g(t.errors)):e.push(t)}}}if(e)throw new m(e)}},t.prototype.add=function(e){var n=e;if(!e)return t.EMPTY;switch(typeof e){case"function":n=new t(e);case"object":if(n===this||n.closed||"function"!=typeof n.unsubscribe)return n;if(this.closed)return n.unsubscribe(),n;if(!(n instanceof t)){var r=n;(n=new t)._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}var i=n._parentOrParents;if(null===i)n._parentOrParents=this;else if(i instanceof t){if(i===this)return n;n._parentOrParents=[i,this]}else{if(-1!==i.indexOf(this))return n;i.push(this)}var o=this._subscriptions;return null===o?this._subscriptions=[n]:o.push(n),n},t.prototype.remove=function(t){var e=this._subscriptions;if(e){var n=e.indexOf(t);-1!==n&&e.splice(n,1)}},t.EMPTY=function(t){return t.closed=!0,t}(new t),t}();function g(t){return t.reduce((function(t,e){return t.concat(e instanceof m?e.errors:e)}),[])}var x=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),S=function(t){function e(n,r,i){var o=t.call(this)||this;switch(o.syncErrorValue=null,o.syncErrorThrown=!1,o.syncErrorThrowable=!1,o.isStopped=!1,arguments.length){case 0:o.destination=y;break;case 1:if(!n){o.destination=y;break}if("object"==typeof n){n instanceof e?(o.syncErrorThrowable=n.syncErrorThrowable,o.destination=n,n.add(o)):(o.syncErrorThrowable=!0,o.destination=new E(o,n));break}default:o.syncErrorThrowable=!0,o.destination=new E(o,n,r,i)}return o}return l(e,t),e.prototype[x]=function(){return this},e.create=function(t,n,r){var i=new e(t,n,r);return i.syncErrorThrowable=!1,i},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this))},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){this.destination.error(t),this.unsubscribe()},e.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},e.prototype._unsubscribeAndRecycle=function(){var t=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=t,this},e}(w),E=function(t){function e(e,n,r,i){var o,s=t.call(this)||this;s._parentSubscriber=e;var c=s;return p(n)?o=n:n&&(o=n.next,r=n.error,i=n.complete,n!==y&&(p((c=Object.create(n)).unsubscribe)&&s.add(c.unsubscribe.bind(c)),c.unsubscribe=s.unsubscribe.bind(s))),s._context=c,s._next=o,s._error=r,s._complete=i,s}return l(e,t),e.prototype.next=function(t){if(!this.isStopped&&this._next){var e=this._parentSubscriber;d.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?this.__tryOrSetError(e,this._next,t)&&this.unsubscribe():this.__tryOrUnsub(this._next,t)}},e.prototype.error=function(t){if(!this.isStopped){var e=this._parentSubscriber,n=d.useDeprecatedSynchronousErrorHandling;if(this._error)n&&e.syncErrorThrowable?(this.__tryOrSetError(e,this._error,t),this.unsubscribe()):(this.__tryOrUnsub(this._error,t),this.unsubscribe());else if(e.syncErrorThrowable)n?(e.syncErrorValue=t,e.syncErrorThrown=!0):b(t),this.unsubscribe();else{if(this.unsubscribe(),n)throw t;b(t)}}},e.prototype.complete=function(){var t=this;if(!this.isStopped){var e=this._parentSubscriber;if(this._complete){var n=function(){return t._complete.call(t._context)};d.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?(this.__tryOrSetError(e,n),this.unsubscribe()):(this.__tryOrUnsub(n),this.unsubscribe())}else this.unsubscribe()}},e.prototype.__tryOrUnsub=function(t,e){try{t.call(this._context,e)}catch(t){if(this.unsubscribe(),d.useDeprecatedSynchronousErrorHandling)throw t;b(t)}},e.prototype.__tryOrSetError=function(t,e,n){if(!d.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{e.call(this._context,n)}catch(e){return d.useDeprecatedSynchronousErrorHandling?(t.syncErrorValue=e,t.syncErrorThrown=!0,!0):(b(e),!0)}return!1},e.prototype._unsubscribe=function(){var t=this._parentSubscriber;this._context=null,this._parentSubscriber=null,t.unsubscribe()},e}(S);var T=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function C(t){return t}function M(t){return 0===t.length?C:1===t.length?t[0]:function(e){return t.reduce((function(t,e){return e(t)}),e)}}var O=function(){function t(t){this._isScalar=!1,t&&(this._subscribe=t)}return t.prototype.lift=function(e){var n=new t;return n.source=this,n.operator=e,n},t.prototype.subscribe=function(t,e,n){var r=this.operator,i=function(t,e,n){if(t){if(t instanceof S)return t;if(t[x])return t[x]()}return t||e||n?new S(t,e,n):new S(y)}(t,e,n);if(r?i.add(r.call(i,this.source)):i.add(this.source||d.useDeprecatedSynchronousErrorHandling&&!i.syncErrorThrowable?this._subscribe(i):this._trySubscribe(i)),d.useDeprecatedSynchronousErrorHandling&&i.syncErrorThrowable&&(i.syncErrorThrowable=!1,i.syncErrorThrown))throw i.syncErrorValue;return i},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){d.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),!function(t){for(;t;){var e=t,n=e.closed,r=e.destination,i=e.isStopped;if(n||i)return!1;t=r&&r instanceof S?r:null}return!0}(t)?console.warn(e):t.error(e)}},t.prototype.forEach=function(t,e){var n=this;return new(e=I(e))((function(e,r){var i;i=n.subscribe((function(e){try{t(e)}catch(t){r(t),i&&i.unsubscribe()}}),r,e)}))},t.prototype._subscribe=function(t){var e=this.source;return e&&e.subscribe(t)},t.prototype[T]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return 0===t.length?this:M(t)(this)},t.prototype.toPromise=function(t){var e=this;return new(t=I(t))((function(t,n){var r;e.subscribe((function(t){return r=t}),(function(t){return n(t)}),(function(){return t(r)}))}))},t.create=function(e){return new t(e)},t}();function I(t){if(t||(t=Promise),!t)throw new Error("no Promise impl found");return t}var D=function(){function t(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return t.prototype=Object.create(Error.prototype),t}(),N=function(t){function e(e,n){var r=t.call(this)||this;return r.subject=e,r.subscriber=n,r.closed=!1,r}return l(e,t),e.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var t=this.subject,e=t.observers;if(this.subject=null,e&&0!==e.length&&!t.isStopped&&!t.closed){var n=e.indexOf(this.subscriber);-1!==n&&e.splice(n,1)}}},e}(w),P=function(t){function e(e){var n=t.call(this,e)||this;return n.destination=e,n}return l(e,t),e}(S),H=function(t){function e(){var e=t.call(this)||this;return e.observers=[],e.closed=!1,e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return l(e,t),e.prototype[x]=function(){return new P(this)},e.prototype.lift=function(t){var e=new k(this,this);return e.operator=t,e},e.prototype.next=function(t){if(this.closed)throw new D;if(!this.isStopped)for(var e=this.observers,n=e.length,r=e.slice(),i=0;i<n;i++)r[i].next(t)},e.prototype.error=function(t){if(this.closed)throw new D;this.hasError=!0,this.thrownError=t,this.isStopped=!0;for(var e=this.observers,n=e.length,r=e.slice(),i=0;i<n;i++)r[i].error(t);this.observers.length=0},e.prototype.complete=function(){if(this.closed)throw new D;this.isStopped=!0;for(var t=this.observers,e=t.length,n=t.slice(),r=0;r<e;r++)n[r].complete();this.observers.length=0},e.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},e.prototype._trySubscribe=function(e){if(this.closed)throw new D;return t.prototype._trySubscribe.call(this,e)},e.prototype._subscribe=function(t){if(this.closed)throw new D;return this.hasError?(t.error(this.thrownError),w.EMPTY):this.isStopped?(t.complete(),w.EMPTY):(this.observers.push(t),new N(this,t))},e.prototype.asObservable=function(){var t=new O;return t.source=this,t},e.create=function(t,e){return new k(t,e)},e}(O),k=function(t){function e(e,n){var r=t.call(this)||this;return r.destination=e,r.source=n,r}return l(e,t),e.prototype.next=function(t){var e=this.destination;e&&e.next&&e.next(t)},e.prototype.error=function(t){var e=this.destination;e&&e.error&&this.destination.error(t)},e.prototype.complete=function(){var t=this.destination;t&&t.complete&&this.destination.complete()},e.prototype._subscribe=function(t){return this.source?this.source.subscribe(t):w.EMPTY},e}(H);var j=function(){function t(t){this.connectable=t}return t.prototype.call=function(t,e){var n=this.connectable;n._refCount++;var r=new R(t,n),i=e.subscribe(r);return r.closed||(r.connection=n.connect()),i},t}(),R=function(t){function e(e,n){var r=t.call(this,e)||this;return r.connectable=n,r}return l(e,t),e.prototype._unsubscribe=function(){var t=this.connectable;if(t){this.connectable=null;var e=t._refCount;if(e<=0)this.connection=null;else if(t._refCount=e-1,e>1)this.connection=null;else{var n=this.connection,r=t._connection;this.connection=null,!r||n&&r!==n||r.unsubscribe()}}else this.connection=null},e}(S),V=function(t){function e(e,n){var r=t.call(this)||this;return r.source=e,r.subjectFactory=n,r._refCount=0,r._isComplete=!1,r}return l(e,t),e.prototype._subscribe=function(t){return this.getSubject().subscribe(t)},e.prototype.getSubject=function(){var t=this._subject;return t&&!t.isStopped||(this._subject=this.subjectFactory()),this._subject},e.prototype.connect=function(){var t=this._connection;return t||(this._isComplete=!1,(t=this._connection=new w).add(this.source.subscribe(new $(this.getSubject(),this))),t.closed&&(this._connection=null,t=w.EMPTY)),t},e.prototype.refCount=function(){return(t=this).lift(new j(t));var t},e}(O),A=function(){var t=V.prototype;return{operator:{value:null},_refCount:{value:0,writable:!0},_subject:{value:null,writable:!0},_connection:{value:null,writable:!0},_subscribe:{value:t._subscribe},_isComplete:{value:t._isComplete,writable:!0},getSubject:{value:t.getSubject},connect:{value:t.connect},refCount:{value:t.refCount}}}(),$=function(t){function e(e,n){var r=t.call(this,e)||this;return r.connectable=n,r}return l(e,t),e.prototype._error=function(e){this._unsubscribe(),t.prototype._error.call(this,e)},e.prototype._complete=function(){this.connectable._isComplete=!0,this._unsubscribe(),t.prototype._complete.call(this)},e.prototype._unsubscribe=function(){var t=this.connectable;if(t){this.connectable=null;var e=t._connection;t._refCount=0,t._subject=null,t._connection=null,e&&e.unsubscribe()}},e}(P),L=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.scheduler=e,r.work=n,r.pending=!1,r}return l(e,t),e.prototype.schedule=function(t,e){if(void 0===e&&(e=0),this.closed)return this;this.state=t;var n=this.id,r=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(r,n,e)),this.pending=!0,this.delay=e,this.id=this.id||this.requestAsyncId(r,this.id,e),this},e.prototype.requestAsyncId=function(t,e,n){return void 0===n&&(n=0),setInterval(t.flush.bind(t,this),n)},e.prototype.recycleAsyncId=function(t,e,n){if(void 0===n&&(n=0),null!==n&&this.delay===n&&!1===this.pending)return e;clearInterval(e)},e.prototype.execute=function(t,e){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(t,e);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,e){var n=!1,r=void 0;try{this.work(t)}catch(t){n=!0,r=!!t&&t||new Error(t)}if(n)return this.unsubscribe(),r},e.prototype._unsubscribe=function(){var t=this.id,e=this.scheduler,n=e.actions,r=n.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==r&&n.splice(r,1),null!=t&&(this.id=this.recycleAsyncId(e,t,null)),this.delay=null},e}(function(t){function e(e,n){return t.call(this)||this}return l(e,t),e.prototype.schedule=function(t,e){return this},e}(w)),B=function(){function t(e,n){void 0===n&&(n=t.now),this.SchedulerAction=e,this.now=n}return t.prototype.schedule=function(t,e,n){return void 0===e&&(e=0),new this.SchedulerAction(this,t).schedule(n,e)},t.now=function(){return Date.now()},t}(),Y=function(t){function e(n,r){void 0===r&&(r=B.now);var i=t.call(this,n,(function(){return e.delegate&&e.delegate!==i?e.delegate.now():r()}))||this;return i.actions=[],i.active=!1,i.scheduled=void 0,i}return l(e,t),e.prototype.schedule=function(n,r,i){return void 0===r&&(r=0),e.delegate&&e.delegate!==this?e.delegate.schedule(n,r,i):t.prototype.schedule.call(this,n,r,i)},e.prototype.flush=function(t){var e=this.actions;if(this.active)e.push(t);else{var n;this.active=!0;do{if(n=t.execute(t.state,t.delay))break}while(t=e.shift());if(this.active=!1,n){for(;t=e.shift();)t.unsubscribe();throw n}}},e}(B),F=new O((function(t){return t.complete()}));function U(t){return t?function(t){return new O((function(e){return t.schedule((function(){return e.complete()}))}))}(t):F}function z(t){return t&&"function"==typeof t.schedule}var X=function(t){return function(e){for(var n=0,r=t.length;n<r&&!e.closed;n++)e.next(t[n]);e.complete()}};function K(t,e){return new O((function(n){var r=new w,i=0;return r.add(e.schedule((function(){i!==t.length?(n.next(t[i++]),n.closed||r.add(this.schedule())):n.complete()}))),r}))}function W(t,e){return e?K(t,e):new O(X(t))}function q(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t[t.length-1];return z(n)?(t.pop(),K(t,n)):W(t)}function G(t){var e=t.error;t.subscriber.error(e)}var Z=function(){function t(t,e,n){this.kind=t,this.value=e,this.error=n,this.hasValue="N"===t}return t.prototype.observe=function(t){switch(this.kind){case"N":return t.next&&t.next(this.value);case"E":return t.error&&t.error(this.error);case"C":return t.complete&&t.complete()}},t.prototype.do=function(t,e,n){switch(this.kind){case"N":return t&&t(this.value);case"E":return e&&e(this.error);case"C":return n&&n()}},t.prototype.accept=function(t,e,n){return t&&"function"==typeof t.next?this.observe(t):this.do(t,e,n)},t.prototype.toObservable=function(){var t,e;switch(this.kind){case"N":return q(this.value);case"E":return t=this.error,new O(e?function(n){return e.schedule(G,0,{error:t,subscriber:n})}:function(e){return e.error(t)});case"C":return U()}throw new Error("unexpected notification kind value")},t.createNext=function(e){return void 0!==e?new t("N",e):t.undefinedValueNotification},t.createError=function(e){return new t("E",void 0,e)},t.createComplete=function(){return t.completeNotification},t.completeNotification=new t("C"),t.undefinedValueNotification=new t("N",void 0),t}(),J=new Y(L);function Q(){}function tt(t,e){return function(n){if("function"!=typeof t)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return n.lift(new et(t,e))}}var et=function(){function t(t,e){this.project=t,this.thisArg=e}return t.prototype.call=function(t,e){return e.subscribe(new nt(t,this.project,this.thisArg))},t}(),nt=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.project=n,i.count=0,i.thisArg=r||i,i}return l(e,t),e.prototype._next=function(t){var e;try{e=this.project.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}this.destination.next(e)},e}(S);function rt(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}var it=rt(),ot=function(t){return t&&"number"==typeof t.length&&"function"!=typeof t};function st(t){return!!t&&"function"!=typeof t.subscribe&&"function"==typeof t.then}var ct=function(t){if(t&&"function"==typeof t[T])return r=t,function(t){var e=r[T]();if("function"!=typeof e.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return e.subscribe(t)};if(ot(t))return X(t);if(st(t))return n=t,function(t){return n.then((function(e){t.closed||(t.next(e),t.complete())}),(function(e){return t.error(e)})).then(null,b),t};if(t&&"function"==typeof t[it])return e=t,function(t){for(var n=e[it]();;){var r=void 0;try{r=n.next()}catch(e){return t.error(e),t}if(r.done){t.complete();break}if(t.next(r.value),t.closed)break}return"function"==typeof n.return&&t.add((function(){n.return&&n.return()})),t};var e,n,r,i=_(t)?"an invalid object":"'"+t+"'";throw new TypeError("You provided "+i+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function ut(t,e){if(null!=t){if(function(t){return t&&"function"==typeof t[T]}(t))return function(t,e){return new O((function(n){var r=new w;return r.add(e.schedule((function(){var i=t[T]();r.add(i.subscribe({next:function(t){r.add(e.schedule((function(){return n.next(t)})))},error:function(t){r.add(e.schedule((function(){return n.error(t)})))},complete:function(){r.add(e.schedule((function(){return n.complete()})))}}))}))),r}))}(t,e);if(st(t))return function(t,e){return new O((function(n){var r=new w;return r.add(e.schedule((function(){return t.then((function(t){r.add(e.schedule((function(){n.next(t),r.add(e.schedule((function(){return n.complete()})))})))}),(function(t){r.add(e.schedule((function(){return n.error(t)})))}))}))),r}))}(t,e);if(ot(t))return K(t,e);if(function(t){return t&&"function"==typeof t[it]}(t)||"string"==typeof t)return function(t,e){if(!t)throw new Error("Iterable cannot be null");return new O((function(n){var r,i=new w;return i.add((function(){r&&"function"==typeof r.return&&r.return()})),i.add(e.schedule((function(){r=t[it](),i.add(e.schedule((function(){if(!n.closed){var t,e;try{var i=r.next();t=i.value,e=i.done}catch(t){return void n.error(t)}e?n.complete():(n.next(t),this.schedule())}})))}))),i}))}(t,e)}throw new TypeError((null!==t&&typeof t||t)+" is not observable")}function at(t,e){return e?ut(t,e):t instanceof O?t:new O(ct(t))}var ht=function(t){function e(e){var n=t.call(this)||this;return n.parent=e,n}return l(e,t),e.prototype._next=function(t){this.parent.notifyNext(t)},e.prototype._error=function(t){this.parent.notifyError(t),this.unsubscribe()},e.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},e}(S),lt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return l(e,t),e.prototype.notifyNext=function(t){this.destination.next(t)},e.prototype.notifyError=function(t){this.destination.error(t)},e.prototype.notifyComplete=function(){this.destination.complete()},e}(S);function pt(t,e){if(!e.closed){if(t instanceof O)return t.subscribe(e);var n;try{n=ct(t)(e)}catch(t){e.error(t)}return n}}function ft(t,e,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),"function"==typeof e?function(r){return r.pipe(ft((function(n,r){return at(t(n,r)).pipe(tt((function(t,i){return e(n,t,r,i)})))}),n))}:("number"==typeof e&&(n=e),function(e){return e.lift(new dt(t,n))})}var dt=function(){function t(t,e){void 0===e&&(e=Number.POSITIVE_INFINITY),this.project=t,this.concurrent=e}return t.prototype.call=function(t,e){return e.subscribe(new bt(t,this.project,this.concurrent))},t}(),bt=function(t){function e(e,n,r){void 0===r&&(r=Number.POSITIVE_INFINITY);var i=t.call(this,e)||this;return i.project=n,i.concurrent=r,i.hasCompleted=!1,i.buffer=[],i.active=0,i.index=0,i}return l(e,t),e.prototype._next=function(t){this.active<this.concurrent?this._tryNext(t):this.buffer.push(t)},e.prototype._tryNext=function(t){var e,n=this.index++;try{e=this.project(t,n)}catch(t){return void this.destination.error(t)}this.active++,this._innerSub(e)},e.prototype._innerSub=function(t){var e=new ht(this),n=this.destination;n.add(e);var r=pt(t,e);r!==e&&n.add(r)},e.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete(),this.unsubscribe()},e.prototype.notifyNext=function(t){this.destination.next(t)},e.prototype.notifyComplete=function(){var t=this.buffer;this.active--,t.length>0?this._next(t.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},e}(lt);function yt(t){return void 0===t&&(t=Number.POSITIVE_INFINITY),ft(C,t)}function vt(t,e,n,r){return p(n)&&(r=n,n=void 0),r?vt(t,e,n).pipe(tt((function(t){return v(t)?r.apply(void 0,t):r(t)}))):new O((function(r){_t(t,e,(function(t){arguments.length>1?r.next(Array.prototype.slice.call(arguments)):r.next(t)}),r,n)}))}function _t(t,e,n,r,i){var o;if(function(t){return t&&"function"==typeof t.addEventListener&&"function"==typeof t.removeEventListener}(t)){var s=t;t.addEventListener(e,n,i),o=function(){return s.removeEventListener(e,n,i)}}else if(function(t){return t&&"function"==typeof t.on&&"function"==typeof t.off}(t)){var c=t;t.on(e,n),o=function(){return c.off(e,n)}}else if(function(t){return t&&"function"==typeof t.addListener&&"function"==typeof t.removeListener}(t)){var u=t;t.addListener(e,n),o=function(){return u.removeListener(e,n)}}else{if(!t||!t.length)throw new TypeError("Invalid event target");for(var a=0,h=t.length;a<h;a++)_t(t[a],e,n,r,i)}r.add(o)}function mt(t){return!v(t)&&t-parseFloat(t)+1>=0}function wt(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Number.POSITIVE_INFINITY,r=null,i=t[t.length-1];return z(i)?(r=t.pop(),t.length>1&&"number"==typeof t[t.length-1]&&(n=t.pop())):"number"==typeof i&&(n=t.pop()),null===r&&1===t.length&&t[0]instanceof O?t[0]:yt(n)(W(t,r))}function gt(t,e){return function(n){return n.lift(new xt(t,e))}}var xt=function(){function t(t,e){this.predicate=t,this.thisArg=e}return t.prototype.call=function(t,e){return e.subscribe(new St(t,this.predicate,this.thisArg))},t}(),St=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.predicate=n,i.thisArg=r,i.count=0,i}return l(e,t),e.prototype._next=function(t){var e;try{e=this.predicate.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}e&&this.destination.next(t)},e}(S);function Et(t){var e=t.index,n=t.period,r=t.subscriber;if(r.next(e),!r.closed){if(-1===n)return r.complete();t.index=e+1,this.schedule(t,n)}}var Tt=function(){function t(t){this.closingNotifier=t}return t.prototype.call=function(t,e){return e.subscribe(new Ct(t,this.closingNotifier))},t}(),Ct=function(t){function e(e,n){var r=t.call(this,e)||this;return r.buffer=[],r.add(pt(n,new ht(r))),r}return l(e,t),e.prototype._next=function(t){this.buffer.push(t)},e.prototype.notifyNext=function(){var t=this.buffer;this.buffer=[],this.destination.next(t)},e}(lt);function Mt(t,e){return void 0===e&&(e=J),function(n){return n.lift(new Ot(t,e))}}var Ot=function(){function t(t,e){this.dueTime=t,this.scheduler=e}return t.prototype.call=function(t,e){return e.subscribe(new It(t,this.dueTime,this.scheduler))},t}(),It=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.dueTime=n,i.scheduler=r,i.debouncedSubscription=null,i.lastValue=null,i.hasValue=!1,i}return l(e,t),e.prototype._next=function(t){this.clearDebounce(),this.lastValue=t,this.hasValue=!0,this.add(this.debouncedSubscription=this.scheduler.schedule(Dt,this.dueTime,this))},e.prototype._complete=function(){this.debouncedNext(),this.destination.complete()},e.prototype.debouncedNext=function(){if(this.clearDebounce(),this.hasValue){var t=this.lastValue;this.lastValue=null,this.hasValue=!1,this.destination.next(t)}},e.prototype.clearDebounce=function(){var t=this.debouncedSubscription;null!==t&&(this.remove(t),t.unsubscribe(),this.debouncedSubscription=null)},e}(S);function Dt(t){t.debouncedNext()}function Nt(t,e){void 0===e&&(e=J);var n,r=(n=t)instanceof Date&&!isNaN(+n)?+t-e.now():Math.abs(t);return function(t){return t.lift(new Pt(r,e))}}var Pt=function(){function t(t,e){this.delay=t,this.scheduler=e}return t.prototype.call=function(t,e){return e.subscribe(new Ht(t,this.delay,this.scheduler))},t}(),Ht=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.delay=n,i.scheduler=r,i.queue=[],i.active=!1,i.errored=!1,i}return l(e,t),e.dispatch=function(t){for(var e=t.source,n=e.queue,r=t.scheduler,i=t.destination;n.length>0&&n[0].time-r.now()<=0;)n.shift().notification.observe(i);if(n.length>0){var o=Math.max(0,n[0].time-r.now());this.schedule(t,o)}else this.unsubscribe(),e.active=!1},e.prototype._schedule=function(t){this.active=!0,this.destination.add(t.schedule(e.dispatch,this.delay,{source:this,destination:this.destination,scheduler:t}))},e.prototype.scheduleNotification=function(t){if(!0!==this.errored){var e=this.scheduler,n=new kt(e.now()+this.delay,t);this.queue.push(n),!1===this.active&&this._schedule(e)}},e.prototype._next=function(t){this.scheduleNotification(Z.createNext(t))},e.prototype._error=function(t){this.errored=!0,this.queue=[],this.destination.error(t),this.unsubscribe()},e.prototype._complete=function(){this.scheduleNotification(Z.createComplete()),this.unsubscribe()},e}(S),kt=function(){return function(t,e){this.time=t,this.notification=e}}();function jt(t,e){return function(n){var r;if(r="function"==typeof t?t:function(){return t},"function"==typeof e)return n.lift(new Rt(r,e));var i=Object.create(n,A);return i.source=n,i.subjectFactory=r,i}}var Rt=function(){function t(t,e){this.subjectFactory=t,this.selector=e}return t.prototype.call=function(t,e){var n=this.selector,r=this.subjectFactory(),i=n(r).subscribe(t);return i.add(e.subscribe(r)),i},t}();function Vt(t){return t?jt((function(){return new H}),t):jt(new H)}function At(t,e){return"function"==typeof e?function(n){return n.pipe(At((function(n,r){return at(t(n,r)).pipe(tt((function(t,i){return e(n,t,r,i)})))})))}:function(e){return e.lift(new $t(t))}}var $t=function(){function t(t){this.project=t}return t.prototype.call=function(t,e){return e.subscribe(new Lt(t,this.project))},t}(),Lt=function(t){function e(e,n){var r=t.call(this,e)||this;return r.project=n,r.index=0,r}return l(e,t),e.prototype._next=function(t){var e,n=this.index++;try{e=this.project(t,n)}catch(t){return void this.destination.error(t)}this._innerSub(e)},e.prototype._innerSub=function(t){var e=this.innerSubscription;e&&e.unsubscribe();var n=new ht(this),r=this.destination;r.add(n),this.innerSubscription=pt(t,n),this.innerSubscription!==n&&r.add(this.innerSubscription)},e.prototype._complete=function(){var e=this.innerSubscription;e&&!e.closed||t.prototype._complete.call(this),this.unsubscribe()},e.prototype._unsubscribe=function(){this.innerSubscription=void 0},e.prototype.notifyComplete=function(){this.innerSubscription=void 0,this.isStopped&&t.prototype._complete.call(this)},e.prototype.notifyNext=function(t){this.destination.next(t)},e}(lt);function Bt(t){return function(e){return e.lift(new Yt(t))}}var Yt=function(){function t(t){this.notifier=t}return t.prototype.call=function(t,e){var n=new Ft(t),r=pt(this.notifier,new ht(n));return r&&!n.seenValue?(n.add(r),e.subscribe(n)):n},t}(),Ft=function(t){function e(e){var n=t.call(this,e)||this;return n.seenValue=!1,n}return l(e,t),e.prototype.notifyNext=function(){this.seenValue=!0,this.complete()},e.prototype.notifyComplete=function(){},e}(lt);function Ut(t,e,n){return function(r){return r.lift(new zt(t,e,n))}}var zt=function(){function t(t,e,n){this.nextOrObserver=t,this.error=e,this.complete=n}return t.prototype.call=function(t,e){return e.subscribe(new Xt(t,this.nextOrObserver,this.error,this.complete))},t}(),Xt=function(t){function e(e,n,r,i){var o=t.call(this,e)||this;return o._tapNext=Q,o._tapError=Q,o._tapComplete=Q,o._tapError=r||Q,o._tapComplete=i||Q,p(n)?(o._context=o,o._tapNext=n):n&&(o._context=n,o._tapNext=n.next||Q,o._tapError=n.error||Q,o._tapComplete=n.complete||Q),o}return l(e,t),e.prototype._next=function(t){try{this._tapNext.call(this._context,t)}catch(t){return void this.destination.error(t)}this.destination.next(t)},e.prototype._error=function(t){try{this._tapError.call(this._context,t)}catch(t){return void this.destination.error(t)}this.destination.error(t)},e.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(t){return void this.destination.error(t)}return this.destination.complete()},e}(S);const Kt=t=>e=>Wt(e,t);function Wt(t,e){return!e||t.mouseButton===e.button&&!t.isTouch||t.touchCount===e.touchCount&&t.isTouch}const qt=(t,e)=>wt(t.pointerUp$.pipe(gt((t=>t.mouseButton===e.button||t.touchCount!==e.touchCount&&t.isTouch))),t.pointerMove$.pipe(gt((t=>!t.isTouch&&!t.anyMouseButtonDown||t.isTouch&&t.touchCount!==e.touchCount)))),Gt=t=>!(!t||!t.intersection),Zt=(t,n)=>async r=>(r.intersection=await t.pick(new e.Vector2(r.x,r.y),n),r);function Jt(t,e){const n=t,r=e,i=n.clientX||n.x,o=n.clientY||n.y,s=r.clientX||r.x,c=r.clientY||r.y;return Math.sqrt(Math.pow(i-s,2)+Math.pow(o-c,2))}class Qt extends n{constructor(t){super(),this._api=t,this.mode="replace",this.touchCount=1,this.mouseButton=0,this._dragObservable=this._api.inputHandler.pointerDown$.pipe(gt(Kt(this.observableOptions)),Ut((t=>this._downCallback(t))),At((()=>this._api.inputHandler.pointerMove$.pipe(Bt(qt(this._api.inputHandler,this.observableOptions))))),Ut((t=>this._moveCallback(t))),At((()=>this._api.inputHandler.pointerUp$)),Ut((t=>this._upCallback(t)))),this._cancelObservable=this._api.inputHandler.keyDown$.pipe(gt((t=>"Escape"===t.code)),Ut((()=>this._cancel()))),this._createSelectionRectangle(),this._startPoint=new e.Vector2,this._pointBottomRight=new e.Vector2,this._pointTopLeft=new e.Vector2}static get Name(){return"areaSelection"}get name(){return Qt.Name}startAreaSelection(t){this._downCallback(t),this._dragHandle&&this._dragHandle.unsubscribe(),this._dragHandle=this._api.inputHandler.pointerMove$.pipe(Ut((t=>this._moveCallback(t))),At((()=>this._api.inputHandler.pointerUp$)),Ut((t=>this._upCallback(t)))).subscribe()}_cancel(){this.enabled=!1,this._removeSelectionRectangle(),this.onFinished()}_createSelectionRectangle(){this._selectionRectangle=document.createElement("div"),this._selectionRectangle.style.pointerEvents="none",this._selectionRectangle.style.zIndex="9999",this._selectionRectangle.style.opacity="0.2",this._selectionRectangle.style.position="fixed"}_downCallback(t){this._startPoint.set(t.x,t.y),this._pointTopLeft.set(t.x,t.y),this._pointBottomRight.set(t.x,t.y),this._addSelectionRectangle(t),this._api.eventDispatcher.dragStart(this)}_addSelectionRectangle(t){this._selectionRectangle.style.left=t.x+"px",this._selectionRectangle.style.top=t.y+"px",this._selectionRectangle.style.width="0px",this._selectionRectangle.style.height="0px",this._selectionRectangle.style.border="1px solid #"+this._api.settingsDispatcher.settings.color.getHexString(),this._api.inputHandler.container.appendChild(this._selectionRectangle)}_moveCallback(t){this._pointBottomRight.x=Math.max(this._startPoint.x,t.x),this._pointBottomRight.y=Math.max(this._startPoint.y,t.y),this._pointTopLeft.x=Math.min(this._startPoint.x,t.x),this._pointTopLeft.y=Math.min(this._startPoint.y,t.y),this._updateSelectionRectangle()}isContainedOnly(){return this._startPoint.x<this._pointBottomRight.x}_updateSelectionRectangle(){this._selectionRectangle.style.left=this._pointTopLeft.x+"px",this._selectionRectangle.style.top=this._pointTopLeft.y+"px",this._selectionRectangle.style.width=this._pointBottomRight.x-this._pointTopLeft.x+"px",this._selectionRectangle.style.height=this._pointBottomRight.y-this._pointTopLeft.y+"px",this._selectionRectangle.style.border=this.isContainedOnly()?"2px solid #"+this._api.settingsDispatcher.settings.color.getHexString():"2px dashed #"+this._api.settingsDispatcher.settings.color.getHexString()}async _upCallback(t){const e=await this._api.inputHandler.picker.getIntersectionFromScreenRect(this._pointTopLeft,this._pointBottomRight,this.isContainedOnly());this._selectFromEvent(t,e),this._cancel(),this._api.eventDispatcher.dragEnd(this)}_removeSelectionRectangle(){this._api.inputHandler.container.contains(this._selectionRectangle)&&this._api.inputHandler.container.removeChild(this._selectionRectangle)}set enabled(t){this._dragHandle&&(this._dragHandle.unsubscribe(),this._dragHandle=null,this._cancelHandle.unsubscribe()),t&&(this._dragHandle=this._dragObservable.subscribe(),this._cancelHandle=this._cancelObservable.subscribe())}get enabled(){return!!this._dragHandle}_selectFromEvent(t,e){const n=t.originalEvent,r=n.shiftKey||n.ctrlKey||n.metaKey?"add":n.altKey?"subtract":this.mode;this._api.selection.change((()=>{"replace"===r&&(this._api.selection.clear(),this.onChange&&this.onChange(void 0,void 0));for(const t of e){const e=t.model;e&&e.isSelectable&&this.applySelection(e,t.childrenIds,r)}}),this)}async applySelection(t,e,n){this.onChange&&(e=await this.onChange(t.name,e)),"subtract"===n?this._api.selection.subtract(t.name,e,this):this._api.selection.add(t.name,e,this)}}class te extends n{constructor(t){super(),this._api=t,this.mode="replace",this._inputs=t.inputHandler,this._selection=t.selection,this._settingsDispatcher=t.settingsDispatcher,this.mouseButton=0,this._tapsObservable=this._inputs.createTapObservable({button:this.mouseButton,touchCount:1}).pipe(ft(Zt(this._inputs.picker))),this._settingsDispatcher.subscribe("hoverHighlightEnabled",(()=>{this.enabled&&(this.enabled=!1,this.enabled=!0)})),this._longTapObservable=this._inputs.createLongTapObservable({button:0,touchCount:1}),this._inputs.keyDown$.subscribe((t=>{"Escape"===t.code&&this.enabled&&this._selection.clear(this)}))}static get Name(){return"selection"}get name(){return te.Name}_startAreaSelection(t){this._api.toolManager.activeTool="areaSelection";this._api.toolManager.tools.get(Qt).startAreaSelection(t)}_onSelectionTap(t){const e=t.intersection,n=t.originalEvent,r=n.shiftKey||n.ctrlKey||n.metaKey?"addSubtract":n.altKey?"subtract":this.mode;if(!e||!e.object)return void("replace"===r&&(this._selection.clear(),this.onChange&&this.onChange(void 0,void 0)));const i=e.model;i&&i.isSelectable&&this.applySelection(i,e,r)}async applySelection(t,e,n){let r=e.childrenIds||[e.id];this.onChange&&(r=await this.onChange(t.name,r));const i=this._selection.get(t.modelId),o=i&&void 0!==i.find((t=>r.includes(t)));"subtract"===(n="addSubtract"===n?o?"subtract":"add":n)?this._selection.subtract(t.name,r,this):"add"===n?this._selection.add(t.name,r,this):this._selection.setOnly(t.name,r,this)}clearHover(){this.lastHoverIntersection&&(this.lastHoverIntersection.model.setHoveredFromEvent(void 0),this.lastHoverIntersection=null)}async _onHover(t){if(t.anyMouseButtonDown||t.touchCount>0)return void this.clearHover();const e=t.intersection;if(!e||!e.model)return void this.clearHover();if(this.onChange&&(e.id=(await this.onChange(e.model.modelId,[e.id]))[0]),this.lastHoverIntersection&&this.lastHoverIntersection.model===e.model&&this.lastHoverIntersection.id===e.id)return;const n=e.model;n.setHoveredFromEvent&&(n.setHoveredFromEvent(t),this.lastHoverIntersection=e)}set enabled(t){this._tapsSubscription&&(this._tapsSubscription.unsubscribe(),this._tapsSubscription=null),this._moveSubscription&&(this._moveSubscription.unsubscribe(),this._moveSubscription=null),this._longClickSubscription&&(this._longClickSubscription.unsubscribe(),this._longClickSubscription=null),t&&(this._settingsDispatcher.settings.hoverHighlightEnabled&&(this._moveSubscription=this._inputs.pointerMove$.pipe(ft(Zt(this._inputs.picker))).subscribe((t=>this._onHover(t)))),this._tapsSubscription=this._tapsObservable.subscribe((t=>this._onSelectionTap(t))),this._longClickSubscription=this._longTapObservable.subscribe((t=>{this._startAreaSelection(t)})))}get enabled(){return!!this._tapsSubscription}}class ee extends n{constructor(t,e,n){super(),this._inputs=t,this._cursor3D=e,this._eventDispatcher=n,this._tapsObservable=this._inputs.createTapObservable(void 0).pipe(ft(this._snapTypes&&0!==this._snapTypes.length?ne(this._cursor3D.intersection):Zt(t.picker)))}static get Name(){return"picking"}get name(){return ee.Name}get allowedSnapTypes(){return[2,1,0]}set snapTypes(t){this._snapTypes=t,this._isCursor3DSubscribed&&(this._cursor3D.unsubscribe(),this._isCursor3DSubscribed=!1),this._snapTypes&&0!==this._snapTypes.length&&(this._cursor3D.snapTypes=this._snapTypes,this._cursor3D.subscribe(),this._isCursor3DSubscribed=!0)}get snapTypes(){return this._snapTypes}get enabled(){return!!this._tapsSubscription}set enabled(t){this._tapsSubscription&&(this._tapsSubscription.unsubscribe(),this._tapsSubscription=null),this._isCursor3DSubscribed&&(this._cursor3D.unsubscribe(),this._isCursor3DSubscribed=!1),t&&(this._tapsSubscription=this._tapsObservable.subscribe((t=>{this._onPickTap(t)})))}_onPickTap(t){const n={screenPosition:new e.Vector2(t.x,t.y),worldPosition:t.intersection?t.intersection.point:null,mouseButton:t.mouseButton,touchCount:t.touchCount};t.intersection&&t.intersection.model&&(n.modelId=t.intersection.model.name,n.id=t.intersection.id,n.childrenIds=t.intersection.childrenIds,n.face=t.intersection.face,n.normal=t.intersection.normal),this._eventDispatcher.picked(n)}}const ne=t=>async e=>(e.intersection=t,e);t.AreaSelectionTool=Qt,t.AsyncAction=L,t.AsyncScheduler=Y,t.Caster=r,t.DirectionToSpherical=function(t,n){let r;return r=Math.abs(t.x)<.002&&Math.abs(t.y)<.002?t.z>0?Math.PI+i(n):i(n):Math.atan2(t.y,t.x),new e.Vector2(Math.acos(t.z),r)},t.InputHandler=class{constructor(t,e){this.picker=t,this.container=e;const n={passive:!1};let r;const i=t=>{const e=performance.now();return"undefined"!=typeof TouchEvent&&t instanceof TouchEvent&&(r=e),!("undefined"!=typeof MouseEvent&&t instanceof MouseEvent)||(void 0===r||e-r>1e3)};this._pointerDownObserver=wt(vt(e,"mousedown",n),vt(e,"touchstart",n)).pipe(gt(i),Ut((t=>{t.cancelable&&t.preventDefault()})),tt((t=>this.convertEventToPointerInput(t)))),this._moveObserver=wt(vt(window,"mousemove",n),vt(e,"touchmove",n)).pipe(gt(i),tt((t=>this.convertEventToPointerInput(t))),Vt()),this._moveObserver.connect(),this._pointerUpObserver=wt(vt(e,"mouseup",n),vt(e,"touchend",n)).pipe(gt(i),tt((t=>this.convertEventToPointerInput(t)))),this.pointerDown$=this._pointerDownObserver.pipe(Vt()),this.pointerDown$.connect(),this.pointerMove$=this._moveObserver.pipe(Vt()),this.pointerMove$.connect(),this.pointerUp$=this._pointerUpObserver.pipe(Vt()),this.pointerUp$.connect(),this.wheel$=vt(e,"wheel",n).pipe(tt((t=>this.fromWheelToScrollEvent(t))),Vt()),this.wheel$.connect(),this.gesture$=wt(vt(e,"gesturestart",n),vt(e,"gesturechange",n),vt(e,"gestureend",n)).pipe(tt((t=>this.fromGestureToScrollEvent(t))),Vt()),this.gesture$.connect(),this.zoom$="TouchEvent"in window?this.wheel$:wt(this.wheel$,this.gesture$);const o=t=>{const e=t,n=e.composedPath()[0];return!e.repeat&&(!n||!n.tagName||"text-element"!==n.tagName.toLowerCase()&&"input"!==n.tagName.toLowerCase()&&"textarea"!==n.tagName.toLowerCase())};this.keyDown$=vt(window,"keydown",n).pipe(gt(o),Vt()),this.keyDown$.connect(),this.keyUp$=vt(window,"keyup",n).pipe(gt(o),Vt()),this.keyUp$.connect(),this.contextMenu$=vt(e,"contextmenu",n),this.contextMenu$.subscribe((t=>{t.preventDefault()}))}clampScrollSpeed(t){return t=0===t?0:t>0?Math.max(t,.3):Math.min(t,-.3),Math.min(Math.max(t,-2),2)}fromWheelToScrollEvent(t){t.preventDefault();const e=t.deltaY+t.deltaX,n=t.ctrlKey?e/25:t.deltaMode===WheelEvent.DOM_DELTA_PIXEL?e/100:t.deltaMode===WheelEvent.DOM_DELTA_LINE?e/3:t.deltaMode===WheelEvent.DOM_DELTA_PAGE?80*e:0;return{speed:this.clampScrollSpeed(n),x:t.x,y:t.y,screenX:t.screenX,screenY:t.screenY,originalEvent:t}}fromGestureToScrollEvent(t){t.preventDefault();return{speed:1-t.scale,x:t.clientX,y:t.clientY,screenX:t.clientX,screenY:t.clientY,originalEvent:t}}set cursor(t){this._cursor=this._cursor||"default",""===t?(this.container.classList.remove(this._cursor),this.container.classList.add("default"),this._cursor="default"):t!==this._cursor&&(this.container.classList.remove(this._cursor),this.container.classList.add(t),this._cursor=t)}get cursor(){return this._cursor=this._cursor||"default",this._cursor}convertEventToPointerInput(t){const e={x:0,y:0,screenX:0,screenY:0,originalEvent:t,isTouch:"undefined"!=typeof TouchEvent&&t instanceof TouchEvent};if("undefined"!=typeof TouchEvent&&t instanceof TouchEvent){const n=o(t);e.x=n.x,e.y=n.y,e.screenX=n.x,e.screenY=n.y,e.touchCount=t.touches.length}else"undefined"!=typeof MouseEvent&&t instanceof MouseEvent&&(e.x=t.x,e.y=t.y,e.screenX=t.screenX,e.screenY=t.screenY,e.mouseButton=t.button,e.anyMouseButtonDown=0!==t.buttons);return e}createTapObservable(t){return this.pointerDown$.pipe(gt(Kt(t)),At((e=>this.pointerUp$.pipe(gt(Kt(t?{button:t.button,touchCount:0}:void 0)),Bt(this.pointerMove$.pipe(Nt(150))),gt((t=>Jt(e,t)<12)),tt((()=>e))))))}createSnappedTapObservable(t,e){return this.createTapObservable(e).pipe(ft((async e=>(e.isTouch&&await t.calculateIntersection(e,!0),e.intersection=t.intersection,e))),gt(Gt))}createDoubleTapObservable(t){const e=this.pointerDown$.pipe(gt(Kt(t)));return e.pipe((n=e.pipe(Mt(250)),function(t){return t.lift(new Tt(n))}),gt((t=>2===t.length)),tt((t=>t[0])),gt(Kt(t)));var n}createDragObservable(t,e,n,r){let i;return this.pointerDown$.pipe(gt((e=>Wt(e,t))),ft((async t=>(i=performance.now(),await e(t)))),ft((e=>this.pointerMove$.pipe(Bt(qt(this,t).pipe(Ut(r))),gt((t=>Jt(e,t)>=12||performance.now()-i>150)),Ut(n)))))}createLongTapObservable(t){return this.pointerDown$.pipe(gt((e=>Wt(e,t))),At((t=>function(t,e,n){void 0===t&&(t=0);var r=-1;return mt(e)?r=Number(e)<1?1:Number(e):z(e)&&(n=e),z(n)||(n=J),new O((function(e){var i=mt(t)?t:+t-n.now();return n.schedule(Et,i,{index:0,period:r,subscriber:e})}))}(1e3).pipe(Bt(wt(this.pointerUp$,this.pointerMove$)),tt((()=>t))))))}},t.MILLIMETERS_IN_FOOT=304.8,t.MILLIMETERS_IN_INCH=25.4,t.ObjectUnsubscribedError=D,t.Observable=O,t.PickingTool=ee,t.SelectionTool=te,t.SinglePointerTool=n,t.SphericalToDirection=function(t,e){return e.set(Math.sin(t.x)*Math.cos(t.y),Math.sin(t.x)*Math.sin(t.y),Math.cos(t.x)).normalize()},t.Subject=H,t.Subscriber=S,t.__extends=l,t.addIntersectionForNavigation=t=>async n=>(n.intersection=await t.pickForNavigation(new e.Vector2(n.x,n.y)),n),t.async=J,t.calculateSphericalYAngle=i,t.closestPointBetweenRays=function(t,n){const r=(new e.Vector3).subVectors(t.origin,n.origin),i=-t.direction.dot(n.direction),o=r.dot(t.direction);r.length();const s=Math.abs(1-i*i);let c;if(s>=0){c=(i*-r.dot(n.direction)-o)*(1/s)}else c=-o;return(new e.Vector3).copy(t.origin).add(t.direction.multiplyScalar(c))},t.copyToVector3=function(t,e){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.createArrowGeometry=function(t){const n=new e.ConeGeometry(t/3,t,10);return n.applyMatrix4((new e.Matrix4).makeRotationFromEuler(new e.Euler(-Math.PI/2,0,0)).setPosition(0,0,t/2)),n},t.createGeometryAttribute=function(t,n,r,i,o){let s,c="index"===n?t.getIndex():t.getAttribute(n);return c&&c.array.length>=r*i&&c.array.length<r*i*2?(c.count=r,c.updateRange.count=r*i,c.needsUpdate=!0):(s=new o(r*i),c=new e.BufferAttribute(s,i),"index"===n?t.setIndex(c):t.setAttribute(n,c)),c},t.createScreenStaticSizeMesh=function(t,n,r,i){const o=new e.Mesh(t,n);return a(o,r,i),o},t.debounceTime=Mt,t.distanceFormatter=(t,e)=>n=>c(1e3*n,t,e),t.empty=U,t.filter=gt,t.formatLength=c,t.from=at,t.getBoxCorners=function(t){const n=t.min.x===1/0?new e.Vector3(-50,-50,-50):t.min,r=t.max.x===-1/0?new e.Vector3(50,50,50):t.max,i=[];return i.push(new e.Vector3(r.x,r.y,r.z)),i.push(new e.Vector3(n.x,r.y,r.z)),i.push(new e.Vector3(n.x,n.y,r.z)),i.push(new e.Vector3(r.x,n.y,r.z)),i.push(new e.Vector3(r.x,r.y,n.z)),i.push(new e.Vector3(n.x,r.y,n.z)),i.push(new e.Vector3(n.x,n.y,n.z)),i.push(new e.Vector3(r.x,n.y,n.z)),i},t.getFileBuffer=function(t){return new Promise(((e,n)=>{const r=new FileReader;r.onload=t=>{const n=t.target;e(n.result)},r.onerror=t=>(console.error(t),n(t)),r.readAsArrayBuffer(t)}))},t.getRayIntersection=function(t,n,i){const o=new e.Vector3,s=new r;o.set(t/window.innerWidth*2-1,-n/window.innerHeight*2+1,.5),o.unproject(i);const c=o.sub(i.position).normalize();return s.set(i.position,c),{id:null,object:null,model:null,caster:s}},t.getScreenDistance=Jt,t.getTouchPoint=o,t.isNumeric=mt,t.lengthUnits=s,t.makeScreenStaticSize=a,t.map=tt,t.merge=wt,t.mergeAll=yt,t.mergeMap=ft,t.of=q,t.positionFormatter=(t,e)=>`X ${e(t.x)} | Y ${e(t.y)} | Z ${e(t.z)}`,t.rayToWorldPosition=function(t,e,n){const r=t.direction,i=e.position.distanceTo(n);return e.position.clone().add(r.multiplyScalar(i))},t.takeUntil=Bt,t.tap=Ut,t.toImage=async function(t){if("undefined"==typeof createImageBitmap)return new Promise((async(e,n)=>{const r=new Image;r.src=URL.createObjectURL(t),r.onload=()=>e(r),r.onerror=()=>n("Image did not load")}));try{return await createImageBitmap(t,{imageOrientation:"flipY"})}catch(e){return await createImageBitmap(t)}}}));
//# sourceMappingURL=4efec337.mjs.map
